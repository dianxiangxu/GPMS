/*!CK:3249177143!*//*1437535033,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["87tQA"]); }

__d("TickerStoryList",["Event","Animation","Arbiter","AsyncRequest","AsyncSignal","Bootloader","ChannelConstants","LegacyContextualDialog","CSS","DOM","HTML","Keys","LayerFadeOnHide","LiveTimer","NavigationMessage","Parent","Rect","Run","ScrollableArea","SelectorDeprecated","Style","TickerController","TickerReadStateTracking","Toggler","URI","UserActivity","UserAgent_DEPRECATED","Vector","DOMVector","BanzaiODS","clickRefAction","collectDataAttributes","containsNode","cx","csx","ex","emptyFunction","ge","getElementText","goURI","throttle","tickerPhoteSnowLiftOpenStatus"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va){b.__markCompiled&&b.__markCompiled();var wa=15000,xa={};function ya(za,ab,bb){xa[za.id]=this;ba.setActiveInstance(this);this._root=za;this._content=p.find(za,'.ticker_stream');this._stories=p.find(this._root,'.tickerActivityStories');this._scrollableArea=ab;this._container=p.find(za,'div.uiScrollableAreaWrap');this._newestStory={};this._objectIDs=[];this._fetchedStories={};this._fetchedStoriesDialog={};this._storyDialogResources={};this._removedStoryIDs=[];this._storiesToRemove=[];var cb=Date.now();this._initTime=cb;this._lastUpdate=cb;this._lastPull=cb;this._lastInsert=cb;this._pollOnly=false;this._autoloadStoryIndex=1;this._scrollTopThreshold=100;this._scrollTopPrompt=p.find(this._root,'.scrollTopPrompt');this._scrollTopPromptVisible=false;this._maxStoriesToKeep=50;this._minStoriesToKeep=25;this._tickerInSidebarMode=!!v.byClass(this._root,'fbChatSidebar');this._loadStoriesWithActions();ka('ticker_flyout');ka('ticker_flyout_prefetch');ka('ticker_flyout_loadtime');ka('ticker_stream');this._uaCurStoryIDFetch=null;this._uaCurStoryIDPrefetch=null;var db=p.create('div',{className:'storyQueue hidden_elem'});this._storyQueue=db;p.appendContent(this._root,db);this._lastKStories={head:null,tail:null,count:0,actors:{},apps:{},stories:{}};this._dedupeKeys={};this._initObjectIDs();this._initConfig(bb);this._resetMorePager();this._initListeners();this._initSubscriptions(bb);i.inform('ticker/init',this,i.BEHAVIOR_PERSISTENT);this._poll();}Object.assign(ya,{instances:function(){return xa;}});Object.assign(ya.prototype,{ADS_IDLE_MS:300000,FLYOUT_MAX_HEIGHT:450,FLYOUT_OFFSET_THRESHOLD:20,FLYOUT_COMMENT_OFFSET:15,FLYOUT_VIEWPORT_PADDING:75,FLYOUT_ACTION_FOOTER_PADDING:8,FLYOUT_TARGET_HEIGHT_OFFSET:25,DEFAULT_LOOK_BEHIND:10,init:function(za,ab,bb){new ya(za,ab,bb);},_lastKStoriesInsert:function(za){this._lastKStories.stories[za.getAttribute("data-story-key")]=true;var ab={story:za,next:null};if(this._lastKStories.head)this._lastKStories.head.next=ab;this._lastKStories.head=ab;this._lastKStories.count++;if(!this._lastKStories.tail)this._lastKStories.tail=this._lastKStories.head;var bb=za.getAttribute("data-actor");if(!this._lastKStories.actors[bb])this._lastKStories.actors[bb]=0;this._lastKStories.actors[bb]++;var cb=za.getAttribute("data-app");if(cb){if(!this._lastKStories.apps[cb])this._lastKStories.apps[cb]=0;this._lastKStories.apps[cb]++;}if(this._lastKStories.count>this.DEFAULT_LOOK_BEHIND){while(this._lastKStories.tail&&!this._lastKStoriesRemove(this._lastKStories.tail.story))this._lastKStories.tail=this._lastKStories.tail.next;if(!this._lastKStories.tail)this._lastKStories.head=null;}},_lastKStoriesRemove:function(za){var ab=za.getAttribute("data-story-key"),bb=za.getAttribute("data-actor"),cb=za.getAttribute("data-app");if(this._lastKStories.stories[ab]){delete this._lastKStories.stories[ab];this._lastKStories.actors[bb]--;if(cb)this._lastKStories.apps[cb]--;this._lastKStories.count--;return true;}else return false;},_loadStoriesWithActions:function(){var za=ra('rightCol');if(!za)return;this._toggleWrapper=p.scry(za,'.tickerToggleWrapper')[0];if(this._toggleWrapper){var ab=p.scry(this._stories,'.tickerStoryWithButton');this._storiesWithActions={};for(var bb=0;bb<ab.length;bb++){var cb=ab[bb];this._storiesWithActions[cb.getAttribute('data-story-key')]=cb;}}},_initConfig:function(za){Object.assign(this,{_newest:za.newest,_page_newest:za.newest,_timeout:za.timeout,_heartbeatTimeout:Math.min(5000,za.heartbeatTimeout),_maxHeartbeatTimeout:Math.max(30000,za.maxHeartbeatTimeout),_pullTimeout:Math.max(30000,za.pullTimeout),_insertTimeout:za.insertTimeout,_maxQueueLength:za.maxQueueLength,_heartbeatEndpoint:za.heartbeatEndpoint,_popupOnHover:za.popupOnHover,_userIdleTimeout:za.userIdleTimeout,_pollOnly:za.pollOnly,_tickerSource:za.tickerSource,_logFlyouts:za.logFlyouts,_userScrollGaurdDelay:za.userScrollGaurdDelay,_rescheduleScrollToTopDelay:za.rescheduleScrollToTopDelay});},_initListeners:function(){this._listeners=g.listen(this._root,{click:this._handleClick.bind(this),keydown:this._handleKeydown.bind(this),mouseout:this._handleMouseout.bind(this),mouseover:this._handleMouseover.bind(this),mousedown:this._tickerDeClicker.bind(this),mouseup:this._handleMouseup.bind(this)});this._listeners.scroll=g.listen(this._container,'scroll',this._handleScroll.bind(this));setTimeout(this._initInfiniteScrollListener.bind(this),0);},_initSubscriptions:function(za){x.onLeave(this._cleanup.bind(this));this._subscriptions=[i.subscribe(u.NAVIGATION_BEGIN,this._onNavHandler.bind(this)),i.subscribe('composer/publish',this._handleComposerPublish.bind(this)),i.subscribe('Ticker/storiesInserted',this._handleStoriesInserted.bind(this)),i.subscribe('Ticker/fixed',this._setFixed.bind(this,true)),i.subscribe('Ticker/unfixed',this._setFixed.bind(this,false)),i.subscribe('Ticker/resized',this._checkInfiniteScroll.bind(this)),i.subscribe('ufi/comment',this._scrollDialogToBottom.bind(this)),i.subscribe('ufi/changed',this._redrawFlyout.bind(this)),i.subscribe('Ticker/chatOpened',this._handleChatOpened.bind(this))];if(!za.pollOnly)this._subscriptions.push(i.subscribe(m.getArbiterType('ticker_update'),this._handleTickerPush.bind(this)));if(za.pushChannel&&!za.pollOnly)this.setPushChannel(za.pushChannel);},_handleClick:function(event){if(!(event.button===1||event.altKey||event.ctrlKey||event.metaKey))event.prevent();var za=event.getTarget();if(this._getButtonFromNode(za)){this._logUserAction(za,'click',event);this._handleActionButton(event);return;}var ab=this._getStoryFromNode(za),bb=v.byClass(za,'tickerStoryAllowClick');if(!ab||ab==this._selectedStory||bb)return;if(this._storyIsHidden(ab))return;if(ab==this._activeStory&&!this._selectedStory)this._selecting=true;if(this._storyCanOpenExternally(ab)){var cb=ab.getAttribute('data-href');if(cb&&!za.getAttribute('href')){var db={href:cb},eb=la(za,['ft','gt']);ka('click',db,event,'FORCE',eb);}else this._logUserAction(za,'click',event);this._openStoryExternally(ab,event);return;}this._logUserAction(za,'flyout',event);this._activateStory(ab,'click');this._selectStory(ab);},_handleMouseover:function(event){this._setLocked(true);var za=event.getTarget(),ab=this._getOpenableStory(za);if(!ab){var bb=v.byClass(za,"_5wvy");if(bb){clearTimeout(parseInt(bb.getAttribute('data-timeout-token'),10));var cb=setTimeout(function(){ya.removeMarkup(bb,ab);},wa);bb.setAttribute('data-timeout-token',cb);}return;}event.kill();if(this._popupOnHover){if(!(ab.id in this._fetchedStories))this._uaCurStoryIDPrefetch=ab.id;this._fetchStory(ab);}if(this._selectedStory)return;if(this._popupOnHover){this._clearHoverTimeouts();var db=this._storyCanOpenExternally(ab)?500:1000,eb=this._activeStory?75:db;this._hoverShowTimeout=this._setTimeout(function(){this._activateStory(ab,'hover');this._logUserAction(za,'flyout',event);}.bind(this),eb);}},_handleMouseout:function(event){var za=event.getTarget();this._setLocked(false);if(za==this._getStoryFromNode(za)){var ab=p.scry(za.parentNode,'.openToggler');for(var bb=0;bb<ab.length;bb++)z.toggle(ab[bb]);}this._clearClickedStory();this._scheduleHide();},_handleKeydown:function(event){this._tickerDeClicker(event);var za=this._activeStory;if(!za)return;var ab=g.getKeyCode(event);switch(ab){case r.UP:case r.DOWN:var bb=this._getInsertedStories(),cb;if(event.getModifiers().any){cb=ab===r.UP?0:bb.length-1;}else cb=bb.indexOf(za)+(ab===r.UP?-1:1);za=bb[cb];break;case r.ESC:this._deactivateStory(true);return;default:return;}event.kill();if(!za)return;this._activateStory(za,'keypress');this._selectStory(za);},_fadeTopmostStoryButton:function(){var za=0,ab=15;if(this._storiesWithActions)for(var bb in this._storiesWithActions){var cb=this._storiesWithActions[bb],db=p.scry(cb,'.tickerInlineActionButton')[0],eb=p.scry(db,'.tickerActionIcon')[0],fb=ha.getElementPosition(db).y-ha.getElementPosition(this._toggleWrapper).y;if(fb<za){aa.set(db,'opacity',0);aa.set(eb,'opacity',0);}else if(fb>=za&&fb<ab){var gb=(fb-za)/(ab-za);aa.set(db,'opacity',gb);aa.set(eb,'opacity',gb);break;}else{aa.set(db,'opacity',1);aa.set(eb,'opacity',1);}}},_handleScroll:function(){var za=va.checkIsOpen();if(za)this._preventFlyoutDismiss=true;if(!this._preventScrollDismiss&&!za){if(!this._preventFlyoutDismiss){this._deactivateStory(true);}else this._preventFlyoutDismiss=false;}else this._preventScrollDismiss=false;if(!this._handleScrollThrottled)this._handleScrollThrottled=ua(this._handleScrollInner.bind(this));this._handleScrollThrottled();},_handleScrollInner:function(){this._fadeTopmostStoryButton();this._checkInfiniteScroll();this._setIsUserScrolling();if(!this._scrollLogged){this._scrollLogged=true;var za=this._stories.childNodes.length,ab=this._stories.getAttribute('data-gt'),bb={ticker_scroll:1,number_stories:za,source:ab};ka('scroll',null,null,'FORCE',{gt:bb});}},_setIsUserScrolling:function(){clearTimeout(this._userScrollingToken);if(this._isScrolledToTop()){this._userScrolling=false;return;}this._userScrolling=true;this._userScrollingToken=setTimeout(function(){this._userScrolling=false;this._userScrollingToken=null;}.bind(this),this._userScrollGaurdDelay);},_isUserScrolling:function(){return this._userScrolling;},_handleStoriesInserted:function(){this._initInfiniteScrollListener();if(this._scrollableArea instanceof y)this._scrollableArea.adjustGripper();},_handleActionButton:function(event){var za=event.getTarget(),ab=this._getOpenableStory(za),bb=this._getStoryDialog(ab);if(bb)var cb=bb.subscribe('beforehide',function(){bb.unsubscribe(cb);return false;});},_handleScrollToTopClick:function(){this._scrollToTop(this._poll.bind(this));},_scheduleScrollToTop:function(){this._scrollToTopToken&&clearTimeout(this._scrollToTopToken);this._scrollToTopToken=setTimeout(function(){if(this._isLocked()||this._isUserScrolling()){this._scheduleScrollToTop();}else{this._scrollToTopToken=null;this._scrollToTop();}}.bind(this),this._rescheduleScrollToTopDelay);},_scrollToTop:function(za){new h(this._container).to('scrollTop',0).ease(h.ease.end).ondone(za).go();},_clearHoverTimeouts:function(){clearTimeout(this._hoverShowTimeout);clearTimeout(this._hoverHideTimeout);},_getAllStories:function(){return p.scry(this._root,'div.fbFeedTickerStory');},_findStoryById:function(za){var ab=p.scry(this._root,'.fbFeedTickerStory'),bb;for(story in ab){bb=ab[story];if(za==this._getStoryDialogParams(bb).token)return bb;}return null;},_getInsertedStories:function(){return this._getAllStories().filter(function(za){return !o.hasClass(za,'queuedStory');});},_getQueuedStories:function(){return p.scry(this._storyQueue,'.fbFeedTickerStory.queuedStory');},_getButtonFromNode:function(za){return v.byClass(za,'tickerInlineOverlay');},_getStoryFromNode:function(za){return v.byClass(za,'fbFeedTickerStory');},_getActionButtonFromStory:function(za){return p.scry(za,'.tickerInlineActionButton')[0];},_getOpenableStory:function(za){var ab=this._getStoryFromNode(za);return this._storyCanOpenDialog(ab)?ab:null;},_getStoryDialog:function(za){return this._fetchedStoriesDialog[za.id]||n.getInstance(za);},_getStoryDialogParams:function(za){var ab=za&&za.getAttribute('data-flyoutdata')||null;return ab&&JSON.parse(ab)||null;},_storyCanOpenDialog:function(za){return !!this._getStoryDialogParams(za)&&!this._storyIsHidden(za);},_storyCanOpenExternally:function(za){return !!za.getAttribute('data-href')||!this._storyCanOpenDialog(za);},_storyIsHidden:function(za){return o.hasClass(za,'tickerStoryHidden');},hideActiveStory:function(){this._activeStory&&this.hideStory(this._activeStory);},hideStory:function(za){this._deactivateStory();if(sa(za)==='')p.remove(za);o.addClass(za,'tickerStoryHidden');o.removeClass(za,'tickerStoryClickable');},undoHideStory:function(za){o.addClass(za,'tickerStoryClickable');o.removeClass(za,'tickerStoryHidden');},insertStoriesAtBottom:function(za){if(!za)return;var ab=p.create('div');ab.appendChild(za);var bb=p.scry(ab,'.fbFeedTickerStory'),cb=p.find(ab,'.tickerMorePager'),db=[];for(var eb=0;eb<bb.length;eb++)if(!this.dedupeStory(bb[eb]))db.push(bb[eb]);if(db.length){db.push(cb);p.replace(p.find(this._root,'.tickerMorePager'),db);}i.inform('Ticker/storiesInserted');},_scheduleHide:function(){if(this._popupOnHover&&!this._selectedStory){this._clearHoverTimeouts();this._hoverHideTimeout=this._setTimeout(this._deactivateStory.bind(this),100);}},_setScrollTopPromptVisible:function(za){this._scrollTopPromptVisible=za;o.conditionShow(this._scrollTopPrompt,za);if(za&&!this._listeners.scrollTop){this._listeners.scrollTop=g.listen(this._scrollTopPrompt,{click:this._handleScrollToTopClick.bind(this)});}else if(!za&&this._listeners.scrollTop){this._listeners.scrollTop.click.remove();this._listeners.scrollTop=null;}},_isUserIdle:function(){return !fa.isActive(this._userIdleTimeout);},_schedulePoll:function(){clearTimeout(this._pollToken);this._pollToken=this._setTimeout(this._poll.bind(this),this._timeout);},_poll:function(){if(!this._isTickerVisible())return;if(this._storiesToRemove.length>0){if(this._isInsertingStory)return this._schedulePoll();var za=this._storiesToRemove.pop();this.removeStory(za);}var ab=!this._isScrolledToTop()&&this._getQueuedStories().length;this._setScrollTopPromptVisible(ab);var bb=Date.now(),cb=bb-this._lastInsert;if(cb<this._insertTimeout||this._isLocked())return this._schedulePoll();var db=this._getQueuedStories(),eb=this._isUserIdle(),fb=db.length>0;if(fb){var gb=db.shift();this.insertStory(gb);return this._schedulePoll();}if(eb)return fa.subscribeOnce(this._poll.bind(this));var hb=false,ib=false;if(this._pollOnly){ib=bb-this._lastUpdate>this._heartbeatTimeout;}else hb=(bb-this._lastPull>this._pullTimeout);var jb=hb||ib;if(!jb)return this._schedulePoll();this.update({pull:hb,fullpoll:ib});},_updatePollOnlyHeartbeatTimeout:function(){if(this._pollOnly&&this._heartbeatTimeout<this._maxHeartbeatTimeout)this._heartbeatTimeout=Math.min(this._heartbeatTimeout+5000,this._maxHeartbeatTimeout);},update:function(za){this._updatePollOnlyHeartbeatTimeout();if(!this._pollOnly)return this._schedulePoll();var ab={newest:(za.fullpoll||za.cache_update)?this._newest:this._page_newest,source:this._tickerSource};if(!ab.newest||ab.newest==='0')throw new Error(pa('Trying to request new ticker stories with an invalid cursor %s, with'+' the settings fullpoll %s, cache_update %s, value coming from this.%s',typeof ab.newest==='string'?'"'+ab.newest+'"':ab.newest,za.fullpoll,za.cache_update,(za.fullpoll||za.cache_update)?'_newest':'_page_newest'));Object.assign(ab,za);new j().setURI(this._heartbeatEndpoint).setReadOnly(true).setOption('retries',0).setData(ab).setHandler(this._handleResponse.bind(this)).setFinallyHandler(this._poll.bind(this)).setAllowCrossPageTransition(true).send();this._lastUpdate=Date.now();if(ab.pull)this._lastPull=this._lastUpdate;},insertStory:function(za){this._lastInsert=Date.now();window.LiveTimer&&t.addTimeStamps(za);o.removeClass(za,'queuedStory');if(this._isUserScrolling()){this._fadeStoryIn(za);}else this._scrollToTop(this._flyStoryIn.bind(this,za));if(this._storiesWithActions&&o.hasClass(za,'tickerStoryWithButton'))this._storiesWithActions[za.getAttribute('data-story-key')]=za;this._removeOldStories();},_removeOldStories:function(){var za=this._getInsertedStories();if(za.length<=this._maxStoriesToKeep)return;var ab=this._minStoriesToKeep,bb=za.slice(ab);bb.forEach(p.remove);if(this._storiesWithActions)for(var cb=0;cb<bb.length;cb++)delete this._storiesWithActions[bb[cb].getAttribute('data-story-key')];this._resetMorePager();},_resetMorePager:function(){var za=this._getInsertedStories();if(!za||!za.length)return;var ab=za[za.length-1].getAttribute('data-ticker-timestamp'),bb=p.scry(this._root,'.tickerMorePager a')[0];if(!bb||!ab)return;var cb=new ea(bb.getAttribute('ajaxify'));cb.addQueryData({oldest:ab});bb.setAttribute('ajaxify',cb);},_setLocked:function(za){this._locked=za;},_isLocked:function(){return !!(this._locked||this._activeStory);},informAndRemoveStory:function(za,ab,bb){var cb=this._getStoryFromNode(za),db=cb.getAttribute('data-story-key');p.setContent(cb,ab);o.addClass(cb,'highlightedStory');this._setTimeout(this.removeStory.bind(this,db),bb||6000);},_getStoryByStoryKey:function(za){var ab=this._getAllStories();for(var bb=0;bb<ab.length;bb++){var cb=ab[bb];if(cb.getAttribute('data-story-key')==za)return cb;}return null;},removeStory:function(za){this._removedStoryIDs[za]=true;var ab=this._getStoryByStoryKey(za);if(!ab)return;if(this._storiesWithActions)delete this._storiesWithActions[za];if(ab==this._activeStory)this._deactivateStory();var bb=this._getStoryDialog(ab);bb&&bb.destroy();this._lastKStoriesRemove(ab);var cb=ab.getAttribute("data-dedupe-key");if(cb)delete this._dedupeKeys[cb];if(o.hasClass(ab,'queuedStory')){p.remove(ab);return;}this._animateStoryOut(ab);},_isScrolledToTop:function(){return this._container.scrollTop<=this._scrollTopThreshold;},_flyStoryIn:function(za){var ab=p.create('div',{style:{marginTop:'-1000px'}},za);aa.set(ab,'opacity',0);p.prependContent(this._stories,ab);var bb=ha.getElementDimensions(ab).y;aa.set(ab,'marginTop','-'+bb+'px');this._isInsertingStory=true;new h(ab).to('marginTop',0).ease(h.ease.end).checkpoint(.5).to('opacity',1).ondone(function(){p.replace(ab,za);this._afterInsert(za);this._isInsertingStory=false;}.bind(this)).go();},_fadeStoryIn:function(za){new h(this._stories).to('opacity',.5).ondone(function(){p.prependContent(this._stories,za);this._container.scrollTop=this._container.scrollTop+this._stories.firstChild.offsetHeight;this._scheduleScrollToTop();new h(this._stories).to('opacity',1).ondone(function(){this._afterInsert(za);}.bind(this)).go();}.bind(this)).go();},_animateStoryOut:function(za){var ab=p.create('div',{style:{overflow:'hidden',position:'relative'}});p.insertBefore(za,ab);p.appendContent(ab,za);new h(ab).to('top',20).to('height',0).to('opacity',0).ease(h.ease.end).ondone(function(){p.remove(ab);i.inform('Ticker/animateOut');}.bind(this)).go();},_afterInsert:function(za){i.inform('Ticker/afterInsert');},setPushChannel:function(za){this._pushSubscription&&this._pushSubscription.unsubscribe();this._pushSubscription=i.subscribe(m.getArbiterType(za),this._handleTickerPush.bind(this));d(['ChatConfig','ChannelConnection'],function(ab,bb){this._channelConnection=bb;this._checkChannelConnection();this._channelConnectionSubscription=this._channelConnection.subscribe([this._channelConnection.CONNECTED,this._channelConnection.RECONNECTING,this._channelConnection.SHUTDOWN,this._channelConnection.MUTE_WARNING,this._channelConnection.UNMUTE_WARNING],this._handleChannelConnection.bind(this));}.bind(this));},_checkChannelConnection:function(){o.conditionClass(this._root,'disconnected',this._channelConnection.disconnected());},_handleTickerPush:function(za,ab){var bb=ab.obj;if(bb.delete_id){this._storiesToRemove.push(bb.delete_id);return;}var cb=bb.story_xhp;if(!cb)return;var db=q(cb).getRootNode();if(!bb.story_time||bb.story_time==='0')throw new Error(pa('An invalid story time was pushed: %s, for ticker story: %s',typeof bb.story_time==='string'?'"'+bb.story_time+'"':bb.story_time,db.getAttribute('data-flyoutdata')));this._newest=bb.story_time;this.queueStory(db,bb.flyout_js_cmds);this._newestStory={actorID:bb.actor,storyKey:db.getAttribute('data-story-key')};},_handleComposerPublish:function(za,ab){ab.tickerMarkup&&this.insertStory(ab.tickerMarkup);},_logRender:function(){if(this._loggedRender)return;var za=this._tickerInSidebarMode;if(za||v.byClass(this._content,'home_right_column')){new k('/ajax/log_ticker_render.php',{sidebar_mode:za}).send();this._loggedRender=true;}},_isTickerVisible:function(){var za=(ba.getActiveInstance()==this);za&&this._logRender();return za;},_handleResponse:function(za){var ab=za.getPayload();if(ab.newest)this._newest=this._page_newest=ab.newest;if(ab.content)if(ab.content instanceof Array){for(var bb=0;bb<ab.content.length;bb++)this.queueStoryMarkup(ab.content[bb]);}else this.queueStoryMarkup(ab.content);},queueStoryMarkup:function(za){var ab=q(za).getRootNode();this.queueStory(ab);},dedupeStory:function(za){var ab=za.getAttribute('data-story-key'),bb=ab&&(!!this._objectIDs[ab]||!!this._removedStoryIDs[ab]);bb=bb||!!this._lastKStories.actors[za.getAttribute('data-actor')]||!!this._lastKStories.apps[za.getAttribute('data-app')];var cb=za.getAttribute('data-dedupe-key');bb=bb||cb&&this._dedupeKeys[cb];if(za.getAttribute('data-force-push'))bb=false;ab&&(this._objectIDs[ab]=true);return bb;},queueStory:function(za,ab){if(this.dedupeStory(za))return;this._lastKStoriesInsert(za);var bb=za.getAttribute("data-dedupe-key");if(bb)this._dedupeKeys[bb]=true;o.addClass(za,'queuedStory');p.appendContent(this._storyQueue,za);var cb=ab&&ab.length;if(cb)ab.forEach(function(eb){new Function(eb).apply();});za.setAttribute('id',za.id+'_'+this._root.id);var db=this._getQueuedStories();db.slice(0,-this._maxQueueLength).forEach(p.remove);if(cb)this._fetchedStories[za.id]=true;},_cleanup:function(){ba.clearRHCplaceholder();if(!v.byClass(this._content,'hasRightCol'))return;this._objectIDs=[];this._subscriptions.forEach(i.unsubscribe);this._channelConnectionSubscription&&this._channelConnection.unsubscribe(this._channelConnectionSubscription);this._pushSubscription&&this._pushSubscription.unsubscribe();for(var za in this._listeners)this._listeners[za]&&this._listeners[za].remove();clearTimeout(this._pollToken);this._pollToken=null;this._cleanupInputFocusListener();this._cleanupContentResizeListener();i.inform('Ticker/cleanup');},_onNavHandler:function(za,ab){var bb=ab.params.key;if(bb!='lf'&&bb!='h')this._cleanup();},registerStoryDialog:function(za,ab){if(this._uaCurStoryIDFetch==za.id)this._uaCurStoryIDFetch=null;if(this._uaCurStoryIDPrefetch==za.id)this._uaCurStoryIDPrefetch=null;this._fetchedStories[za.id]=true;this._fetchedStoriesDialog[za.id]=ab;ab.setContext(za);ab.subscribe('hide',this._deactivateStory.bind(this,true));ab.subscribe('success',this._focusStory.bind(this,za));ab.subscribe('beforehide',function(){if(this._selecting){this._selecting=false;return false;}}.bind(this));if(this._popupOnHover){ab.subscribe('mouseenter',this._clearHoverTimeouts.bind(this));ab.subscribe('mouseleave',this._scheduleHide.bind(this));ab.subscribe('show',function(){setTimeout(this._highlightDialogScrollbar.bind(this,ab),0);var bb=g.listen(ab.getContent(),'mousedown',function(){this._selectStory(za);bb.remove();}.bind(this));}.bind(this));}if(za==this._activeStory)this._openDialog(ab);},_highlightDialogScrollbar:function(za){var ab=p.scry(za.getContent(),'.uiScrollableArea')[0];ab&&y.poke(ab);},_openStoryExternally:function(za,event){var ab=za.getAttribute('data-href');if(!ab||ab=='#')return;var bb=za.getAttribute('data-story-rel');switch(bb){case 'theater':this._deactivateAndClearStory();l.loadModules(["PhotoViewer"],function(eb){eb.bootstrap(ab,za);});return;case 'async':this._deactivateAndClearStory();j.bootstrap(ab,za);return;}var cb=za.getAttribute('data-target'),db=(event.which!=1||event.getModifiers().any||cb=='_blank');db?window.open(ab,'_blank'):ta(ab);},_deactivateAndClearStory:function(){this._clearHoverTimeouts();this._deactivateStory();},_focusStoryWillTriggerScroll:function(za){var ab=this._container,bb=ab.clientHeight,cb=za.offsetHeight,db=ab.scrollTop,eb=db+bb,fb=za.offsetTop,gb=fb+cb;return fb<db||gb>eb;},_focusStory:function(za){if(this._focusStoryWillTriggerScroll(za))this._preventScrollDismiss=true;var ab=new w(za),bb=v.byClass(za,'scrollable'),cb=ab.boundWithin(new w(bb)).getPositionVector(),db=ab.getPositionVector().sub(cb);if(db.y!==0)db.scrollElementBy(bb);za.focus();},_selectStory:function(za){this._selectedStory=za;o.addClass(za,'tickerStorySelected');o.addClass(this._root,'tickerChildSelected');},_activateStory:function(za,ab){this._clearHoverTimeouts();if(za==this._activeStory||!this._storyCanOpenDialog(za))return;this._deactivateStory();this._focusStory(za);this._activeStory=za;o.addClass(za,'tickerStoryActive');window.Toggler&&da.hide();if(this._logFlyouts){ab=ab||'unknown';new k('/ajax/feed/ticker/flyout.php',{src:ab}).send();}ca.log(za);var bb=this._getStoryDialog(za);if(bb){if(this._storyDialogResources[za.id])l.loadResources(this._storyDialogResources[za.id]);this._openDialog(bb);ja.bumpEntityKey('ticker_stories','flyouts.open');return;}if(!(za.id in this._fetchedStories))this._uaCurStoryIDFetch=za.id;this._fetchStory(za);},handleRemoveStory:function(){this._deactivateStory(true);},_deactivateStory:function(za){if(this._activeStory===this._deactivatingStory)return;this._deactivatingStory=this._activeStory;if(this._dialog){if(za){this._dialog.enableBehavior(s);}else this._dialog.disableBehavior(s);this._dialog.hide();}if(this._activeStory){o.removeClass(this._activeStory,'tickerStoryActive');o.removeClass(this._activeStory,'tickerStorySelected');o.removeClass(this._root,'tickerChildSelected');}this._dialog=this._selectedStory=this._activeStory=null;this._cleanupInputFocusListener();this._cleanupContentResizeListener();this._deactivatingStory=null;},_logUserAction:function(za,ab,event){ka(ab,za,event,'FORCE');},_fetchStory:function(za){clearTimeout(this._fetchToken);var ab=[],bb=this._getInsertedStories(),cb=bb.indexOf(za);[-1,0,1].forEach(function(db){var eb=bb[cb+db];eb&&ab.push(eb);},this);this._fetchToken=setTimeout(this._fetchStories.bind(this,ab),100);},_fetchStories:function(za){var ab=[],bb,cb=function(db){clearTimeout(bb);za.forEach(function(eb){o.conditionClass(eb,'tickerStoryFetching',db);});};za=za.filter(function(db){if(db.id in this._fetchedStories)return false;this._fetchedStories[db.id]=true;var eb=this._getStoryDialogParams(db);if(!eb)return false;eb.uniq_id=db.getAttribute('id');eb.referrer=this._tickerSource;ab.push(eb);return true;},this);if(!ab.length)return;bb=this._setTimeout(cb.bind(null,true),500);new j('/ajax/feed/ticker/multi_story').setInitialHandler(this._handleDialogResponse.bind(this,ab)).setFinallyHandler(cb.bind(null,false)).setErrorHandler(qa).setData({stories:ab}).setAllowCrossPageTransition(this._tickerInSidebarMode).send();},_handleDialogResponse:function(za,ab){if(ab&&ab.resource_map){var bb=[];for(var cb in ab.resource_map){var db=ab.resource_map[cb];if(db.type==='css'&&!db.permanent)bb.push(cb);}if(bb.length>0)for(var eb=0;eb<za.length;eb++)this._storyDialogResources[za[eb].uniq_id]=bb;}},_tickerDeClicker:function(event){var za=event.getTarget(),ab=v.byTag(za,'a'),bb=this._getStoryFromNode(za),cb=this._getButtonFromNode(za);if(bb&&ab&&!cb&&o.hasClass(bb,'tickerStoryClickable')&&!o.hasClass(ab,'tickerStoryAllowClick')&&!this._storyIsHidden(bb))ab.setAttribute('rel','ignore');var db=(event.button==2),eb=(event.type==='keydown'),fb=bb&&this._getActionButtonFromStory(bb);if(!db&&fb&&!eb)this._setClickedStory(bb);},_handleMouseup:function(event){this._clearClickedStory();},_setClickedStory:function(za){this._clearClickedStory();o.addClass(za,'tickerStoryClicked');this._clickedStory=za;},_clearClickedStory:function(){if(this._clickedStory){o.removeClass(this._clickedStory,'tickerStoryClicked');this._clickedStory=null;}},_initInfiniteScrollListener:function(){var za=this._getInsertedStories();if(this._storiesWithActions)for(var ab=0;ab<za.length;ab++){var bb=za[ab];if(o.hasClass(bb,'tickerStoryWithButton'))this._storiesWithActions[bb.getAttribute('data-story-key')]=bb;}var cb=Math.max(0,za.length-this._autoloadStoryIndex);this._infiniteScrollStory=za[cb];this._checkInfiniteScroll();},_checkInfiniteScroll:function(){if(this._infiniteScrollStory){var za=ha.getElementPosition(this._infiniteScrollStory).y,ab=ha.getElementPosition(this._container).y+ha.getElementDimensions(this._container).y;if(za<ab){var bb=p.scry(this._root,'.tickerMorePager a')[0];if(bb){var cb=v.byClass(bb,'stat_elem')||bb;new j(bb.getAttribute('ajaxify')).setReadOnly(true).setRelativeTo(bb).setStatusElement(cb).setAllowCrossPageTransition(true).send();}this._infiniteScrollStory=null;this._autoloadStoryIndex=5;}}},_setFixed:function(za){if(!this._selectedStory)return;var ab=this._getStoryDialog(this._selectedStory);if(ab){ab.setFixed&&ab.setFixed(za);ab.updatePosition();}},_setTimeout:function(za,ab){return setTimeout(za,ab,!this._tickerInSidebarMode);},_scrollDialogToBottom:function(){var za=this._dialog&&this._dialog.getContent(),ab=za&&p.scry(za,'.uiScrollableAreaWrap')[0],bb=ab&&y.getInstance(ab);bb&&bb.scrollToBottom();},_redrawFlyout:function(za,ab){if(this._hasUFIUpdated)return;var bb=this._dialog;if(bb&&bb.isShown()&&ma(bb.getContent(),ab.form)){this._hasUFIUpdated=true;this._updateDialogPosition();}},_openDialog:function(za){if(!this._tickerInSidebarMode)o.addClass(za.getRoot(),'tickerStoryOverlayOnTop');this._hasUFIUpdated=false;var ab=ia.getScrollPosition();this._dialog=za.show();window.scrollTo(ab.x,ab.y);this._updateDialogPosition();this._writeSwfFrame(za);setTimeout(this._initCommentFocusListener.bind(this),0);setTimeout(this._initContentResizeListener.bind(this),0);this._stupidIE7VideoResizeHack(za);},_stupidIE7VideoResizeHack:function(za){if(ga.ie()===7){var ab=p.scry(za.getContent(),'.uiVideoThumb .img');ab.forEach(function(bb){aa.set(bb,'width','');});}},_updateDialogPosition:function(){var za=this._tickerInSidebarMode||!!v.byClass(this._root,'fixed_elem');this._dialog.setFixed&&this._dialog.setFixed(za);this._adjustFlyoutContentHeight();this._dialog.updatePosition();},_writeSwfFrame:function(za){var ab=this._dialog&&this._dialog.getContent(),bb=p.scry(ab,'.swfObject')[0];if(!bb)return;var cb=bb.getAttribute('data-swfid');if(cb&&window[cb]){var db=window[cb];db.write(bb);}},_initCommentFocusListener:function(){var za=this._dialog&&this._dialog.getContent(),ab=za&&p.scry(za,'.tickerDialogFooter textarea')[0];if(!ab)return;this._listeners.inputFocus=g.listen(ab,'focus',this._scrollDialogToBottom.bind(this));},_cleanupInputFocusListener:function(){if(this._listeners.inputFocus){this._listeners.inputFocus.remove();this._listeners.inputFocus=null;}},_initContentResizeListener:function(){var za=this._dialog&&this._dialog.getContent();if(!za)return;this._listeners.contentResize=g.listen(za,'click',function(){setTimeout(this._dialog.updatePosition.bind(this._dialog),0);}.bind(this));},_cleanupContentResizeListener:function(){if(this._listeners.contentResize){this._listeners.contentResize.remove();this._listeners.contentResize=null;}},_adjustFlyoutContentHeight:function(){var za=this._dialog&&this._dialog.getContent(),ab=za&&p.scry(za,'.uiScrollableAreaWrap')[0];if(!ab)return;var bb=ha.getElementDimensions(ab),cb=ha.getElementPosition(ab),db=p.scry(ab,'.uiUfi .uiUfiComment'),eb=p.scry(ab,"._12tg")[0],fb=p.scry(ab,".UFILikeSentence")[0],gb=this.FLYOUT_MAX_HEIGHT;if(eb||fb){var hb=this._getUfiItemAndTop(eb,fb),ib=hb[0],jb=hb[1];gb=Math.max(gb,this.FLYOUT_TARGET_HEIGHT_OFFSET+ab.scrollTop+jb+ib.offsetHeight-cb.y);}var kb=ha.getViewportDimensions().y-this.FLYOUT_VIEWPORT_PADDING;gb=Math.min(gb,kb);var lb=gb-this.FLYOUT_TARGET_HEIGHT_OFFSET;for(var mb=0;mb<db.length;mb++){var nb=db[mb],ob=ha.getElementPosition(nb),pb=ob.y-cb.y;if(Math.abs(pb-lb)<=this.FLYOUT_OFFSET_THRESHOLD){lb=pb+this.FLYOUT_COMMENT_OFFSET;break;}}if(bb.y>=lb){aa.set(ab,'height',lb+'px');aa.set(ab,'max-height',null);}else{aa.set(ab,'max-height',gb+'px');aa.set(ab,'height',null);}},_getUfiItemAndTop:function(za,ab){var bb=(za&&ha.getElementPosition(za).y)||0,cb=(ab&&ha.getElementPosition(ab).y)||0,db=[za,bb+this.FLYOUT_ACTION_FOOTER_PADDING],eb=[ab,cb];return bb>cb?db:eb;},_initObjectIDs:function(){var za=this._getAllStories();for(var ab=za.length-1;ab>=0;ab--){var bb=za[ab].getAttribute('data-story-key');if(bb){this._objectIDs[bb]=true;this._lastKStoriesInsert(za[ab]);var cb=za[ab].getAttribute("data-dedupe-key");if(cb)this._dedupeKeys[cb]=true;}}},_handleChatOpened:function(){this._deactivateStory();},_handleChannelConnection:function(){this._checkChannelConnection();},getNewest:function(){return this._newest;}});e.exports=ya;},null);