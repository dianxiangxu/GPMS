(function($,window){$.validator.setDefaults({errorPlacement:$.noop,highlight:function(element){$(element).closest("div.required, div.optional, div.option-group").removeClass("valid").addClass("error")},unhighlight:function(element){$(element).closest("div.required, div.optional, div.option-group").removeClass("error").addClass("valid")}});function facebookLoginErrorHandler(response){if(response.error){alert("There was a communication error with Facebook. Please manually complete the form below.");$.ajax({type:"post",url:"record_js_error",data:{message:"Facebook error",operation:response.operation,errorCode:response.error,provider:"facebook"}})}}var stateMap={alberta:"ab","british columbia":"bc",manitoba:"mb","new brunswick":"nb",newfoundland:"nl","nova scotia":"ns","northwest territories":"nt",nunavut:"nu",ontario:"on","prince edward island":"pe",quebec:"qc",saskatchewan:"sk",yukon:"yt","af americas":"aa","af except am. &amp; pac.":"ae",alaska:"ak",alabama:"al","af pacific":"ap",arkansas:"ar",arizona:"az",california:"ca",colorado:"co",connecticut:"ct","district of columbia":"dc",delaware:"de",florida:"fl",georgia:"ga",hawaii:"hi",iowa:"ia",idaho:"id",illinois:"il",indiana:"in",kansas:"ks",kentucky:"ky",louisiana:"la",massachusetts:"ma",maryland:"md",maine:"me",michigan:"mi",minnesota:"mn",missouri:"mo",mississippi:"ms",montana:"mt","north carolina":"nc","north dakota":"nd",nebraska:"ne","new hampshire":"nh","new jersey":"nj","new mexico":"nm",nevada:"nv","new york":"ny",ohio:"oh",oklahoma:"ok",oregon:"or",pennsylvania:"pa","rhode island":"ri","south carolina":"sc","south dakota":"sd",tennessee:"tn",texas:"tx",utah:"ut",virginia:"va",vermont:"vt",washington:"wa",wisconsin:"wi","west virginia":"wv",wyoming:"wy"};function deriveUserFields(user){if(user.email){user.confirmEmail=user.email}if(user.providers){user.provider=user.providers.toString()}if(user.gender){if(user.gender==="m"){user.gender="male"}else{if(user.gender==="f"){user.gender="female"}}}if(user.age){$('[name="age"] option').each(function(){var range=$(this).val().split("-");if(range.length===2){if(user.age>=range[0]&&(range[1]==="INF"||user.age<=range[1])){user.ageRange=$(this).val()}}})}if(user.birthday){var millisecondDiff=new Date().getTime()-new Date(user.birthday).getTime(),testDate=new Date(millisecondDiff);user.age=testDate.getFullYear()-1970;$('[name="age"] option').each(function(){var range=$(this).val().split("-");if(user.age>=range[0]&&(range[1]==="INF"||user.age<=range[1])){user.ageRange=$(this).val()}})}if(user.city){var citystate=user.city.split(",");if(citystate.length===2){user.city=citystate[0].replace(/^\s+|\s+$/g,"");if(user.state===""){user.state=citystate[1].replace(/^\s+|\s+$/g,"")}}}if(user.state){user.state=stateMap[user.state.toLowerCase()]}if(user.state){$('[name="state"] option').each(function(){var range=$(this).val().split("-");if(range.length===2){if(user.state.toLowerCase()===range[1].toLowerCase()){user.state=$(this).val()}}})}return user}function View(element,options){this.$element=$(element);this.options=$.extend({},this.defaults,options);this.initialize()}View.prototype={constructor:View,defaults:{},initialize:$.noop};View.extend=function(protoProps,staticProps){var parent=this;var child=function(){return parent.apply(this,arguments)};$.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate();if(protoProps){$.extend(child.prototype,protoProps)}child.__super__=parent.prototype;return child};var FormView=View.extend({submitted:false,show:function(){this.$element.show()},hide:function(){this.$element.hide()}});var LoginView=FormView.extend({initialize:function(){this.$form=this.$element.find("form");this.$element.on("click",".login-button",function(){$.publish("reg:facebook",["login"])})},setupValidation:function(){this.$fields=this.$element.find(":input").not(':button, :submit, [type="hidden"]');this.$errorMessage=this.$element.find(".error-message");this.$element.find("form").validate({onfocusout:$.proxy(this.handleInput,this),onkeyup:$.proxy(this.handleInput,this),onclick:$.proxy(this.handleInput,this),invalidHandler:$.proxy(function(event,validator){$.publish("reg:invalid",["Login Form"]);for(var i=0,len=validator.errorList.length;i<len;i++){var errorElement=validator.errorList[i].element;$.publish("reg:invalidField",[errorElement.name])}this.submitted=true;this.showError()},this),submitHandler:function(form){setTimeout(function(){form.submit()},100)}})},showError:function(){this.$errorMessage.show()},hideError:function(){this.$errorMessage.hide()},handleInput:function(){if(this.submitted&&this.$fields.valid()){this.hideError()}}});var ProfileView=FormView.extend({initialize:function(){var self=this;this.$fields=this.$element.find(":input").not(':button, :submit, [type="hidden"]');this.$errorMessage=this.$element.find(".error-message");this.$element.on("click",".form-nav button",function(){var direction=$(this).data("direction");self.submitted=true;$.publish("reg:navigate",[direction,self])})},showError:function(){this.$errorMessage.show()},hideError:function(){this.$errorMessage.hide()}});var RegistrationView=FormView.extend({initialize:function(){this.profileView=new ProfileView(".profile");this.profile2View=new ProfileView(".profile2");this.activeView=this.profileView;this.$form=this.$element.find("form");this.$element.on("click",".login-button",function(){$.publish("reg:facebook",["registration"])})},setupValidation:function(){this.$element.find("form").validate({onfocusout:$.proxy(this.handleInput,this),onkeyup:$.proxy(this.handleInput,this),onclick:$.proxy(this.handleInput,this),invalidHandler:$.proxy(function(event,validator){var activeView=this.activeView;$.publish("reg:invalid",["Registration Form"]);for(var i=0,len=validator.errorList.length;i<len;i++){var errorElement=validator.errorList[i].element;$.publish("reg:invalidField",[errorElement.name])}activeView.submitted=true;activeView.showError()},this),submitHandler:function(form){oneclick.track("Registration Form","Valid Submission");setTimeout(function(){form.submit()},100)}})},handleInput:function(){var activeView=this.activeView;if(activeView.submitted&&activeView.$fields.valid()){activeView.hideError()}}});var oneclick={defaults:{inFieldLabels:true,validate:true},initialize:function(options){var directFBLogin=oneclick.directFBLogin;var urlParamCode=$.urlParam("code");var self=this;this.$element=$("#container");this.options=$.extend({},this.defaults,options);this.loginView=new LoginView("#login-view");this.registrationView=new RegistrationView("#reg-view");this.profileView=this.registrationView.profileView;this.profile2View=this.registrationView.profile2View;this.deployPath=this.$element.data("deploy-path");this.pageName=this.$element.data("page-name");this.bindEvents();if(urlParamCode){$(document).on("fbInitialized",function(){window.FB.api("/me",function(response){var key;var map={};if(response&&response.first_name){for(key in response){if(response.hasOwnProperty(key)){map[key]=key}}self.fillFormFields(map,self.registrationView.$form,response)}})})}if(this.options.inFieldLabels){this.inFieldLabels()}if(this.options.validate){this.loginView.setupValidation();this.registrationView.setupValidation();this.profileView.$fields.each(function(){var el=$(this);if(el.val()&&(!el.is("input[type='checkbox']")||el.attr("checked"))){self.showProfile2();return false}})}else{this.$element.find('select[name^="age."]').parent().removeClass("required")}},bindEvents:function(){var self=this;this.$element.on("click",".toggle-login",function(e){self.showLogin();self.track("Login Form Link","Click");e.preventDefault()}).on("click",".toggle-reg",function(e){self.showRegistration();self.track("Registration Form Link","Click");e.preventDefault()});if(this.options.validate){$.subscribe("reg:navigate",function(direction,profile){if(direction==="prev"){self.showProfile()}else{if(profile.$fields.valid()){profile.hideError();self.showProfile2()}else{profile.showError();profile.$fields.each(function(){var $el=$(this);if(!$el.valid()){$.publish("reg:invalidField",[$el.attr("name")])}})}}})}else{$.subscribe("reg:navigate",function(direction){if(direction==="next"){self.showProfile2();self.track("Registration Form","Next Button Click")}else{self.showProfile();self.track("Registration Form","Previous Button Click")}})}$.subscribe("reg:facebook",function(form){self.track("Facebook Login Button","Click");$(".form-instructions").hide();if(self.cookieCheck()){window.facebook_login_func({callback:facebookLoginErrorHandler})}else{alert("Your browser currently has cookies disabled. Please enable them.")}});$.subscribe("reg:invalid",function(form){self.track(form,"Invalid Submission")});$.subscribe("reg:invalidField",function(fieldName){self.track("Invalid Field",fieldName)});var $age=$("#age");var ageObject=$age.data("validate");if(ageObject&&ageObject.text_birth_date){$age.mask("99/99/9999",{placeholder:ageObject.text_birth_date[1]})}},showRegistration:function(){this.loginView.hide();this.registrationView.show();this.activeView=this.registrationView;$("body").removeClass("page-login").addClass("page-registration")},showLogin:function(){this.registrationView.hide();this.loginView.show();this.activeView=this.loginView;$("body").removeClass("page-registration").addClass("page-login")},showProfile:function(){this.profile2View.hide();this.profileView.show();this.registrationView.activeView=this.profileView},showProfile2:function(){if(this.profile2View.$fields.length>0){this.profileView.hide();this.profile2View.show();this.registrationView.activeView=this.profile2View}},inFieldLabels:function(){var $labels=this.$element.find("label");$labels.filter(function(){return $(this).siblings().is('input[type="text"], input[type="email"], textarea')}).addClass("infield-label").inFieldLabels({fadeDuration:0,fadeOpacity:0.001});$labels.filter(function(){return $(this).siblings().is("div.counter")}).removeClass("infield-label").addClass("infield-label-counter");$labels.each(function(){var $el=$(this);if($el.siblings().is("select")){$el.hide()}})},cookieCheck:function(){if($.cookie("test",true)){$.cookie("test",null);return true}},track:function(category,action){window.__utmTrackEvent(category,action,"","",this.deployPath+this.pageName)},fillFormFields:function(fieldMap,form,user,options){var formFields=form.find(":input").not(":button, :submit, :reset, :image");if(!options){options={}}user=deriveUserFields(user);formFields.each(function(){var $el=$(this);var userField=$el.attr("name");var newValue;if(fieldMap[userField]){userField=fieldMap[userField]}newValue=user[userField];if(newValue){if($el.is(":radio")){if(newValue){$el.prop("checked",true)}}else{if($el.is(":checkbox")){if(userField==="age"&&newValue>=options.minimum_consumer_age){$el.prop("checked",true)}}else{if($el.is("select")){$el.val(user.ageRange)}else{$el.val(newValue)}}}}$el.trigger("focus").trigger("blur").trigger("autofill")})}};window.oneclick=oneclick}(jQuery,window));