(function(doc,Math,undefined){var _NAMESPACE="v4",_VERSION="4.0.2",_DEBUG=0,root=this,html=doc.documentElement||doc.getElementsByTagName("html")[0],ua=navigator.userAgent;var Common=function(obj){if(obj instanceof Common)return obj;else if(!(this instanceof Common))return new Common(obj)};root[_NAMESPACE]=Common;Common.version=function(){return _VERSION};Common.isWebkit=function(){return"webkitRequestAnimationFrame"in root};Common.isIE=function(){var ua=ua||navigator.userAgent;return/MSIE/.test(ua)||
/Trident.*rv[ :]*11\./.test(ua)};Common.isIEMobile=function(){return/IEMobile/.test(ua)};Common.isSafari=function(){return/Safari/.test(ua)&&/Apple Computer/.test(navigator.vendor)};Common.isChromeIOS=function(){return/CriOS/.test(ua)};Common.isMobile=function(){return"orientation"in root||Common.isIEMobile()};Common.applyUAClasses=function(){var uaString=navigator.userAgent,uaName="",uaVersion="";var uaClasses=[];if(uaString.indexOf("Chrome")>-1){uaName="uaChrome";uaVersion=uaString.substring(uaString.indexOf("Chrome")+
7).trim()}else if(uaString.indexOf("iPhone")>-1){uaName="uaIPhone";uaVersion=uaString.substring(uaString.indexOf("iPhone OS")+10).trim().replace("_","-")}else if(uaString.indexOf("Safari")>-1){uaName="uaSafari";uaVersion=uaString.substring(uaString.indexOf("Version")+8).trim()}else if(uaString.indexOf("Firefox")>-1){uaName="uaFirefox";uaVersion=uaString.substring(uaString.indexOf("Firefox")+8).trim()}else if(uaString.indexOf("MSIE")>-1){uaName="uaMSIE";uaVersion=$.trim(uaString.substring(uaString.indexOf("MSIE")+
5))}else if(/Trident.*rv[ :]*11\./.test(uaString)){uaName="uaMSIE";uaVersion="11"}else if(uaString.indexOf("Opera")>-1){uaVersion=uaString.substring(uaString.indexOf("Opera")+6).trim();uaName="uaOpera"}if(uaVersion.indexOf(" ")>0)uaVersion=uaVersion.substring(0,uaVersion.indexOf(" "));if(uaVersion.indexOf(".")>0)uaVersion=uaVersion.substring(0,uaVersion.indexOf("."));uaClasses.push(uaName);uaClasses.push(uaName+uaVersion);$("html").addClass(uaClasses.join(" "))};Common.isAssetRef=function(ref){return ref.indexOf("ugc:")==
0||ref.indexOf("asset:")==0||ref.indexOf("weburl:")==0};Common.queryStringObject=function(param,url){var qs=url?url.substring(url.indexOf("?")):root.location.search,out={};if(qs)_.each(qs.slice(1).split("&"),function(item){var kvp=item.split("=");out[kvp[0]]=kvp[1]||undefined});return typeof param==="string"?out[param]:out};Common.updateQueryString=function(newParams,replaceIfExists,fullUrl){var _newParams=newParams||{},_replace=!!replaceIfExists===false?false:true,_qUrl=(fullUrl==="ctx:smarturl"?
NGX.context.smarturl:fullUrl)||document.location.href,_hasQS=_qUrl.indexOf("?")>-1?true:false,_qString=_hasQS?_qUrl.substring(_qUrl.indexOf("?")+1):"",_qSObj={},_newQSObj={};if(_qString)_.each(_qString.split("&"),function(item){var kvp=item.split("=");_qSObj[kvp[0]]=kvp[1]||undefined});if(_replace)_.extend(_newQSObj,_qSObj,_newParams);else _.extend(_newQSObj,_newParams,_qSObj);if(_hasQS)_qUrl=_qUrl.substring(0,_qUrl.indexOf("?"));return _qUrl+"?"+decodeURIComponent($.param(_newQSObj))};Common.asyncFn=
function(fn,context,delay){if(typeof fn==="function")setTimeout(function(){fn.call(context||root)},delay||20)};Common.openWindow=function(url,obj){if(url){if(obj)url+="?"+$.param(obj);window.open("//"+url,"_blank","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600")}return false};Common.action=function(ref){return NGX.App.api.action(ref)};Common.state=function(ref){return NGX.App.api.state(ref)};Common.submit=function(displayState){return NGX.App.api.campaignEntry(displayState)};
Common.random=function(max){var type=typeof max,maxInt="undefined"!==type&&"number"!==type?parseInt(max,10):max;return Math.floor(Math.random()*(maxInt+1||9999))};Common.trim=function(nativeTrimSupport){if(nativeTrimSupport)return function nativeTrim(str){return"string"===typeof str?str.trim(str):false};return function fastTrim(str){if("string"!==typeof str)return false;var len=str.length,checkCode=function(code){var c=str.charCodeAt(code);return c!=32&&c!=10&&c!=13&&c!=9&&c!=12};for(var i=0;i<len;i++)if(checkCode(i))break;
for(var j=len-1;j>=i;j--)if(checkCode(j))break;return str.substring(i,j+1)}}("function"===typeof String.prototype.trim);Common.capitalize=function(str){return str.charAt(0).toUpperCase()+str.slice(1).toLowerCase()};Common.isRef=function(str){if(typeof str==="string")return/[a-z]+(:\w+)+/g.test(str);return undefined};Common.tokenize=function(str,obj){var match,context=obj||(this===root?{}:this);if(typeof str==="string"){while(match=/\$\{(.*?)\}/g.exec(str))str=str.replace(match[0],context[Common.trim(match[1])]||
"");return str}return""};Common.isCheckbox=function(el){return el.getAttribute("type")==="checkbox"};Common.isSelectbox=function(el){return typeof el.selectedIndex!=="null"};Common.getAttrsByPrefix=function(el,prefix){var out={},plen,len,attr,i=0;if(!el||!prefix||"undefined"===typeof el.attributes)return false;len=el.attributes.length;plen=prefix.length;for(;i<len;i++){attr=el.attributes[i];if(attr.name.indexOf(prefix)===0)out[attr.name.substring(plen)]=attr.value}return out};Common.offsetTop=function(el){var top=
0;if(!_.isElement(el))return false;if(el.offsetParent){do top+=el.offsetTop;while(el=el.offsetParent)}return top};Common.getParentAttr=function(el,attr){if(el&&attr){do if(_.isElement(el)&&el.hasAttribute(attr))return el.getAttribute(attr);while(el=el.parentNode)}return false};Common.addScriptTag=function(url,id,callback){var el,js;if(!url||!id||doc.getElementById(id))return false;js=doc.createElement("script");js.id=id;js.src=url;js.async=true;js.type="text/javascript";if(typeof callback==="function")js.onload=
function(){callback.call(root)};el=doc.getElementsByTagName("script")[0];el.parentNode.insertBefore(js,el);return js};Common.getParentByTagName=function(el,tagName){tagName=tagName?tagName.toUpperCase():"FORM";if(el&&el.nodeType){do if(el.tagName===tagName)return el;while(el=el.parentNode)}return false};Common.updateClassByPrefix=function(el,prefix,val){var clss=el.getAttribute("class"),out=[];if(!val||!prefix)return false;if(clss)_.each(clss.split(" "),function(item){if(item.indexOf(prefix)!==0&&
item!=="")out.push(item)});out.push(prefix+Common.capitalize(val+""));el.setAttribute("class",out.join(" "));return out};Common.debug=function(isWebkit){var base="margin:0;padding:2px 4px;line-height:24px",bg=";background:#",br=";border:1px solid #",co=";color:#",style=[co+"c09853"+bg+"fcf8e3"+br+"fbeed5",co+"b94a48"+bg+"f2dede"+br+"eed3d7",co+"468847"+bg+"dff0d8"+br+"d6e9c6",co+"3a87ad"+bg+"d9edf7"+br+"bce8f1"],safariSupport=function(){var m=navigator.userAgent.match(/AppleWebKit\/(\d+)\.(\d+)(\.|\+|\s)/);
if(!m)return false;return 537.38<=parseInt(m[1],10)+parseInt(m[2],10)/100},buildArr=function(val,level){var css=style[style.length>=level?level:0],type=typeof val;return type==="string"||isNaN(val)===false?[(type!=="string"?type+" ":"")+"%c"+val,base+css]:[val]},isValidLevel=function(level){return!level||level<=_DEBUG};if(!root.console||"undefined"===typeof console||"function"!==typeof console.log)return function noOp(){return false};if(Common.isWebkit()&&(!Common.isSafari()||safariSupport()))return function stylizedLogging(val,
level){if(isValidLevel(level))return console.log.apply(console,buildArr(val,level))};return function consoleLogging(val,level){if(isValidLevel(level))return console.log.call(console,val)}}(Common.isWebkit());Common.debugLevel=function(level){if(_.isNumber(level)){_DEBUG=level;Common.debug("debug level = "+level)}return _DEBUG};(function(level){if(level)Common.debugLevel(parseInt(level,10))})(Common.queryStringObject("debug"))}).call(window,document,Math);
NGX.lang={extend:function(obj){$.extend(true,this,obj)},get:function(stringKey){var o=this;_key=stringKey.replace(/\[(\w+)\]/g,".$1");_key=_key.replace(/^\./,"");var a=_key.split(".");while(a.length){var n=a.shift();if(n in o)o=o[n];else return}return o}};
NGX.App=function(w,d,$,_,undefined){var Components=false,App=false,Router=false,Events={},Templates={},Actions=false,States=false,viewDef={},trackQueue=[],Config={},State={},conf={app:".xPage",section:".xSectionContent",component:".xComponent"},gateApp=function(cfg){var _el=cfg&&cfg.hasOwnProperty("el")?cfg.el:".xPageInner",_val=true,_type=cfg&&cfg.hasOwnProperty("type")?cfg.type:"";$("body").addClass("x"+_type+"Gated");$(_el).html(NGX.lang.get("form.coppa.title"));NGX.overlay.create({template:NGX.App.api.getTemplate("inviteModal"),
type:"modal x"+_type+"Gate",content:{title:NGX.lang.get("form.coppa.title"),msg:NGX.lang.get("form.coppa.msg")},callback:function(){if(cfg&&cfg.hasOwnProperty("store")&&cfg.store===true){if(cfg.data)_val=NGX.Util.hashCode(cfg.data);NGX.StorageManager.push("gate_"+NGX.App.config.tenant,_val,"local")}}})},processTrackQueue=function(){var i=0,len=trackQueue.length;trackQueue.push=function(evt){Insights.track(evt)};for(;i<len;i++)Insights.track(trackQueue[i])},mergeAndPurge=function(obj){if(this!==w&&
_.isObject(NGX[obj])){_.extend(this,NGX[obj]);delete NGX[obj]}},stateReady=function(name){State[name+"Ready"]=true;Events.trigger(name+":ready");v4.debug(name+" ready",2)},preCompileTemplates=function(targ){_.each((targ||d.body).getElementsByTagName("script"),function(el){if(el.hasAttribute("id")&&el.getAttribute("type")==="text/x-template-handlebars")addTemplate(el.getAttribute("id").replace(/^\W+$/g,""),el.innerHTML)})},updateQueryString=function(options){var qs=decodeURIComponent(w.location.search),
qsObj={},qsArr,len,item,i=0;if(_.isObject(options))_.extend(State.query,options);else if(qs){qsArr=qs.substring(1).split("&");len=qsArr.length;for(;i<len;i++){item=qsArr[i].split("=");qsObj[item[0]]=item.length>1?item[1]:undefined}State.query=qsObj}return State.query},getQuerystring=function(){if(State.query)return"?"+$.param(State.query);return""},registerView=function(type,view){viewDef[type]=view},getTemplate=function(id){if("function"===typeof id)return id;return Handlebars.templates["display/"+
id]||Templates[id]||false},addTemplate=function(el,val){return el&&val&&"function"===typeof Handlebars.compile?Templates[el]=Handlebars.compile(val):false},getForm=function(formID){var el=d.getElementById(formID||"xCampaignForm"),type=el?"inline":"hidden",form=el||d.getElementById("xHiddenForm");return{el:form,type:form?type:undefined}},getTestID=function(){return NGX.App.config.testID||undefined},setTestID=function(testID){NGX.App.config.testID=testID;setFormField("ngx_test_id",testID);return testID},
messageParent=function(msgObj,callback){if(NGX.App.state.framed){var getFrameId=function(){if(NGX.context.isPreview)return"iframe-preview-details";else if(NGX.context.displayContainer)return"ngxFrame"+NGX.context.displayContainer.guid+":"+NGX.context.displayContainer.id};var _theMsg={action:"",event:"",msgId:Date.now(),id:getFrameId(),payload:{}};if("function"===typeof callback)NGX.App.state.callbackQueue[_theMsg.msgId]=callback;_.extend(_theMsg,msgObj);var msgString="_NGX_"+JSON.stringify(_theMsg);
v4.debug('Messaging Parent with: "'+msgString+'"',6);return window.parent.postMessage(msgString,"*")}},resizeParent=function(config){if(!NGX.context.isFB)messageParent({action:config&&config.mode?config.mode:"resize",event:"frame:resize",payload:{height:$("body").outerHeight(true)}})},scrollTo=function(x,y){if(NGX.App.state.framed)if(NGX.context.isFB)FB.Canvas.scrollTo(x,y);else messageParent({action:"scrollTo",payload:{left:x,top:y}});else window.scrollTo(x,y)},elementIntoView=function(el){if(!isElInViewport(el[0]))NGX.App.api.scrollTo(0,
el.position().top)},isElInViewport=function(el){var rect=el.getBoundingClientRect(),vHeight=window.innerHeight||document.documentElement.clientHeight;if(rect.top>vHeight)return false;return rect.top>0},setFormField=function(id,val,type,formID){var el,form=getForm(formID||"xCampaignForm"),overrideFieldID=null;if(typeof id==="string"&&form.el){if(formID!=="xCampaignForm")overrideFieldID=formID+"_"+id;el=d.getElementById(overrideFieldID||id);if(!el){el=d.createElement("input");el.id=overrideFieldID||
id;el.setAttribute("name",id);el.type=typeof type==="string"?type:"hidden";form.el.appendChild(el)}el.value=val?val.toString():""}return el},getMetadata=function(prop){var obj=Config.extendedProperties,out;if(!obj)return false;if(typeof prop==="string")return obj[prop];if(_.isArray(prop)){out={};_.each(prop,function(item){out[item]=obj[item]});return out}return obj},getComponents=function(){_.each($(conf.component),function(item){if(!item.hasAttribute("data-registered")){Components.add(new Component({targ:"#"+
item.id,type:item.getAttribute("data-componenttype")}));item.setAttribute("data-registered","true")}})},appEntry=function(stateName){var form=getForm();if(form.el)switch(form.type){case "inline":NGX.App.api.state(stateName||v4.getParentAttr(form.el,"data-statename"));break;case "hidden":submitCampaignObjectForm(form.el)}},Component=Backbone.Model.extend({defaults:{},initialize:function(){this.id=this.get("targ").substring(1);Events.trigger("init:"+this.id,this);trackQueue.push("view:"+this.attributes.type);
v4.debug("Component "+this.id+" initialised",3)}}),ComponentList=Backbone.Collection.extend({model:Component}),ComponentView=Backbone.View.extend({}),AppModel=Backbone.Model.extend({}),AppView=Backbone.View.extend({el:conf.app,initialize:function(){this.listenTo(Components,"add",this.addComponent);this.model.set("sections",this.$(conf.section));NGX.App.api.getComponents()},addComponent:function(model){var obj={model:model,el:model.has("targ")?$(model.get("targ")):false,tagName:"section"},Fn=viewDef[model.get("type")];
if(typeof Fn==="function")return(new Fn(obj)).render();else return new ComponentView(obj)}}),AppRouter=Backbone.Router.extend({initialize:function(){this.createStateRoutes.call(this,flowJSON.states);stateReady("router")},createStateRoutes:function(statesObj){_.each(statesObj,function(item){var route=item.route;if(route){this.route(route+"(/:id)",route,function(id){this.stateChange(route)},this);if(!this.defaultState&&item.defaultState)this.defaultState=route;NGX.context.availableStates=NGX.context.availableStates||
[];NGX.context.availableStates.push(route)}},this);if(!this.defaultState&&statesObj&&statesObj[0])this.defaultState=statesObj[0].route;if("undefined"!==typeof this.defaultState)this.route("(_=_)",this.defaultState,function(){Backbone.history.navigate(this.defaultState+getQuerystring(),{trigger:true,replace:false})},this)},stateChange:function(route){var stateObj=States.get({route:route});if(stateObj)Actions.byRef("state:"+stateObj.name,stateObj)}}),appFlowInit=function(){var appFlow=NGX.appFlow.init();
States=appFlow.state;Actions=appFlow.action;NGX.App.api.register=appFlow.register;NGX.App.api.remove=appFlow.remove;NGX.App.api.action=Actions.trigger;NGX.App.api.state=function(routeName){return Actions.trigger("route:"+routeName)};NGX.App.api.statePrev=NGX.appFlow.prev;NGX.App.api.actionClick=function(e){var attObj=v4.getAttrsByPrefix(this,"data-ngx-"),eClass=this.getAttribute("class");if(attObj.action){e.preventDefault();if(!eClass||eClass&&!/\bcurrent\b/.test(eClass))NGX.App.api.action(attObj.action,
attObj)}};Events.on("state",function(stateName,stateObj){State.name=stateName;App.model.set("state",stateObj);NGX.App.api.resizeParent()})},AppInit=function(){mergeAndPurge.call(Config,"config");mergeAndPurge.call(State,"state");updateQueryString();_.extend(Events,Backbone.Events);NGX.App.Components=Components=new ComponentList;v4.applyUAClasses();preCompileTemplates.call(w,d.body);if(Config.shareOnInit)Events.on("fb:ready",function(){switch(Config.shareOnInitMode){case "invite":NGX.Virality.inviteFBFriends();
break;case "share":NGX.Virality.facebookShare(Config.sharing);break;default:break}});$(function(){State.currentUser.id=NGX.Util.getRefCookie({c_name:"ngx"});NGX.App.Events.on("all",function(e){if(v4.queryStringObject("debug")>2)v4.debug("Event triggered: ["+e+"]");NGX.App.api.messageParent({action:"event",event:e})});App=new AppView({model:new AppModel(Config.extendedProperties)});stateReady("app");Router=new AppRouter;appFlowInit();Backbone.history=Backbone.history||new Backbone.History({});Backbone.history.start({root:NGX.context.basePath,
pushState:typeof history.pushState!=="undefined"});NGX.App.config.hasSecondaryForm=document.getElementById("xSecondaryForm")?true:false;$(conf.app).on("click","[data-ngx-action]",NGX.App.api.actionClick);stateReady("page");processTrackQueue();NGX.App.api.resizeParent()})};window.fbAsyncInit=function(){if(NGX.context.fb){FB.init({appId:NGX.context.fb.app.id,status:true,channelUrl:NGX.context.displayUrl+"/ui/channelUrl.gsp",cookie:true,xfbml:true,version:NGX.context.fb.apiVersion,oauth:true});if(NGX.context.isFB===
true){NGX.Util.resizeCanvas();FB.Canvas.scrollTo(0,0)}NGX.Util.fbLogin(function(response){State.fbLoaded=true;State.currentUser.userSession=response;if(response.authResponse&&response.status==="connected"){State.currentUser.fbid=response.authResponse.userID;State.currentUser.accessToken=response.authResponse.accessToken}if(response.status==="connected")FB.api("/me",function(response){State.currentUser.userProfile=response;var form=d.getElementById("xCampaignForm");if(!form)form=d.getElementById("xHiddenForm");
if(form)populateFormData(form,response);stateReady("fb")});else{if(response.error)Config.permissionRequest.timing="submit";stateReady("fb")}if(State.currentUser.fbid){var home=d.getElementById("Header_xModule_header"),button,href;if(home){button=$(".xCTA a",home);href=button.attr("href");if(href)button.attr("href",href+((href.indexOf("?")>-1?"&":"?")+"fbid="+State.currentUser.fbid))}}},{timing:"init"})}};return{init:AppInit,api:{echo:function(){if(console&&typeof console.log==="function")console.log(arguments)},
registerView:registerView,addTemplate:addTemplate,getTemplate:getTemplate,getComponents:getComponents,getForm:getForm,setFormField:setFormField,getMetadata:getMetadata,getQuerystring:getQuerystring,messageParent:messageParent,getTestID:getTestID,setTestID:setTestID,resizeParent:resizeParent,scrollTo:scrollTo,elementIntoView:elementIntoView,gate:gateApp,facebookShare:function(conf){var sharingOpt=$.extend(true,NGX.App.config.sharing,conf);if(sharingOpt)NGX.Virality.facebookShare(sharingOpt)},facebookInvite:function(){if(FB)FB.login(function(response){NGX.Virality.inviteFBDialog(response)},
{scope:""});else throw new Error("Facebook API unavailable");},campaignEntry:appEntry},Events:Events,config:Config,state:State}}(this,document,$,_);NGX.App.init();
NGX.game=function(){var Cache={},Game,getGameById,getGameContent,scoreSubmit,scoreSet,fbShare,fbInvite;Game=function(o){_.extend(this,o,NGX.App.config.extendedProperties);this.parentState=v4.getParentAttr(o.el,"data-statename");$.ajax({url:"/display/page/entries/"+NGX.context.apikey+"/"+NGX.App.config.id+".json",context:this}).success(function(response){this.content=response;NGX.App.Events.trigger("game:"+this.id+":ready",this)});NGX.App.Events.on("state",function(_self){return function scoped(name){var isActive=
name===_self.parentState;if(_self.active!==isActive){_self.active=isActive;NGX.App.Events.trigger("game:"+_self.id+":"+(_self.active?"active":"inactive"),_self)}}}(this))};getGameById=function(id){return Cache[id]||false};getGameContent=function(id,assetId){var g=getGameById(id);if(g){if(typeof assetId=="string"&&_.isObject(g.content))return _.where(g.content,{id:assetId});return g.content}return false};scoreSubmit=function(id){var g=getGameById(id);if(g)if(NGX.App.api.setFormField("ngxQuizScore",
g.score)){v4.submit();return true}return false};scoreSet=function(id,score){var g=getGameById(id);if(g){if(score)g.score=score;return g.score}return false};fbShare=function(id){var g=getGameById(id),opts;if(g){if(g.shareMessage)opts={name:v4.tokenize(g.shareMessage,g)};NGX.App.api.facebookShare(opts);return true}return false};fbInvite=function(id){var g=getGameById(id),opts;if(g){if(g.inviteMessage)opts={inviteDialog:{message:v4.tokenize(g.inviteMessage,g)}};NGX.Virality.inviteFBFriends(opts);return true}return false};
NGX.App.api.game={get:getGameById,submit:scoreSubmit,score:scoreSet,share:fbShare,invite:fbInvite,content:getGameContent};var init=function(gameConfig){var g=new Game(gameConfig);Cache[g.id]=g;NGX.App.Events.trigger("game:"+g.id+":init",g);return g};return{register:init}}();
NGX.appFlow=function(root,d,$,json){var body=d.body,_state=false,_action=false,_prev=false,_current=false,stateInit={},actionInit={},actionJSON=json.actions;var stateCache=function(raw){var out={},item,i=0,len;if(raw){len=raw.length;for(;i<len;i++){item=raw[i];if(item.name)out[item.name]=item}}return out}(json.states);var getRefObj=function(refStr){var refArr=refStr.split(":");return{method:refArr[0],action:refArr[1],target:refArr[2],params:function(a){var out=[],len=a.length,i=2;if(len>=i)for(;i<
len;i++)if(a[i].length>0)out.push(a[i]+"");return out}(refArr)}},canSeeCampaign=function(){},screenPosition=function(){if(NGX.context.isFB===true&&"undefined"!==typeof FB)NGX.Util.resizeCanvas()},componentsStatus=function(status,el){$("[data-componenttype]",el).each(function(i,item){if(item.id)NGX.App.Components.get(item.id).set("viewed",true)})},updateNav=function(){var attr="data-ngx-action",update=function(){var data=this.getAttribute(attr);$(this)[data&&data.indexOf(":"+_current.route)>-1?"addClass":
"removeClass"]("current")};$("nav").find("a["+attr+"]").each(update)},showTabAsOverlay=function(state){NGX.App.api.messageParent({action:"getPageInfo"});var el=d.getElementById("xSection"+v4.capitalize(state));if(el){var $el=$(el),$content=$(".xSectionInner",$el);NGX.overlay.create({content:$content.html(),type:"state"});v4.updateClassByPrefix(body,"xState",state);componentsStatus("show",el);return el}},showTab=function(state){var rxA=/\bxSectionContent\b/,el=d.getElementById("xSection"+v4.capitalize(state)),
n,nClass,nClassArr=["xHidden","xSectionActive"];if(el&&el.parentNode){n=el.parentNode.firstChild;for(;n;n=n.nextSibling)if(n.nodeType===1&&n.hasAttribute("class")){nClass=n.getAttribute("class");if(rxA.test(nClass))$(n).addClass(nClassArr[n!==el?0:1]).removeClass(nClassArr[n!==el?1:0]+" xOverlay")}updateNav();v4.updateClassByPrefix(body,"xState",state);componentsStatus("show",el);screenPosition();return el}return false};var State=function(){var stateAction=function(newState){var action=newState.action;
if(action&&action.indexOf("state")!==0)return _action.trigger(action,_current);v4.debug('Unable to execute State action "'+action+'"',1);return true},stateInvoke=function(name){var newState=stateCache[name],init=stateInit[name],doState=function(){_prev=_current;_current=newState;v4.asyncFn(function(){NGX.App.Events.trigger("state",newState.name,newState);NGX.App.Events.trigger("navigate:page",newState.name,newState);NGX.App.Events.trigger("state:"+newState.name,newState);NGX.App.Events.trigger("navigate:page:"+
newState.name,newState);NGX.App.api.messageParent({action:"event",event:"state",payload:{name:newState.name}})});v4.debug('entered State "'+newState.name+'", action is "'+newState.action+'"',2);return stateAction(newState)};if(newState){if(init){if(init.async===true)return init.fn(doState);init.fn()}return doState()}v4.debug('unable to change state "'+name+'"',1);return false},removeStateInit=function(name){if(stateInit[name]){delete stateInit[name];v4.debug('State event "beforeState:'+name+'" removed',
2);return true}return false},addStateInit=function(name,fn,isAsync){var out=false;if(name&&typeof fn==="function"){out=stateInit[name]={async:isAsync||false,fn:fn};v4.debug('State event "'+name+'" created',2)}return out};return{get:function(obj){return _.findWhere(json.states,obj)},invoke:stateInvoke,register:addStateInit,remove:removeStateInit}};var Action=function(){var method={exec:function(obj){var fn=NGX.App.api[obj.action];if(typeof fn==="function")return fn.apply(root,obj.params);v4.debug('API method "'+
obj.action+'" not found',1);return false},game:function(obj){var fn,gameAPI=NGX.App.api.game;if(typeof gameAPI==="object"){fn=NGX.App.api.game[obj.action];if(typeof fn==="function")return fn.apply(root,obj.params)}return false},display:function(obj,params){switch(obj.action){case "dialog":return NGX.overlay.create({content:d.getElementById("xSection"+v4.capitalize(obj.target)).innerHTML,onclose:function(){if(_prev)NGX.appFlow.prev()}});case "campaign":case "page":if(params&&params.style==="overlay")return showTabAsOverlay(obj.target);
return showTab(obj.target);case "promo":v4.debug("Display Promo: "+obj.target,5);NGX.overlay.create({url:"/display/promotion/ajaxOverlay?id="+obj.target,callback:function(){$(".xComponent",".xOverlayInner").on("click",".xContainer .xTriggerOverlay",initOverlayHandler);NGX.App.api.getComponents()}});Insights.track("view:promo",{p:obj.target});break;case "item":v4.debug("Display Item: "+obj.target,5);popOverlayForDisplayItem(obj.target);break}return false},share:function(obj,params){var shareContext=
NGX.App.api.share[obj.action],fn;if(shareContext){fn=shareContext[obj.target];params.context=obj.action;if(typeof fn==="function"){v4.debug(obj.target+" "+obj.action+" share prompt",2);NGX.App.Events.trigger("action:share");return fn.call(root,params)}}return false},route:function(obj,params){var route=obj.action+(obj.target?"/"+obj.target:""),theQS=NGX.App.api.getQuerystring();v4.debug('routing to "'+route+'"',2);Backbone.history.navigate(route,{trigger:true,replace:false});Backbone.history.navigate("ngxtemp",
{trigger:false,replace:false});Backbone.history.navigate(route+theQS,{replace:true});return route},network:function(obj,params){switch(obj.action){case "twitter":var url="twitter.com/intent/"+(obj.target=="reply"?"tweet":obj.target),twParams={};twParams[obj.target=="reply"?"in_reply_to":"tweet_id"]=obj.params[1];v4.openWindow(url,twParams);break}Insights.track(obj.target+":contentitem",{"action":obj.target,ci:obj.params[2],target:obj.action})},state:function(obj){if(_current&&_current.route===obj.action){v4.debug('Cannot re-trigger current active state "'+
obj.action+'"',1);return false}return _state.invoke(obj.action)},redirect:function(obj,params){if(_current&&_current.route===obj.action){v4.debug('Cannot re-trigger current active state "'+obj.action+'"',1);return false}Insights.track("redirect:contentitem",{i:obj.target,link:params.link});if(params.ctatarget=="_blank")window.open(params.link);else document.location=params.link},vote:function(obj){NGX.contests.doVote(null,obj.target)}},getActionObjByName=function(name){var obj=actionJSON[name];return obj&&
obj.action?obj:false},getActionRefByName=function(name){var obj;if(name&&!v4.isRef(name)){obj=actionJSON[name];if(obj&&obj.action)return obj.action;return false}return name},triggerByRef=function(refStr,params,caller){v4.debug("triggerByRef = "+refStr,3);var obj=getRefObj(refStr),fn=method[obj.method],init=actionInit[caller],out=function(){var fnOut=fn(obj,params);v4.asyncFn(function(){var str=caller||refStr;NGX.App.Events.trigger("action",str);NGX.App.Events.trigger("action:"+str,fnOut)}.bind(this));
return fnOut};if(typeof fn==="function"){if(init&&caller){if(init.async===true)return init.fn(out);init.fn()}return out()}v4.debug('Method "'+obj.method+'" is not a function',1);return false},triggerByName=function(name){v4.debug("triggerByName = "+name,3);var obj=getActionObjByName(name);if(obj)return triggerByRef(obj.action,obj,name);v4.debug('Action "'+name+'" not found',1);return false},triggerByValue=function(action,params,caller){v4.debug("triggerByValue = "+action,3);if(action){if(v4.isRef(action))return triggerByRef(action,
params,caller);return triggerByName(action)}v4.debug("No action specified",1);return false},addActionInit=function(name,fn,isAsync){var out=false;if(typeof fn==="function")if(name){out=actionInit[name]={async:isAsync||false,fn:fn};v4.debug('Action event "beforeAction:'+name+'" created',2)}return out},removeActionInit=function(name){if(actionInit[name]){delete actionInit[name];v4.debug('Action event "beforeAction:'+name+'" removed',2);return true}return false},registerAction=function(name,obj,overwrite){var out=
false;if(!actionJSON[name]||overwrite===true)if(typeof obj==="object"&&obj.action){out=actionJSON[name]=obj;v4.debug('Action "'+name+'" registered',2)}return out};return{byName:triggerByName,byRef:triggerByRef,trigger:triggerByValue,getAction:getActionObjByName,getRef:getActionRefByName,register:addActionInit,remove:removeActionInit,regAction:registerAction}};return{registerEvent:function(ref,fn,optional){var arr,name,type;if(v4.isRef(ref)){arr=ref.split(":");type=arr[0];name=arr[1];if(!name||typeof fn!==
"function")return false;switch(type){case "beforeAction":return _action.register(name,fn,optional);case "beforeState":return _state.register(name,fn,optional);case "onAction":case "onState":return NGX.App.Events.on(type.substr(2).toLowerCase()+":"+name,fn)}}v4.debug('unrecognised action ref syntax "'+ref+'"',1);return false},removeEvent:function(ref){var arr,name,type;if(v4.isRef(ref)){arr=ref.split(":");type=arr[0];name=arr[1];switch(type){case "beforeAction":return _action.register(name);case "beforeState":return _state.register(name);
case "onAction":case "onState":return NGX.App.Events.off(type.substr(2).toLowerCase()+":"+name)}}v4.debug('unrecognised action ref syntax "'+ref+'"',1);return false},prev:function(){var stateName=json.states[0].name;if(stateName===_current.name)stateName=json.states[1].name;if(typeof _prev==="object"&&_prev.route)stateName=_prev.route;NGX.App.api.state(stateName)},init:function(){canSeeCampaign();return{state:function(){if(!_state)_state=new State;return _state}.call(this),action:function(){if(!_action)_action=
new Action;return _action}.call(this),register:this.registerEvent,remove:this.removeEvent}}}}(window,document,$,flowJSON);
NGX.overlay=function(w,d,$,undefined){var config={prefix:"xO-",oClass:"xOverlay",iClass:"xOverlayInner xDetailContainer",cClass:"xOverlayContent",static:"content"},oIndex=0,oCache={},Overlay=function(id,options){this.id=id;_.extend(this,options);if(this.url)ajaxContent.call(this);createMarkup.call(this)},createOverlay=function(options){var id,obj,cache,o;if(!NGX.context.isFB)if(NGX.App.state.framed)NGX.App.api.messageParent({action:"getPageInfo"});else NGX.App.state.pageInfo={clientHeight:Math.max(document.documentElement.clientHeight,
window.innerHeight||0),scrollTop:window.pageYOffset!==undefined?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop,offsetTop:0};else if(NGX.App.state.fbLoaded&&FB)FB.Canvas.getPageInfo(function(info){NGX.App.state.pageInfo=info});if(options){if(options.type===config.static){cache=_.where(oCache,{type:config.static});if(cache.length>0){o=cache[0];o.content=options.content||false;o.url=options.url||false;if(o.url)return ajaxContent.call(o);else if(o.content)return updateContent.call(o);
return false}}id=config.prefix+ ++oIndex;obj=oCache[id]=new Overlay(id,options);return obj}return false},getOverlay=function(id,prop){var oObj=oCache[id];if(!oObj)return false;return prop?oObj[prop]||false:oObj},ajaxContent=function(){var _self=this;$.ajax({url:this.url}).fail(function(xhr,err,msg){if(!_self.content)_self.content='<div class="'+config.oClass+'-error"><h1>'+err+"</h1><p>"+msg+'</p><button class="xAction xActionCloseOverlay"><span>Close</span></button></span></div>'}).done(function(response){if(response.content)_self.content=
response.content[0];else _self.content=response}).complete(function(){updateContent.call(_self)});return _self},updateContent=function(){var _self=this;if(this.template){if(typeof this.template!=="function")this.template=Handlebars.compile(this.template);if(_.isObject(this.content))this.content=this.template(this.content);else this.content=this.template(this)}else if(this.view)this.content=this.view.render().$el;this.$contentWrapper.html(this.content);if(this.callback&&this.callback.constructor===
Function)this.callback.call(this);NGX.App.Events.trigger("overlay:ready",this);imagesLoaded(_self.el,function(){_self.center.call(_self)});return this},createCloseButtons=function(type){var toolbar=d.createElement("div"),outer,middle;toolbar.setAttribute("class","xActionContainer xActionClose has"+type.charAt(0).toUpperCase()+type.slice(1));if(type=="button"){outer=d.createElement("div");middle=d.createElement("span");outer.setAttribute("class","xButton xAction xActionCloseOverlay");middle.innerHTML=
NGX.lang.get("buttons.overlayClose")}else{outer=d.createElement("a");middle=d.createElement("i");outer.setAttribute("class","xIconButton xAction xActionCloseOverlay");outer.setAttribute("href","#");middle.setAttribute("class","xIcon xIconClose")}if(this.type=="state")middle.setAttribute("data-ngx-action","exec:statePrev");outer.appendChild(middle);toolbar.appendChild(outer);return toolbar},createMarkup=function(){var _self=this,el=this.el=d.createElement("div"),ir=this.inner=d.createElement("div"),
contentWrapper=this.contentWrapper=d.createElement("div"),$e=this.$el=$(el),$i=this.$inner=$(ir),$contentWrapper=this.$contentWrapper=$(contentWrapper);el.id=this.id;el.setAttribute("class",config.oClass+(_self.type?" "+config.oClass+"-"+_self.type:""));ir.setAttribute("class",config.iClass);contentWrapper.setAttribute("class","xOverlayContent");if(_self.type)el.setAttribute("data-type",_self.type);ir.appendChild(createCloseButtons.call(_self,"icon"));ir.appendChild(contentWrapper);ir.appendChild(createCloseButtons.call(_self,
"button"));el.appendChild(ir);ir.style.opacity="0";if(_self.type!=="modal"&&_self.type!=="state"){$e.on("click",function(){_self.destroy()});$i.on("click",":not([data-ngx-action],[data-ngx-action]>*,.xCTA>span)",function(e){e.stopPropagation();var $this=$(this),$promo=$this.parents(".xPromotion");if($promo)if($this.hasClass("xCTASecondary"))Insights.track("click:secondaryCta",{p:$promo.attr("data-ngx-id")});else if($this.hasClass("xCTA"))Insights.track("click:promo",{p:$promo.attr("data-ngx-id")})})}$i.on("click",
".xActionCloseOverlay span, .xActionCloseOverlay .xIconClose",function(e){e.preventDefault();_self.destroy()}).on("click","[data-ngx-action]",NGX.App.api.actionClick);d.body.appendChild(el);updateContent.call(_self)};Overlay.prototype.show=function(){this.el.style.opacity="1";return this};Overlay.prototype.center=function(){var _self=this,positionInner=function(info){if("undefined"===typeof info)info=NGX.App.api.messageParent({action:"getpageinfo"});var _info=info||{};_self.inner.style.maxHeight=
"none";var st=_info.scrollTop,ch=_info.clientHeight,ih=_self.$inner.outerHeight(),ot=_info.offsetTop,total;var vTop,vMiddle,vBottom;if(NGX.App.state.framed){vTop=st;vBottom=vTop+ch;vMiddle=(vBottom-vTop)/2+vTop;total=vMiddle-ih/2-ot;var docHeight=$(d).outerHeight();if(ih>docHeight){d.body.style.minHeight=ih+40+"px";NGX.App.api.messageParent({action:"grow",payload:{height:ih+40}});total=0}if(total>docHeight||total+ih>docHeight)total=docHeight-(ih+40)}else total=ch/2-ih/2;_self.inner.style.top=Math.max(10,
Math.round(total))+"px";_self.inner.style.opacity="1"};if(NGX.context.isFB&&NGX.App.state.framed){_self.$el.addClass("xPositionFrame");if(!NGX.App.state.fbLoaded)NGX.App.Events.on("fb:ready",function(){FB.Canvas.getPageInfo(positionInner)});else FB.Canvas.getPageInfo(positionInner)}else{_self.$el.addClass("xPositionScreen");setTimeout(function(){positionInner(NGX.App.state.pageInfo)},75)}return this};Overlay.prototype.hide=function(){NGX.App.Events.trigger("overlay:hidden");this.el.style.opacity=
"0";return this};Overlay.prototype.destroy=function(){d.body.removeChild(this.el);d.body.style.minHeight="";delete oCache[this.id];--oIndex;if(typeof this.onclose==="function")return this.onclose();NGX.App.Events.trigger("overlay:destroyed");return null};$(function(){$(d).keydown(function(e){var o;if(e.keyCode==4||e.keyCode==27){o=oCache[config.prefix+oIndex];if(o){e.preventDefault();o.destroy()}}})});return{get:getOverlay,create:createOverlay,cache:{}}}(this,document,$);
(function(w,doc,o){var openWindow=function(url,obj){if(url){if(obj)url+="?"+$.param(obj);w.open("//"+url,"_blank","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600")}return false},tokenizeMe=function(input,obj){return v4.tokenize(input,obj||NGX.App.config.extendedProperties)},buildLink=function(link,internal){var arr,json,linkString,qs="",qsr=function(id){return id?"r="+id:""}(NGX.App.state.currentUser.id);if("string"===typeof link){arr=link.split(":");if(_.isArray(arr)){switch(arr[0]){case "url":arr[1]=
arr[1]=="campaignlink"?"smarturl":arr[1];case "ctx":json=NGX.context;break}linkString=json?json[arr[1]||"smarturl"]:link;linkString=linkString?linkString:document.location.href;return NGX.Util.addRefCookie({link:linkString,c_name:"ngx"})}}else return link+qs},trackShare=function(data){var getContext=function(c){var el,cmp="campaign";if(!c)return"contentitem";else if(c=="campaign"||c=="confirmation")return cmp;else{el=doc.getElementById(c);if(el){var cmpType=el.getAttribute("data-componenttype");if(cmpType==
"socialcontentwall"||cmpType=="socialcontentmosaic"||cmpType=="socialcontentcarousel")return"contentitem";else return"campaign"}else return cmp}},source=NGX.context.isFB?"facebook":"web";Insights.track("share:"+getContext(data.context),{source:source,target:data.target,i:data.id})},networks={twitter:{post:function(data,overrides){_.extend(data,overrides);openWindow("twitter.com/share",{url:buildLink(data.link,overrides.linktype=="internal"),text:tokenizeMe(data.message,data)});trackShare($.extend({},
data,{target:"twitter"}))}},google:{post:function(data,overrides){_.extend(data,overrides);openWindow("plus.google.com/share",{url:buildLink(data.link,overrides.linktype=="internal")});trackShare($.extend({},data,{target:"google"}))}},vk:{post:function(data,overrides){_.extend(data,overrides);var pictureData=NGX.Util.assetFromRef(data.picture),canonSrc=v4.isAssetRef(data.picture)?pictureData.src:data.picture;openWindow("vk.com/share.php",{url:buildLink(data.link,overrides.linktype=="internal"),title:tokenizeMe(data.title,
data),description:tokenizeMe(data.message,data),image:canonSrc?canonSrc:""});trackShare($.extend({},data,{target:"vk"}))}},facebook:{post:function(data,overrides){_.extend(data,overrides);if(data.linktype=="external"&&data.picture)openWindow("facebook.com/sharer/sharer.php",{appId:NGX.context.fb.app.id,sdk:"joey",display:"popup",u:encodeURIComponent(data.link)});else{var pictureData=NGX.Util.assetFromRef(data.picture),canonSrc=v4.isAssetRef(data.picture)?pictureData.src:data.picture;canonSrc=canonSrc.substring(0,
2)=="//"?"https:"+canonSrc:canonSrc;NGX.App.api.facebookShare({name:tokenizeMe(data.title,data),link:buildLink(data.link),picture:canonSrc?canonSrc:"",caption:tokenizeMe(data.byline,data),description:tokenizeMe(data.message,data)})}trackShare($.extend({},data,{target:"facebook"}))}},pinterest:{post:function(data,overrides){_.extend(data,overrides);var pictureData=NGX.Util.assetFromRef(data.picture),canonSrc=v4.isAssetRef(data.picture)?pictureData.src:data.picture;openWindow("pinterest.com/pin/create/button",
{media:canonSrc?canonSrc:"",url:buildLink(data.link,overrides.linktype=="internal"),description:tokenizeMe(data.message,data)});trackShare($.extend({},data,{target:"pinterest"}))}}},shareFactory=function(obj){if(obj.enabled==="true"&&networks[obj.network]){NGX.App.api.share[obj.context]=NGX.App.api.share[obj.context]||{data:obj};NGX.App.api.share[obj.context][obj.network]=networks[obj.network].post.bind(obj,obj.data[0])}};(function(){NGX.App.api.share=NGX.App.api.share||{};NGX.App.api.addShare=shareFactory;
NGX.App.Events.on("page:ready",function(){_.each(o,function(item){shareFactory(item)})});NGX.App.Events.on("fb:ready",function(){if(NGX.App.api.share&&NGX.App.api.share.confirmation&&"confirmation"===NGX.App.state.name&&"function"===typeof NGX.App.api.share.confirmation.facebook)NGX.App.api.share.confirmation.facebook({context:"confirmation"})})})()})(this,document,NGX.App.config.sharingConfig);var compositeCustomValidations={};var ngxMultiOptIns=[];
(function(root,doc){var $form=$("#xCampaignForm"),$secondary=$("#xSecondaryForm"),html=doc.documentElement||doc.getElementsByTagName("html")[0],customValidations={},fieldGroups=[];if(!v4.isMobile()){$("select").selectize({wrapperClass:"xComboWrapper",inputClass:"xComboInput",dropdownClass:"xComboOptions",dropdownContentClass:"xComboOption",selectOnTab:true,allowEmptyOption:true});if(v4.isIE())$("input",$form).click(function(){$(this).focus()})}$form.attr("novalidate","novalidate");$form.parsley({namespace:"data-parsley-",
excluded:"input[type=hidden], :disabled",inputs:"[data-parsley-trigger]",useHtml5Constraints:false,validateIfUnchanged:true,validate:false,validators:{ngxcustom:function(){return{validate:function(val,attrVal,c){var fn=customValidations[attrVal];if("function"===typeof fn)return fn.call(window,val,c.$element);return true},priority:512}},markup:function(){return{validate:function(val,attrVal,c){var acceptable="b|i|em|u|p|br|span|a".split("|"),re=/<[^>]+>/g,matches=val.match(re),badTags=false;if(/<!/.test(val))return false;
var acceptTag=function(tag){var tagName=tag.replace(/[<>\/]/g,"").toLowerCase();if(!_.contains(acceptable,tagName))return false;return true};_.each(matches,function(match){if(!acceptTag(match))badTags=true;return});if(badTags)return false;return true},priority:1024}},fileupload:function(){return{validate:function(val,required,field){var valid=false;field.options.validateIfUnchanged=true;if(required==false)return true;else{var filename=null,filesize=undefined,maxSize=0,fieldEl=field.$element;if(fieldEl&&
fieldEl.attr("type")=="file"){if(!(root.FileReader&&root.File))filename=field.$element.get(0).value||null;else{var theFile=field.$element.get(0).files[0];filename=theFile?theFile.name:null;maxSize=parseInt(field.$element.attr("data-ngx-maxsize"));if(!isNaN(maxSize)&&maxSize>0)filesize=theFile?theFile.size:null}if(filename){field.$element.attr("data-parsley-value",filename);valid=true}else{field.$element.attr("data-parsley-value","");valid=false}if(filesize&&filesize>maxSize)valid=false}else if(fieldEl&&
fieldEl.attr("type")=="text")if(val!==""&&val!=="-")valid=true;else valid=false;return valid}},priority:1024}}},messages:{name:"You must complete all fields",fileupload:"The upload field is not populated"},successClass:"xFieldValid",errorClass:"xFieldError",validatedClass:"xFieldValidated",errors:{classHandler:function(element,isRadioOrCheckbox){var $el=$(element),$fieldItem=$el.parents(".xFieldItem");if($fieldItem.hasClass("xControlAddress")&&!$fieldItem.hasClass("xComposite"))return $el.parents(".xFieldWrapAddress");
return $fieldItem}},listeners:{onFormValidate:function(){},onFieldError:function(elem,constraints,field){setTimeout(function(){formWrapperResize();NGX.App.api.resizeParent()},300,$form,elem)}}});if(html&&html.hasAttribute("class")&&!/\bfileinput\b/g.test(html.getAttribute("class"))){var frm=NGX.lang.form||false,cls="uploadUnsupported",msg=frm&&frm[cls]?frm[cls]:"Upload not supported by your device";$(".xControlUpload",$form).html('<div class="xErrorLabel xUploadUnsupported">'+msg+"</div>")}var ngxValidations=
{name:{msg:"Please enter your full name",fn:function(control){var $control=$(this),includeTitle=$control.hasClass("xFormatNameTitle")||$control.hasClass("xFormatNameTitleLastFirst");if(!$control.hasClass("xRequired"))return true;var getVal=function(selector){var $el=$("#"+control+"_"+selector),val=v4.trim($el.val()),rxp=/<|>|\/|\\|"|\*|%|;|\{|\}|&|\+|\n|\r/g.test(val);return val&&val!==""&&rxp===false};if(includeTitle)return getVal("Title")&&getVal("Firstname")&&getVal("Lastname");else return getVal("Firstname")&&
getVal("Lastname")}},address:{msg:"Please enter your full address",fn:function(control){var $control=$('[data-ngx-control="'+control+'"]'),includeCountry=$control.hasClass("hasCountry"),validateUSAddress=$control.hasClass("xFormatAddressUs")&&(includeCountry&&$("#"+control+"_Country").val()==="USA"),validateUKAddress=$control.hasClass("xFormatAddressUk")||includeCountry&&$("#"+control+"_Country").val()==="GBR";var getVal=function(selector){var $el=$("#"+control+"_"+selector),val=v4.trim($el.val()),
rxp=/<|>|\\|"|\*|%|;|\{|\}|&|\+|\n|\r/g.test(val);return val&&val!==""&&rxp===false?true:false},checkZip=function(){if(validateUSAddress){var _zipVal=$("#"+control+"_Zip").val();return _zipVal.length===5||_zipVal.length===9||_zipVal.length===10}return true},checkState=function(){if(validateUSAddress)return getVal("State");return true};if(includeCountry&&!getVal("Country"))return false;else if(validateUSAddress)return getVal("Address1")&&getVal("City")&&checkState()&&getVal("Zip")&&checkZip();else if(validateUKAddress)return getVal("Address1")&&
getVal("City")&&getVal("Zip");else return getVal("Address1")&&getVal("City")}},"date_of_birth":{fn:function(controlName){var _datecompare,checkYear=function(dVal,now){var validYear=function(v,d){var nowSuffix,yearPrefix,$yearEl=$("#"+controlName+"_year");if(v&&v>=0&&v<=99){nowSuffix=d.year()%100;yearPrefix=Math.round(d.year()/100)-(v>nowSuffix?1:0);dobObj.year=yearPrefix*100+v;$yearEl.data("value",dobObj.year);return true}$yearEl.data("value",dobObj.year);if(v>=1E3&&v<=9999&&v<=$yearEl.attr("max"))return true;
return false};return _.isNumber(dVal)&&validYear(dVal,now)},checkMonth=function(mVal,now){return!isNaN(mVal)},checkDay=function(dVal,now){var validDay=function(v,d){var $dayEl=$("#"+controlName+"_day");$dayEl.data("value",dobObj.day);if(v>=1&&v<=31)return true;return false};return _.isNumber(dVal)&&validDay(dVal,now)},getVal=function(selector){return parseInt($("#"+controlName+"_"+selector).val(),10)},getAge=function(age){var ageInt=parseInt(age,10);if(!_.isNumber(ageInt))ageInt=18;return ageInt-
2*ageInt},dobObj={day:getVal("day"),month:getVal("month"),year:getVal("year")},now=moment(parseInt(this.attr("data-ngx-datecompare"))),dob;if(checkDay.call(this,dobObj.day,now)&&checkMonth.call(this,dobObj.month,now)&&checkYear.call(this,dobObj.year,now)){--dobObj.month;dob=moment(dobObj);$("#"+controlName).val(dob.format());if(dob.isValid()){var yearsDiff=dob.diff(now,"years");if(this.attr("data-ngx-coppa")==="enabled"&&yearsDiff>-13)NGX.App.api.gate({store:true,data:$("#xReturningUserEmail").eq(0).val(),
type:"Age"});else{if(this.attr("data-ngx-minage"))return yearsDiff<=getAge(this.attr("data-ngx-minage"));return true}}return false}}}},validateAllGroups=function(){var groupValid=true,i=0,a,len=fieldGroups.length;for(;i<len;i++){a=fieldGroups[i].call(fieldGroups[i],"force");if(!a)groupValid=false}return groupValid};$form.find(".xComposite[data-ngx-control]").each(function(index,item){var $el=$(item),$input=$('select[data-ngx-validtype],input:not([type="hidden"])',$el),type=$input.eq(0).data("ngxValidtype"),
control=$el.data("ngxControl"),obj=ngxValidations[type],$el,err,objValidation,controlIsDirty,fieldErrorMsg=$(this).attr("data-ngx-control-error-msg")||"";if("undefined"!==typeof obj){err=$form.find($el.attr("data-parsley-error-container"));controlIsDirty=function($fields){var isDirty=false;_.each($fields,function(el,idx){if($(el).val())isDirty=true});return isDirty};objValidation=function(arg){var force="string"===typeof arg&&arg==="force"?true:false,$fields=$('input:not([type="hidden"],:hidden)',
$el),allFieldsTouched=true;if($fields.length&&($el.hasClass("xRequired")||controlIsDirty($fields))){_.each($fields,function(el,idx){if(!el.getAttribute("data-ngx-touched"))allFieldsTouched=false});if(allFieldsTouched||force){var valid=obj.fn.call(this,control);if(valid&&compositeCustomValidations.hasOwnProperty(control))valid=compositeCustomValidations[control].call(this,$fields);$el[(valid?"remove":"add")+"Class"]("xFieldError");err.text(fieldErrorMsg||obj.msg||"Invalid field");return valid}}else return true};
$el.on($el.attr("data-parsley-trigger")||"change","input",objValidation.bind($el));fieldGroups.push(objValidation.bind($el))}});$(".xComposite[data-ngx-minage]",$form).each(function(){var controlName=$(this).attr("data-ngx-control"),yearField=$("#"+controlName+"_year");if(yearField.length>0)$("input,textarea,select",this).on("blur",function(){var date=yearField.data("value");if(date&&date!=="")yearField.val(yearField.data("value"))})});$form.parsley("addListener",{onFieldValidate:function(elem){var $elem=
$(elem);if($elem.hasClass("selectized"))return!$elem.parent().is(":visible");else return!$elem.is(":visible")}});$form.submit(function(e){e.preventDefault();var _cntxt=NGX.context;NGX.App.Events.trigger("form:submit");submitCampaignObjectForm($form[0]);return false});$secondary.submit(function(e){e.preventDefault();NGX.App.Events.trigger("form:submit");submitCampaignObjectForm($secondary[0]);return false});$("input,select",$form).keypress(function(event){return event.keyCode!==13});NGX.App.api.formValidate=
function(){NGX.App.Events.trigger("form:validate");if("undefined"===typeof $form||$form.length===0)return true;var parsleyFieldsValid=$form.parsley("validate");var groupsValid=validateAllGroups();var valid=parsleyFieldsValid&&groupsValid;if(typeof valid==="boolean"){NGX.App.Events.trigger("form:validation:"+(valid?"passed":"failed"));return valid}throw new Error("NGX Error: form validation did not return a boolean");};NGX.App.api.addCustomValidation=function(id,fn){if(id&&"function"===typeof fn){customValidations[id]=
fn;return true}return false};NGX.App.api.addCompositeCustomValidation=function(id,fn){if(id&&"function"===typeof fn){compositeCustomValidations[id]=fn;return true}return false};$(".xActionOauth").click(function(e){var _network=e.currentTarget.getAttribute("data-ngx-network");NGX.OAuth.login({network:_network,callback:function(user,response){if(!user.firstname&&user.name){user.firstname=user.name.split(" ")[0];user.lastname=user.name.split(" ")[1]}if(user.firstname)$('[data-ngx-populate="firstname"]').val(user.firstname);
if(user.lastname)$('[data-ngx-populate="lastname"]').val(user.lastname);if(user.email)$('[data-ngx-populate="email"]').val(user.email);if(_network==="twitter")$("#twitter").val("@"+user.alias)},onError:function(response){NGX.overlay.create({type:"modal",content:"We could not get your details from "+_network})}})});if(v4.isMobile())NGX.App.Events.on("page:ready",function(){$("[type=file]").attr("multiple","multiple")})})(window,document);
$(".xComposite").on("focus","input,select",function(e){$(this).attr("data-ngx-touched","true")});
var validateCaptcha=function(callback){var _cntxt=NGX.context;var $form=$("#xCampaignForm");if(_cntxt.captcha.enabled==false)callback.call(this,$form[0]);else if(_cntxt.captcha.type==="recaptcha")NGX.overlay.create({content:NGX.App.api.getTemplate("recaptcha"),type:"modal captcha",callback:function(){var _self=this,failureDialog={template:NGX.App.api.getTemplate("inviteModal"),content:{title:NGX.lang.get("form.captcha.failed.title"),msg:NGX.lang.get("form.captcha.failed.msg"),closeBtnText:NGX.lang.get("buttons.overlayClose")},
onclose:function(){Recaptcha.reload()}};Recaptcha.create(NGX.context.captcha.key,"recaptchaWrapper",{theme:"clean"});$("#xFormRecaptcha").submit(function(e){e.preventDefault();var _chlnge=document.getElementById("recaptcha_challenge_field").value,_rspnse=document.getElementById("recaptcha_response_field").value;if(_chlnge&&_rspnse)var response=$.ajax({url:"/display/api/captcha/checkReCaptcha",data:{captcha_challenge:_chlnge,captcha_response:_rspnse}}).success(function(rsp){if(rsp.success==="true"&&
rsp.ngx_captcha_token){NGX.App.api.setFormField("ngx_captcha_token",rsp.ngx_captcha_token);NGX.App.Events.trigger("form:submit");callback.call(this,$form[0])}else NGX.overlay.create(failureDialog)});else NGX.overlay.create(failureDialog)})},onclose:function(){$(".xSubmit",$form[0]).attr("disabled",null)}})};
function restrictInput(field,restrictRegExp,maxLength){field.keypress(function(event){var character=String.fromCharCode(event.which);if(event.which==0||event.which==8||event.which==9||event.which==27||event.which==13||event.which==127||event.which==65&&event.ctrlKey===true||event.which==97&&event.ctrlKey===true||event.which==87&&event.ctrlKey===true||event.which==118&&event.ctrlKey===true||event.which==67&&event.ctrlKey===true||event.which==99&&event.ctrlKey===true||event.keyCode>=35&&event.keyCode<=
39&&event.charCode!=undefined&&event.keyCode!=event.charCode)return this;else if(!character.match(restrictRegExp))event.preventDefault()});field.keyup(function(event){field.val(stripValues(field,restrictRegExp))});function stripValues(field,restrictRegExp){var txt=field.val();var c,i,ret="";for(i=0;i<txt.length;i++){c=txt.charAt(i);if(null==restrictRegExp||c.match(restrictRegExp))ret+=c}if(!isNaN(maxLength)&&ret.length>maxLength)ret=ret.substr(0,maxLength);return ret}}
function changeMarketing(control,name){var obj=document.getElementById(name);if(control.checked)obj.value="";else obj.value=control.value}
function formAutofill(config){if(config){var i,fields,ef;if(config.email){var emailFields=getItemsByFieldValue(fieldProfiles,"profile","email");for(i=0;i<emailFields.length;i++){ef=emailFields[i];fields=$(ef.selector+" input");if(fields.length>0)$(fields.get(0)).val(config.email)}}if(config.first_name||config.last_name){var nameFields=getItemsByFieldValue(fieldProfiles,"profile","name");for(i=0;i<nameFields.length;i++){ef=nameFields[i];fields=$(ef.selector+" input");if(fields.length==1)$(fields.get(0)).val((config.first_name||
"")+" "+(config.last_name||""));else if(fields.length>1){if(config.first_name)$(fields.get(0)).val(config.first_name);if(config.last_name)$(fields.get(1)).val(config.last_name)}}}}}
function createNgxUUID(rndCase){var uv="89ab";var rndS="",i,c;for(i=0;i<32;i++){c=(Math.random()*16|0).toString(16);if(rndCase&&rndCase==true&&Math.round(Math.random())==1)c=c.toUpperCase();rndS+=c}return[rndS.substr(0,8),rndS.substr(8,4),"4"+rndS.substr(12,3),uv.charAt(Math.random()*4|0)+rndS.substr(16,3),rndS.substr(20,12)].join("-")}
function getItemsByFieldValue(dataArray,fieldName,fieldValue){var ret=[];var currentValue;for(i=0;i<dataArray.length;i++){currentValue=fieldName?dataArray[i][fieldName]:dataArray[i];if(currentValue==fieldValue)ret.push(dataArray[i])}return ret}function validateEmail(elementValue){var emailPattern=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;return emailPattern.test(elementValue)}
function populateFormData(targ,response,submitOnDone){var d=document,updated=[],add=function(id,val){var el=d.createElement("input");el.setAttribute("type","hidden");el.setAttribute("name",id);el.setAttribute("value",val||"");el.id=id;targ.appendChild(el);return el},check=function(id,val){var field=d.getElementById(id);if(field)if(field.value===val)return false;else field.setAttribute("value",val||"");else field=add(id,val);updated.push(field)},user=NGX.App.state.currentUser.userSession;if(!targ)return false;
if(response){check("fbname",response.name);check("fbid",response.id);check("fblink",response.link);check("fblocale",response.locale);check("fbfirstname",response.first_name);check("fblastname",response.last_name);if(user&&user.authResponse)check("fboauth_token",user.authResponse.accessToken)}if(submitOnDone===true)targ.submit();else return updated}
function submitCampaignObjectForm(formEl,callback){var user=NGX.App.state.currentUser.userSession,_cntxt=NGX.context,doFbLogin=function(){NGX.Util.fbLogin(function(response){if(response&&response.authResponse){NGX.App.state.currentUser.userSession=response;FB.api("/"+response.authResponse.userID+"?access_token="+response.authResponse.accessToken,function(response){if(response&&!response.error)populateFormData(formEl,response,true)})}else if(user&&user.status==="connected")populateFormData(formEl,
response,true);else if(user&&user.status==="not_authorized"){$(".xSubmit",formEl).attr("disabled",null);NGX.overlay.create({type:"modal",template:NGX.App.api.getTemplate("inviteModal"),content:{msg:NGX.lang.get("permissions.error.message"),title:NGX.lang.get("permissions.error.title"),closeBtnText:NGX.lang.get("buttons.overlayClose")}})}},{timing:"submit"})},submissionStrategy=function(callback){validateCaptcha(function(){if($(formEl).attr("data-ngx-method")==="ajax"&&"FormData"in window){var _formData=
$(":input:not(.checkField)",formEl).serializeArray(),_sendData={},_checkboxes={};var _frmData=new FormData;_frmData.append("isXHR",true);$(".checkField:checked:not([data-ngx-checkall])",formEl).each(function(idx,chk){var _chkName=chk.name.replace("[]",""),$chk=$(chk);_frmData.append(_chkName,chk.value);if(dataAttr=$chk.attr("data-ngx-progoptin")){var _filterScope=$chk.attr("data-ngx-filterscope")||"account",_skey=getStorageKey({controlName:_chkName,filterScope:_filterScope});NGX.StorageManager.push(_skey,
dataAttr)}});_.each(_formData,function(i){_frmData.append(i.name,i.value)});$.each($('[type="file"]'),function(i,el){if(el.files&&el.files.length>0)$.each(el.files,function(f,file){_frmData.append(el.name,file)})});$.ajax({type:"post",url:formEl.action,contentType:false,processData:false,data:_frmData}).success(function(response){if(response.state==="success"){if(response.url){_redirectUrl=getRedirectURL(response.url,response.entry);window.location=_redirectUrl}}else if(response.state==="already_entered"){NGX.App.Events.trigger("form:entry:alreadyentered");
NGX.overlay.create({type:"modal",template:NGX.App.api.getTemplate("inviteModal"),content:{title:NGX.lang.get("form.returningUser.entered.title"),msg:NGX.lang.get("form.returningUser.entered.msg"),closeBtnText:NGX.lang.get("buttons.overlayClose")}})}}).fail(function(){$(".xSubmit",formEl).attr("disabled",null)})}else{$(".checkField:checked:not([data-ngx-checkall])",formEl).each(function(idx,chk){var _chkName=chk.name.replace("[]",""),$chk=$(chk);if(dataAttr=$chk.attr("data-ngx-progoptin")){var _filterScope=
$chk.attr("data-ngx-filterscope")||"account",_skey=getStorageKey({controlName:_chkName,filterScope:_filterScope});NGX.StorageManager.push(_skey,dataAttr)}});if(NGX.App.config.autoInviteMode==="submit")NGX.Virality.inviteFBFriends({},callback);else if(NGX.context.isFB===false||NGX.App.config.permissionRequest.timing==="never")formEl.submit();else callback()}})},invited=document.getElementById("ngxInvitedFriends");if(invited&&NGX.App.config.invites)invited.setAttribute("value",NGX.App.state.currentUser.invitedFriends.join(","));
if(formEl.id&&formEl.id==="xHiddenForm")submissionStrategy(doFbLogin);else if(NGX.App.api.formValidate()){$(".xSubmit").attr("disabled","disabled");submissionStrategy(doFbLogin)}}
var getRedirectURL=function(url,params){var _redirectUrl=url,_paramsToSend={},_ngxMappingObject=window.ngxMappingObject||{};_.each(_ngxMappingObject,function(v,k){if(params.data.hasOwnProperty(v))_paramsToSend["nc."+k]=encodeURIComponent(params.data[v])});if(params.quiz&&params.quiz.hasOwnProperty("payload")&&params.quiz.payload)_paramsToSend["payload"]=params.quiz.payload;if(params.coupon&&params.coupon.hasOwnProperty("payload")&&params.coupon.payload)_paramsToSend["cpayload"]=params.coupon.payload;
return v4.updateQueryString(_paramsToSend,false,_redirectUrl)};function formWrapperResize($form,elem){$(".xFormPages",$form).animate({height:$(".xFormPage:visible",$form).outerHeight(true)},"fast")}NGX.App.Events.on("action:route:entry",function(){setTimeout(formWrapperResize,500)});
function checkReturningUser(){var returningUserForm=document.getElementById("xReturningUserForm"),mainCampaignForm=document.getElementById("xCampaignForm"),secondaryForm=document.getElementById("xSecondaryForm"),returningUserEmail=document.getElementById("xReturningUserEmail"),_emailAddr=returningUserEmail.value,_sendData={},_totalSecondary=$("input:not([type=hidden]),textarea,select",secondaryForm).size();showMainForm=function(formID){var theFormID=formID||"xCampaignForm",$theForm=$("#"+theFormID);
if(NGX.uiFlow.get(formID))NGX.uiFlow.get(formID).model.set("viewed",false);$('[type="email"]',$theForm).eq(0).val(_emailAddr);$(returningUserForm).addClass("xHidden");$("#xCampaignForm,#xSecondaryForm").addClass("xHidden");$theForm.removeClass("xHidden").parents(".xHidden").removeClass("xHidden");if(NGX.uiFlow.get(theFormID))NGX.uiFlow.get(theFormID).model.set("viewed",true);if($(".xFormPage",$theForm).length===1)$(".xSubmitContainer").removeClass("xHidden");formWrapperResize();NGX.App.api.resizeParent()};
if(!validateEmail(_emailAddr)){NGX.overlay.create({type:"modal",template:NGX.App.api.getTemplate("inviteModal"),content:{title:NGX.lang.get("form.returningUser.invalid.title"),msg:NGX.lang.get("form.returningUser.invalid.msg"),closeBtnText:NGX.lang.get("buttons.overlayClose")}});return false}var _blocked=NGX.StorageManager.get("gate_"+NGX.App.config.tenant),_hashed=NGX.Util.hashCode(_emailAddr);if(_blocked.indexOf(_hashed)>-1)NGX.App.api.gate({type:"Age"});else{_sendData={email:returningUserEmail.value,
apikey:NGX.context.apikey,campaignObjectId:NGX.App.config.id,ngx_remember_me:true,ngx_check_entry:NGX.App.config.hasSecondaryForm,isXHR:true};if(v4.queryStringObject("stageMode")=="true")_sendData.stageMode=true;$.ajax({url:returningUserForm.action,contentType:"text/plain",data:_sendData}).success(function(response){if(response.state==="unknown_user"){NGX.App.Events.trigger("form:returninguser:unknownuser");_totalSecondary+=renderMultiOptins(ngxMultiOptIns,"xCampaignForm")||0;showMainForm()}else if(response.state===
"success"){NGX.App.Events.trigger("form:returninguser:remembered");if(response.url){_redirectUrl=getRedirectURL(response.url,response.entry);window.location=_redirectUrl}}else if(response.state==="known_user"){NGX.App.Events.trigger("form:returninguser:remembered");NGX.App.state.currentUser.remembered=true;_totalSecondary+=renderMultiOptins(ngxMultiOptIns,"xSecondaryForm")||0;if(!$("[name=email]","#xSecondaryForm").length>0)NGX.App.api.setFormField("email",response.key.substring(6),"hidden","xSecondaryForm");
NGX.App.api.setFormField("ngx_remember_me","true","hidden","xSecondaryForm");if(_totalSecondary>0){NGX.App.Events.trigger("form:secondary:show");showMainForm("xSecondaryForm")}else $("#xSecondaryForm").submit()}else if(response.state==="already_entered"){NGX.App.Events.trigger("form:returninguser:alreadyentered");NGX.overlay.create({type:"modal",template:NGX.App.api.getTemplate("inviteModal"),content:{title:NGX.lang.get("form.returningUser.entered.title"),msg:NGX.lang.get("form.returningUser.entered.msg"),
closeBtnText:NGX.lang.get("buttons.overlayClose")}})}}).fail(function(response){NGX.overlay.create({type:"modal",template:NGX.App.api.getTemplate("inviteModal"),content:{title:NGX.lang.get("form.returningUser.failed.title"),msg:NGX.lang.get("form.returningUser.failed.msg"),closeBtnText:NGX.lang.get("buttons.overlayClose")},onclose:showMainForm})})}}
function sendToFriends(){var sendToFriendForm=document.getElementById("xSendToFriendForm"),emailAddresses=sendToFriendForm.querySelectorAll(".textField"),emailString,ajaxData={url:sendToFriendForm.action,type:"post"},failureConfig={type:"modal",template:NGX.App.api.getTemplate("inviteModal"),content:{title:NGX.lang.get("sendToAFriend.error.title"),msg:NGX.lang.get("sendToAFriend.error.msg"),closeBtnText:NGX.lang.get("buttons.overlayClose")}};var getEmailAddressString=function(emailAddresses){var addresses=
[],max=10;if(emailAddresses.length===1){var emlVal=emailAddresses[0].value;max=emailAddresses[0].getAttribute("data-ngx-max");addresses=emlVal.split(",");addresses=addresses.slice(0,max)}else _.each(emailAddresses,function(email){if(email&&email.value)addresses.push(email.value)});return addresses.join(",")};emailString=getEmailAddressString(emailAddresses);ajaxData.data={async:true,campaignId:NGX.App.config.id,apikey:NGX.context.apikey,sendToAFriend_to:emailString,sendToAFriend_subject:sendToFriendForm.getAttribute("data-ngx-subject")||
NGX.lang.get("sendToAFriend.subject")};if(emailString.length>0)$.ajax(ajaxData).success(function(response){var _content=response.content[0];if(_content.scheduled)NGX.overlay.create({type:"modal",template:NGX.App.api.getTemplate("inviteModal"),content:{title:NGX.lang.get("sendToAFriend.success.title"),msg:NGX.lang.get("sendToAFriend.success.msg"),closeBtnText:NGX.lang.get("buttons.overlayClose")}});else NGX.overlay.create(failureConfig)}).fail(function(response){NGX.overlay.create(failureConfig)});
else NGX.overlay.create(failureConfig)}
var countryCheck=function(el){var $el=$(el),$fieldWrap=$el.parents(".xFieldItem");$el.attr("data-ngx-touched","true");if($fieldWrap.hasClass("xFormatAddressUs")){var $stateControl=$('[name="'+$fieldWrap.attr("data-ngx-control")+'_State"]',$fieldWrap),setStateVal=function(val){if($stateControl.hasClass("selectized")){$stateControl=$stateControl.selectize()[0].selectize;$stateControl.setValue(val)}else $stateControl.val(val)};if($el.val()!=="USA")setStateVal("OTHER");else if($stateControl.val()=="OTHER")setStateVal("")}else $el.parents("form").parsley("validate")};
var getStorageKey=function(cfg){var skey=[cfg.filterScope==="campaign"?NGX.App.config.id:NGX.App.config.tenant,cfg.controlName];var _rememberEmail=document.getElementById("xReturningUserEmail");if(_rememberEmail&&_rememberEmail.value)skey.unshift(NGX.Util.hashCode(_rememberEmail.value));return NGX.StorageManager.getKey(skey)};
function renderMultiOptins(config,formId){if(config.length==0)return;var m=0,l=config.length,$el,templateMIO=NGX.App.api.getTemplate("forms/multiOptins"),totalOptins=0,theFormID=formId||"xCampaignForm",hideExistingOptins=function(cfg){var storageKey=getStorageKey(cfg),existingOptinString=NGX.StorageManager.get(storageKey);if(existingOptinString.length>0)try{var newOpts=[],existingOptins=JSON.parse(existingOptinString);_.each(cfg.options,function(el,idx){if(!_.contains(existingOptins,el.value))newOpts.push(el)});
cfg.options=newOpts}catch(e){v4.debug("Progressive MultiOptins: Could not parse localStorage/cookie for existing signups, returning all items",1)}return cfg},onlyShowTodaysOptions=function(cfg){var browserOffsetFromUTC=moment().zone()/60,campaignOffsetFromUTC=parseInt(NGX.App.config.timezoneOffset)||0,totalOffsetHours=browserOffsetFromUTC+campaignOffsetFromUTC;var today=moment().add(totalOffsetHours,"hours").format("dddd").toLowerCase();v4.debug("Progressive MultiOptins: The current day at the campaign's timezone is: "+
today+".",5);try{var newOpts=[];_.each(cfg.options,function(el,idx){if(el.daysShown.indexOf(today)>-1)newOpts.push(el)});cfg.options=newOpts}catch(e){v4.debug("Progressive MultiOptins: Could not filter out options from non-today days.",1)}return cfg},skipOptinFilter=function(cfg){if(!document.getElementById("xReturningUserForm"))return false;if(!cfg.skipDaysFilter)return false;var storageKey=getStorageKey(cfg),storageVal=NGX.StorageManager.get(storageKey);return storageVal||NGX.App.state.currentUser.remembered?
false:true};for(;m<l;m++){var currConf=config[m],_skipOptinFilter=skipOptinFilter(currConf);if(currConf.daysFilter&&!_skipOptinFilter)currConf=onlyShowTodaysOptions(currConf);if(currConf.userFilter&&!_skipOptinFilter)currConf=hideExistingOptins(currConf);if(currConf.options.length>0){var uniConfig={idPrefix:"xForm",checkboxClass:"xCheckbox",checkedClass:"xChecked",focusClass:"xFocus",disabledClass:"xDisabled",activeClass:"xActive",hoverClass:"xHover"};if(theFormID==="xCampaignForm"){$el=$("#"+currConf.controlId+
"Wrapper","#"+theFormID);$el.html(templateMIO(currConf));$(".checkField",$el).uniform(uniConfig)}else if(theFormID==="xSecondaryForm"&&$(".xSecondaryForm").length>0){$el=$("#Secondary_"+currConf.controlId+"Wrapper");$el.html(templateMIO(currConf));$(".checkField",$el).uniform(uniConfig);totalOptins+=currConf.options.length}}currConf.rendered=true}$("form").on("change","[data-ngx-checkall]",function(e){var $el=$(e.currentTarget),$parent=$el.parents(".xFieldContainer"),targ=$el.attr("data-ngx-checkall"),
checked=e.currentTarget.checked?"checked":false,boxes=$("[name="+targ+"]",$parent);for(var i=0,n=boxes.length;i<n;i++)boxes[i].checked=checked;$.uniform.update()});return totalOptins||0}
NGX.App.Events.on("page:ready",function(){$("[type=file]").change(function(e){var filename=null,fieldEl=$(this);if(fieldEl&&fieldEl.attr("type")=="file"){if(!(window.FileReader&&window.File))filename=fieldEl.get(0).value||null;else{var theFile=fieldEl.get(0).files[0];filename=theFile?theFile.name:null}fieldEl.attr("data-parsley-value",filename)}})});
NGX.uiFlow=function(d,Events,$,_){var config={wrapper:".xFormPages",module:".xComponent",next:".xActionNext",prev:".xActionPrevious",disable:"xDisabled",progress:".xMetaProgressBar",progressPage:".xProgressPage",validate:false,plugin:{timeout:0,allowWrap:false,slides:"div.xFormPage",log:false,fx:"ScrollVert",pauseOnHover:true,pagerTemplate:'<li class="xPagerIcon"><span></span></li>',pagerActiveClass:"activeSlide"}},flowCache={},flowCount=0,Flow=function(el,options){_.extend(this,options);this.config=
$.extend(true,{},config,this.config);this.fid=++flowCount;this.form=el;this.$form=$(this.form);this.formId=el.id;this.$el=$(this.config.wrapper,this.form);this.$module=this.$el.parents(this.config.module);this.model=NGX.App.Components.get(this.$module.attr("id"));this.percent=0;this.$progressBar=this.$module.find(config.progress);this.$progressPage=this.$module.find(config.progressPage);this.form.setAttribute("data-flow",this.fid);initCycle2.call(this);updateUI.call(this);if(this.config.plugin.autoHeight===
"container"&&this.model)this.model.on("change:viewed",function(){autoSize.call(this)},this);return this},autoSize=function(){var height=$(".cycle-slide-active",this.$el).outerHeight();this.$el.height(height+"px");return height},initCycle2=function(){this.$el.cycle(this.config.plugin).on("cycle-after",$.proxy(function(event,optionHash,outgoingSlideEl,incomingSlideEl,forwardFlag){updateUI.call(this);Events.trigger("flow:after",this,event,optionHash,outgoingSlideEl,incomingSlideEl,forwardFlag);Events.trigger("flow:after:"+
this.formId,this,event,optionHash,outgoingSlideEl,incomingSlideEl,forwardFlag)},this));this.length=this.$el.data("cycle.opts").slideCount;Events.trigger("flow:ready",this)},updateUI=function(){var cnf=this.config,add="addClass",rem="removeClass",$d,$m,pos;if(!cnf.plugin.allowWrap){$d=this.$el.data("cycle.opts");$m=this.$module;$m.find(cnf.prev)[$d.currSlide===0?add:rem](cnf.disable);$m.find(cnf.next)[$d.currSlide+1>=$d.slideCount?add:rem](cnf.disable);this.$progressPage.text($d.currSlide+1);pos=parseInt(($d.currSlide+
1)/this.length*100);if(typeof pos==="number"){this.percent=pos;this.$progressBar.attr("data-ngx-progress",pos).css("width",pos+"%")}}},getFlowById=function(id){return flowCache[id]||false},createFlow=function(id,options){var el=d.getElementById(id),evtTrigger=function(e,method,id){e.stopPropagation();NGX.App.Events.trigger("flow:"+method,id);NGX.App.Events.trigger("navigate:"+method,id)},flow;if(el){flow=el.hasAttribute("data-flow")?getFlowById(id):flowCache[id]=new Flow(el,options);flow.$form.on("click",
config.next,function(e){if(!$(this).hasClass("xDisabled"))evtTrigger(e,"next",id)}).on("click",config.prev,function(e){if(!$(this).hasClass("xDisabled"))evtTrigger(e,"prev",id)});return flow}return false},triggerTransition=function(id,fn){var obj=getFlowById(id),objConf,method;if(obj&&_.isFunction(obj[fn])){objConf=obj.config;method=function(){obj[fn].call(obj)};if(_.isFunction(objConf.validate))switch(objConf.validate.call(obj,fn)){case true:if(_.isFunction(objConf.success))objConf.success.call(obj,
method);else method();break;case false:if(_.isFunction(objConf.fail))objConf.fail.call(obj,method);break;default:return false}else method()}};Flow.prototype.goto=function(indx){this.$el.cycle("goto",indx)};Flow.prototype.next=function(){if(this.config.validate===true){if(NGX.App.api.formValidate()===true)this.$el.cycle("next")}else this.$el.cycle("next")};Flow.prototype.prev=function(){this.$el.cycle("prev")};Flow.prototype.autosize=function(){autoSize.call(this)};Flow.prototype.destroy=function(){this.form.removeAttribute("data-flow");
this.$el.cycle("destroy");delete flowCache[this.formId]};Events.on({"flow:next":function(id){triggerTransition(id,"next")},"flow:prev":function(id){triggerTransition(id,"prev")}});$.fn.cycle.transitions.scrollVert={before:function(opts,curr,next,fwd){opts.API.stackSlides(curr,next,fwd);var w=opts.container.css("overflow","hidden").addClass("xTransitioning").width();opts.cssBefore={top:fwd?w:-w,left:0,opacity:1,display:"block"};opts.cssAfter={zIndex:opts._maxZ-2,top:0};opts.animIn={top:0};opts.animOut=
{top:fwd?-w:w}},after:function(opts){opts.container.removeClass("xTransitioning")}};$.fn.cycle.transitions.scrollHorz={before:function(opts,curr,next,fwd){opts.API.stackSlides(curr,next,fwd);var w=opts.container.css("overflow","hidden").addClass("xTransitioning").width();opts.cssBefore={left:fwd?w:-w,top:0,opacity:1,display:"block"};opts.cssAfter={zIndex:opts._maxZ-2,left:0};opts.animIn={left:0};opts.animOut={left:fwd?-w:w}},after:function(opts){opts.container.removeClass("xTransitioning")}};$.fn.cycle.transitions.ScrollHorz=
$.fn.cycle.transitions.scrollHorz;$.fn.cycle.transitions.ScrollUp=$.fn.cycle.transitions.scrollVert;$.fn.cycle.transitions.ScrollVert=$.fn.cycle.transitions.scrollVert;return{create:createFlow,get:getFlowById}}(document,NGX.App.Events,$,_);
NGX.Util=function(w,d,$,_,undefined){var $body=$("body"),$window=$(w);return{hashCode:function(string){return CryptoJS.MD5(string).toString()},assetFromRef:function(assetRef){if(typeof assetRef=="string"&&assetRef.indexOf(":")>-1){var assetRefParts=assetRef.split(":");if(assetRefParts.length>4)assetRefParts[3]=_.rest(assetRefParts,3).join(":");var src;if(assetRefParts[0]=="asset")src=NGX.context.assetUrl+assetRefParts[3];else if(assetRefParts[0]=="ugc")src=NGX.context.ugcAssetPath+assetRefParts[3];
else src=assetRefParts[3]||"";return{type:assetRefParts[0],assetType:assetRefParts[1],size:function(s){var sArr=s.split("x");return{width:sArr[0]||0,height:sArr[1]||0}}(assetRefParts[2]||""),path:assetRefParts[3],src:src}}return false},fbLogin:function(callback,options){var perms=NGX.App.config.permissionRequest;if(perms&&perms.timing.indexOf(options.timing)>-1||options.timing==="now")FB.getLoginStatus(function(response){if(response.status==="connected"&&(perms.scope===""||options.scope===""))callback.apply(response,
arguments);else FB.login(function(response){if(response.status==="connected"&&NGX.App.state){NGX.App.state.currentUser=NGX.App.state.currentUser||{};NGX.App.state.currentUser.userSession=response}if(typeof callback==="function")callback.apply(response,arguments)},{scope:perms.scope})});else if(typeof callback==="function")if(options.timing=="init")FB.getLoginStatus(function(response){callback.apply(response,arguments)});else callback.apply(arguments)},resizeCanvas:function(opt){if(FB&&!NGX.context.isPreview){var defaults=
{strategy:"auto",height:800},options=_.extend(defaults,opt);switch(options.strategy){case "auto":FB.Canvas.setAutoGrow(true);FB.Canvas.setSize({height:480});break;case "explicit":FB.Canvas.setSize({height:options.height});break;case "calculate":$window.load(function(){var height=$body.outerHeight(true)+20>options.height?$body.outerHeight(true)+20:options.height;FB.Canvas.setSize({height:height})});break;default:FB.Canvas.setAutoGrow(true);break}}},getRefCookie:function(config){var i,x,y,ARRcookies=
document.cookie.split(";");if(config.c_name)for(i=0;i<ARRcookies.length;i++){x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);x=x.replace(/^\s+|\s+$/g,"");if(x==config.c_name)return encodeURIComponent(y)}return false},addRefCookie:function(config){var i,x,y,outLink="",ARRcookies=document.cookie.split(";");if(config.link){outLink=config.link;for(i=0;i<ARRcookies.length;i++){x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+
1);x=x.replace(/^\s+|\s+$/g,"");if(x==config.c_name)if(config.useAppData||config.link.indexOf("?sk=app_")!=-1)if(config.link.indexOf("app_data")!=-1)outLink+=encodeURIComponent("&r="+y);else outLink+="&app_data="+encodeURIComponent("r="+y);else outLink+=config.link.indexOf("?")!=-1?"&r="+y:"?r="+y}return outLink}},createCORSRequest:function(method,url){var xhr=new XMLHttpRequest;if("withCredentials"in xhr)xhr.open(method,url,true);else if(typeof XDomainRequest!="undefined"){xhr=new XDomainRequest;
xhr.open(method,url)}else xhr=null;return xhr},initialiseCountdown:function(config){var untilDate=new Date(config.date);$(config.countdown).countdown({until:untilDate,layout:config.layout?config.layout:'{d<} <span id="daysWrapper"><span class="countdownValue" id="daysValue">{dn}</span><span class="countdownLabel" id="daysLabel">{dl}</span></span>{d>} {h<}<span id="hoursWrapper"><span class="countdownValue" id="hoursValue">{hn}</span><span class="countdownLabel" id="hoursLabel">{hl}</span></span>{h>} {m<} <span id="minutesWrapper"><span class="countdownValue" id="minutesValue">{mnn}</span><span class="countdownLabel" id="minutesLabel">{ml}</span></span>{m>} {s<}<span id="secondsWrapper"><span class="countdownValue" id="secondsValue">{snn}</span><span class="countdownLabel" id="secondsLabel">{sl}</span></span>{s>}',
compact:true,compactLabels:config.compactLabels?config.compactLabels:["y","m","w","d","h","m","s"],onExpiry:function(){NGX.Util.expireCountdown(config)},onTick:NGX.Util.watchCountdown,alwaysExpire:true,format:config.format?config.format:"dhmS"})},expireCountdown:function(config){if(config.type=="prelaunch")document.location.href=config.expiryURL;$(this).parent().removeClass("lastWeek").removeClass("lastDay").removeClass("lastHour").removeClass("lastMinute").addClass("expired")},watchQuizCountdown:function(periods){if(periods[5]==
0&&periods[6]<=5)$(this).addClass("lastFewSeconds");else $(this).removeClass("lastFewSeconds")},watchCountdown:function(periods){if(periods[0]==0&&periods[1]==0&&periods[2]==0&&periods[3]<7)$(this).parent().removeClass("lastDay").removeClass("lastHour").removeClass("lastMinute").addClass("lastWeek");if(periods[0]==0&&periods[1]==0&&periods[2]==0&&periods[3]==0&&periods[4]<=24)$(this).parent().removeClass("lastWeek").removeClass("lastHour").removeClass("lastMinute").addClass("lastDay");if(periods[0]==
0&&periods[1]==0&&periods[2]==0&&periods[3]==0&&periods[4]==0&&periods[5]<=60)$(this).parent().removeClass("lastWeek").removeClass("lastDay").removeClass("lastMinute").addClass("lastHour");if(periods[0]==0&&periods[1]==0&&periods[2]==0&&periods[3]==0&&periods[4]==0&&periods[5]==0&&periods[6]<=60)$(this).parent().removeClass("lastWeek").removeClass("lastDay").removeClass("lastHour").addClass("lastMinute")}}}(this,document,$,_);
NGX.video=function(w,$){var config={template:{iframe:'<iframe id="player_{{id}}" src="//{{host}}/{{id}}" data-videoName="{{name}}" class="{{style}} {{cdn}}" width="{{width}}" height="{{height}}" {{attribs}}></iframe>'},platform:{fb:"www.facebook.com/v",vimeo:"player.vimeo.com/video",youtube:"www.youtube.com/embed"},defaults:{style:"xVideoOverlayIframe",height:"100%",width:"100%",attribs:'frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen'}},Collection=function(){this.list=[]},
Video=function(self,obj){var _self=this;_.extend(this,config.defaults,obj);this.indx=players.list.length;this.host=config.platform[this.cdn]||config.platform.youtube;this.template=Handlebars.compile(config.template.iframe);this.html=this.template(this);if(this.targ){var thePlayer=this.el.id+"_player";$("#"+thePlayer).on("click",function(e){if(obj.before)obj.before.call(this,e);$(_self.targ).html(_self.html);if(obj.after)obj.after.call(this,e)})}else this.el.innerHTML=this.html;this.el.setAttribute("data-index",
this.indx)},players=new Collection;Collection.prototype.push=function(el,obj){var domEl=el||obj.el;if(!domEl.nodeName)domEl=$(domEl)[0];if(domEl.nodeName&&!domEl.getAttribute("data-indx")){obj.el=domEl;if(this.list)return this.list.push(new Video(domEl,obj))}return false};return{create:function(el,obj){if(el&&obj.constructor===Object)players.push(el,obj)},getYoutubeVideoId:function(path){var patt=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/i;try{return patt.exec(path)[1]}catch(e){return""}}}}(this,
$);
NGX.videoEvents=function(w,d,$,undefined){var _eventsObj,players=[],VideoEvents=function(){function processCache(){for(var frameId in players)_eventsObj.addPlayer(players[frameId])}(function(){var ytScript=document.createElement("script");ytScript.src=(location.protocol=="https:"?"https":"http")+"://www.youtube.com/player_api";var before=document.getElementsByTagName("script")[0];before.parentNode.insertBefore(ytScript,before)})();window.onYouTubePlayerAPIReady=function(){_eventsObj._initialised=true;
processCache()};return _eventsObj},Player=function(frameId){return _eventsObj.addPlayer(frameId)},initEventTracker=function(){if(!_eventsObj)_eventsObj=new VideoEvents},createFrameListener=function(frameId){var playerObj={},suppliers={youtube:function(frameEl){return(frameEl&&frameEl.src?frameEl.src:"").indexOf("youtu")>0}(document.getElementById(frameId))};if(suppliers.youtube){playerObj=new Player(frameId);return playerObj}},listenToFrame=function(frameId){if(frameId&&d.getElementById(frameId))if(_eventsObj&&
_eventsObj._initialised===true){var obj=createFrameListener(frameId);return obj}else{players.push(frameId);initEventTracker()}};VideoEvents.prototype.addPlayer=function(frameId){var ytTimer,timerId,player,notYetStarted=true;var opts=_.extend({frameId:frameId},this);function YTProgressTimer(callback,delay){this.clear=function(){window.clearInterval(timerId)};this.start=function(){timerId=window.setInterval(callback,delay)}}function getYoutubeVideoId(path){var patt=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/i;
try{return patt.exec(path)[1]}catch(e){return""}}function getVideoName(){return document.getElementById(opts.frameId).getAttribute("data-videoName")||opts.videoId}function onPlayerReady(){opts.videoId=getYoutubeVideoId(player.getVideoUrl());opts.videoName=opts.videoName||getVideoName();opts.duration=player.getDuration();opts.chunkYetElapsed={threequarter:opts.duration/4*3,half:opts.duration/2,quarter:opts.duration/4}}function onPlayerStateChange(event){switch(event.data){case YT.PlayerState.PAUSED:$.event.trigger({type:"ytplayerapi:pause",
videoId:opts.videoId,videoName:opts.videoName});break;case YT.PlayerState.PLAYING:if(notYetStarted===true){$.event.trigger({type:"ytplayerapi:begin",videoId:opts.videoId,videoName:opts.videoName});notYetStarted=false}else $.event.trigger({type:"ytplayerapi:play",videoId:opts.videoId,videoName:opts.videoName});break;case YT.PlayerState.ENDED:$.event.trigger({type:"ytplayerapi:end",videoId:opts.videoId,videoName:opts.videoName});break}}ytTimer=new YTProgressTimer(function(){var curTime=player.getCurrentTime();
for(var chunk in opts.chunkYetElapsed)if(opts.chunkYetElapsed[chunk]&&curTime>opts.chunkYetElapsed[chunk]){opts.chunkYetElapsed[chunk]=null;$.event.trigger({type:"ytplayerapi:"+chunk,videoId:opts.videoId,videoName:opts.videoName})}},2E3);$(document).on({"ytplayerapi:pause":function(evt){ytTimer.clear()},"ytplayerapi:begin":function(evt){ytTimer.start()},"ytplayerapi:play":function(evt){ytTimer.start()}});player=new YT.Player(opts.frameId,{events:{"onReady":onPlayerReady,"onStateChange":onPlayerStateChange}});
return player};return{listen:listenToFrame,init:initEventTracker}}(this,document,$);
NGX.OAuth=function(w,d,$,_,undefined){var _cntxt=NGX.context;var initialize=function(key){OAuth.initialize(key);OAuth.setOAuthdURL(_cntxt.oauthServerURL)},supportsPopup=function(){return!v4.isChromeIOS()},supportsRedirect=function(){return v4.isChromeIOS()},storeUserDetails=function(network,data){var userData={};function getId(){if(data.path_alias)return data.path_alias;else return data.id}function getSourceName(){return data.source_name||null}function getUsername(){if(_.isObject(data.username))data.alias=
data.username._content;return data.alias||data.username}function getName(){if(_.isObject(data.realname)&&data.realname._content)data.fullname=data.realname._content;else if(_.isObject(data.username)&&data.username._content)data.fullname=data.username._content;else if(data.firstname&&data.lastname)data.fullname=data.firstname+" "+data.lastname;return data.fullname||data.full_name||data.name||""}userData[network]={id:getId(),email:data.email,sourceName:getSourceName(),name:getName()};_.extend(NGX.App.state.currentUser,
userData);return userData[network]},identify=function(result,opts){var _network=opts.network||"twitter",_callback=opts.callback||function(){},_onError=opts.onError||function(){},_cache=opts.cache||false;var successFn=function(data){var _userData=storeUserDetails(_network,data);_callback.call(this,_userData,result)},failureFn=function(msg){v4.debug(msg,1);_onError.call(this,result)};var networkIDs={instagram:function(){if(result.user)successFn.call(this,result.user);else failureFn.call(this)},flickr:function(){var _restBase=
"https://api.flickr.com/services/rest/?format=rest&nojsoncallback=1";result.get(v4.updateQueryString({method:"flickr.test.login"},false,_restBase)).done(function(_rslt){result.get(v4.updateQueryString({method:"flickr.people.getInfo",user_id:_rslt.user.id},false,_restBase)).done(function(_fullResult){successFn.call(this,_fullResult.person)})}).fail(function(){failureFn.call(this)})},youtube:function(){var _restBase="https://gdata.youtube.com/feeds/api/users/default?alt=json";result.get(v4.updateQueryString({fields:"yt:username,yt:googlePlusUserId,yt:firstName,yt:lastName",
nocache:Math.random()},false,_restBase)).done(function(_rslt){var user={"source_name":_.isObject(_rslt.entry["yt$username"])?_rslt.entry["yt$username"]["$t"]:"","firstname":_.isObject(_rslt.entry["yt$firstName"])?_rslt.entry["yt$firstName"]["$t"]:"","lastname":_.isObject(_rslt.entry["yt$lastName"])?_rslt.entry["yt$lastName"]["$t"]:"","id":_.isObject(_rslt.entry["yt$googlePlusUserId"])?_rslt.entry["yt$googlePlusUserId"]["$t"]:""};successFn.call(this,user)})},"default":function(){result.me().done(successFn).fail(failureFn)}};
if(!result)v4.debug("OAuth.identify called before user logged in");else{var mthd="function"===typeof networkIDs[_network]?_network:"default";networkIDs[mthd].call(this)}},oauthLogin=function(opts){var _network=opts.network||"twitter",_onError=opts.onError||function(){},_cache=opts.cache||false;var successFn=function(result){identify.call(this,result,opts)},failureFn=function(result){_onError.call(this,result)};if(supportsPopup())OAuth.popup(_network,{cache:_cache}).done(successFn).fail(failureFn);
else if(supportsRedirect())OAuth.redirect(_network,v4.updateQueryString({callback:_network},true,document.location.href))};return{init:initialize,login:oauthLogin,storeUser:storeUserDetails}}(window,document,jQuery,_);
var Insights=function(w,d,$,undefined){var conf=NGX.App.config,cntx=NGX.context,state=NGX.App.state;var eventBus,defaults,optional,alias={"e":{"view":"v","share":"s","retweet":"s","invite":"i","conversion":"g","referral":"r","click":"ct","consume":"c","vote":"vo","network":"n","x":"x","comment":"cm","reply":"cm","like":"lk","favorite":"lk","upvote":"lk","plusone":"lk","redirect":"a"},"o":{"campaign":"c","display":"d","promo":"p","likeGate":"g","secondaryCta":"s","promotionDetails":"pd","media":"m",
"channel":"ch","medium":"med","source":"src","link":"link","details":"dt","contentitem":"ci","entries":"ci","x":"x"}},rules={"v":{"c":["c","i","dc","h"],"d":["dc","h"],"p":["c","p","dc","h"],"g":["dc","h"],"ch":["h"],"ci":["c","h","dc","i"]},"ct":{"p":["c","p","dc","h"],"s":["c","p","dc","h"],"ci":["c","dc","h","link"]},"i":{"c":["c","p","dc","h"]},"s":{"c":["c","p","dc","h"],"ci":["c","dc","h","a","i"]},"lk":{"ci":["ci","c","dc","h","a"]},"cm":{"ci":["ci","c","dc","h","a"]},"a":{"ci":["c","i","h",
"link"]}},Bus=function(id){this.id=id;this.url=NGX.App.config.insightUrl+"/track.ngx?";this.delay=200;_.extend(this,Backbone.Events);return this},buildQueryString=function(params){var obj=$.extend({},defaults,params),qs="",prop,propVal,noCache="&"+Math.floor(Math.random()*1E4),userName="Anonymous";obj.u=NGX.App.state.currentUser.userProfile?NGX.App.state.currentUser.userProfile.name||userName:userName;for(prop in obj)if(obj.hasOwnProperty(prop)&&(propVal=obj[prop]))if(/(string|number)/.test(typeof propVal))qs+=
prop+"="+encodeURIComponent(propVal)+"&";return(/&$/.test(qs)?qs.substring(0,qs.length-1):qs)+noCache},paramsValMap=function(params){var obj={},nameMap=function(a,b){if(params[a]){obj[b]=alias[b][params[a]];delete params[a]}return obj[b]},paramsRequired=function(e,o){var req=rules[e]?rules[e][o]:[],item,i=0,len=req?req.length:0;for(;i<len;i++){if(item=req[i])obj[item]=optional[item];item=false}};paramsRequired(nameMap("event","e"),nameMap("object","o"));return $.extend(obj,params)},linkClick=function(e){var el=
e.currentTarget,href=el.getAttribute("href"),targ=el.getAttribute("target"),clss=el.getAttribute("class"),action=el.getAttribute("data-ngx-action"),openInTarg=function(targ){var targStr;if(targ){targStr=(targ[0]==="_"?targ.substring(1):targ).toLowerCase();if(targStr==="blank"){var win=w.open(href,targ);if(win)win.focus();return false}else if(w[targStr]){w[targStr].location.href=href;return false}}w.location.href=href;return false};if(!!href&&href[0]!=="#"&&action!=="route"){e.preventDefault();Insights.track("click:"+
(!!clss&&clss.indexOf("xCTA")?"secondaryCta":"link"),{"callback":function(){openInTarg(targ)}})}},tempImg=function(src){var img=d.createElement("img");img.setAttribute("src",src);return img},corsRequest=function(obj,callback){var request=NGX.Util.createCORSRequest("POST",conf.sharing.updateURL+"?"+$.param({ic:1,cID:conf.id,contentId:obj.i,apikey:cntx.apikey,fbid:state.currentUser.fbid,channelId:cntx.channel&&cntx.channel.id?cntx.channel.id:"",target:obj.target,source:obj.source,medium:obj.medium,
channel:obj.channel}));if(request){request.send();if("function"===typeof callback)callback.call(this)}},initialise=function(options){defaults=$.extend({},{"t":NGX.context.apikey,"channel":NGX.context.track.channel?NGX.context.track.channel:"","medium":NGX.context.track.medium?NGX.context.track.medium:"","source":NGX.context.track.source?NGX.context.track.source:""},options);optional={"dc":NGX.context.displayContainer?NGX.context.displayContainer.id:"","c":NGX.App.config?NGX.App.config.id:"","p":NGX.context.promotion?
NGX.context.promotion.id:"","h":NGX.context.channel?NGX.context.channel.id:""};eventBus=new Bus("ngxDefault");eventBus.registerEvents(["x:x","view:channel","view:campaign","view:display","view:promo","view:likeGate","view:secondaryCta","view:media","view:promotionDetails","view:contentitem","click:link","click:secondaryCta","click:promo","click:contentitem","consume:media","vote:campaign","vote:contentitem","retweet:contentitem","reply:contentitem","favorite:contentitem","share:display","share:contentitem",
"share:entries","share:promotion","invite:display","redirect:contentitem"],"track");eventBus.registerEvents(["share:campaign"],"trackShare");eventBus.registerEvents(["invite:campaign"],"trackInvite")};Bus.prototype.registerEvents=function(eventList,method){var i=0,len,cn;if(eventList){cn=eventList.constructor;if(cn===Array){len=eventList.length;for(;i<len;i++)this.on(eventList[i],this[method])}else if(cn===String)this.on(eventList,this[method])}};Bus.prototype.track=function(params,queued){var obj=
paramsValMap(params),qs=buildQueryString(obj);this.img=tempImg.call(this,this.url+qs);if(params.callback&&params.callback.constructor===Function)setTimeout(function(){params.callback(this.img)},this.delay)};Bus.prototype.trackShare=function(params,queued){var obj=$.extend({},defaults,paramsValMap(params));if(NGX.App.config.sharing.updateURL)corsRequest.call(this,obj,function(){if(params.callback&&params.callback.constructor===Function)setTimeout(function(){params.callback(this.img)},this.delay)});
else;};return{init:initialise,track:function(eventName,params){var evtObj=eventName.split(":"),paramObj={event:evtObj[0],object:evtObj[1]};eventBus.trigger(eventName,$.extend({},params,paramObj))},listen:function(eventName,fn){if(eventName&&fn.constructor===Function)eventBus.on(eventName,fn)},register:function(params){eventBus.registerEvents(params)}}}(this,document,$);
NGX.Virality=function(w,d,$,_,undefined){var $body=$("body"),$window=$(w),conf=NGX.App.config,cntx=NGX.context,state=NGX.App.state,facebook=function(){var inviteConfig={defaultMessage:"Invite Friends",failureDialog:{msg:NGX.lang.get("permissions.error.message"),title:NGX.lang.get("permissions.error.title"),closeBtnText:NGX.lang.get("buttons.overlayClose")},previewDialog:{title:"Preview Mode: Invite Dialog",msg:"When live, the Invite Friends tabs and buttons would display the Facebook Invite Dialog",
closeBtnText:NGX.lang.get("buttons.overlayClose")},inviteDialog:{title:"Invite friends",message:"Invite friends",helpText:"This dialog will invite friends by posting to their wall"}},inviteCallbackFn,inviteSubmit=function(data){var request;if(cntx.isPreview)data.preview=true;if(cntx.guid!=="")data.guid=cntx.guid;request=NGX.Util.createCORSRequest("POST",conf.invites.updateURL+"?"+$.param(data));if(request){request.onload=function(){if(typeof inviteCallbackFn==="function")inviteCallbackFn()};request.send()}},
inviteCallback=function(response){var friendsStr,friendsEl=d.getElementById("ngxInvitedFriends");if(response&&response.request){_.each(response.to,function(val){NGX.App.state.currentUser.invitedFriends.push(val)});friendsStr=state.currentUser.invitedFriends.join(",");if(friendsEl)friendsEl.value=friendsStr;inviteSubmit({ngxInvitedFriends:friendsStr,ic:response.to.length,cID:conf.id,apikey:cntx.apikey,fbid:state.currentUser.userSession.authResponse.userID,channelId:cntx.channel.id||"",source:cntx.track.source,
medium:cntx.track.medium,channel:cntx.track.channel})}},inviteDialog=function(response){var fbContext=NGX.context.fb,appConfig=NGX.App.config;if(response&&response.status==="connected"){var obj={message:appConfig.sharing.inviteText||inviteConfig.defaultMessage,max_recipients:conf.invites.maxInvites-state.currentUser.invitedFriends.length,exclude_ids:state.currentUser.invitedFriends,method:"apprequests",data:{url:cntx.smarturl||document.location.href,r:NGX.Util.getRefCookie({c_name:"ngx"})}};obj.data=
JSON.stringify(obj.data);FB.ui(obj,inviteCallback)}else{var inviteTemplate=NGX.App.api.getTemplate("inviteModal");if(inviteTemplate)NGX.overlay.create({type:"modal",template:inviteTemplate,content:{msg:NGX.lang.get("permissions.error.message"),title:NGX.lang.get("permissions.error.title"),closeBtnText:NGX.lang.get("buttons.overlayClose")}})}},inviteInit=function(options,callback){$.extend(inviteConfig,options);inviteCallbackFn=callback;NGX.Util.fbLogin(inviteDialog,{timing:"submit"})};return{invite:inviteInit,
inviteCallback:inviteDialog}}();return{facebookShare:function(config){if(NGX.App.state.fbLoaded){var uiConfig={method:"feed",name:config.name,"link":NGX.Util.addRefCookie({link:config.link,c_name:"ngx"}),source:config.picture,caption:config.caption,description:config.description};if(config.noAction===true||config.actionLink&&config.actionLink!==""&&(config.actionText&&config.actionText!=""))uiConfig.actions={"name":config.actionText,"link":NGX.Util.addRefCookie({link:config.link?config.link:config.actionlink,
c_name:"ngx"})};FB.login(function(response){if(!response||response.status=="not_authorized"){var errorTemplate=NGX.App.api.getTemplate("inviteModal");if(errorTemplate)NGX.overlay.create({type:"modal",template:errorTemplate,content:{msg:NGX.lang.get("permissions.error.message"),title:NGX.lang.get("permissions.error.title"),closeBtnText:NGX.lang.get("buttons.overlayClose")}})}else FB.ui(uiConfig,function(response){if(response&&response.post_id);})})}},twitterInit:function(config){return true},twitterShare:function(config){},
inviteFBFriends:facebook.invite,inviteFBDialog:facebook.inviteCallback}}(this,document,$,_);function exists(selectorResult){return selectorResult.length!==0}
function prepareTooltip(ttApi){var sourceName=$(ttApi.getTrigger()).data("ngxsourcename");var sourceLink=$(ttApi.getTrigger()).data("ngxsourcelink");var tip=ttApi.getTip();if(exists($("div.textWrapper",tip)))return;var content=tip.text();tip.contents().filter(function(){return this.nodeType==3}).remove();var nameDiv=sourceName===""?"":$("<div/>").addClass("sourceName").append(sourceName);var hr=sourceName===""?"":$("<hr/>").addClass("fadeLine");var contentDiv=$("<div/>").addClass("mainContent").append(content);
$("<div/>").addClass("textWrapper").append(nameDiv).append(hr).append(contentDiv).prependTo(tip);if(sourceLink!=="")$(tip).click(function(){window.open(sourceLink);return false})}
function textElision(ttApi){var tip=ttApi.getTip();var trigger=ttApi.getTrigger();$(tip).css("visibility","hidden");$(trigger).css("filter","alpha(opacity=100)").css("-moz-opacity","1").css("-khtml-opacity","1").css("opacity","1");var tipHeight=tip.height();while($("div.textWrapper",tip).outerHeight()>tipHeight)$("div.mainContent",tip).text(function(index,text){var charCheck=text.match(/\s/)!=null;if(charCheck)return text.replace(/\W{0,3}\s(\S)*$/,"...");else return text.substring(0,text.length-1).replace(/.{3}$/,
"...")});$(tip).css("visibility","visible")}function hideTooltip(ttApi){$(ttApi.getTrigger()).css("filter","alpha(opacity=70)").css("-moz-opacity","0.70").css("-khtml-opacity","0.70").css("opacity","0.70")}
(function(a){a.tools=a.tools||{version:"v1.2.7"},a.tools.tooltip={conf:{effect:"toggle",fadeOutSpeed:"fast",predelay:0,delay:30,opacity:1,tip:0,fadeIE:!1,position:["top","center"],offset:[0,0],relative:!1,cancelDefault:!0,events:{def:"mouseenter,mouseleave",input:"focus,blur",widget:"focus mouseenter,blur mouseleave",tooltip:"mouseenter,mouseleave"},layout:"<div/>",tipClass:"tooltip"},addEffect:function(a,c,d){b[a]=[c,d]}};var b={toggle:[function(a){var b=this.getConf(),c=this.getTip(),d=b.opacity;
d<1&&c.css({opacity:d}),c.show(),a.call()},function(a){this.getTip().hide(),a.call()}],fade:[function(b){var c=this.getConf();!a.browser.msie||c.fadeIE?this.getTip().fadeTo(c.fadeInSpeed,c.opacity,b):(this.getTip().show(),b())},function(b){var c=this.getConf();!a.browser.msie||c.fadeIE?this.getTip().fadeOut(c.fadeOutSpeed,b):(this.getTip().hide(),b())}]};function c(b,c,d){var e=d.relative?b.position().top:b.offset().top,f=d.relative?b.position().left:b.offset().left,g=d.position[0];e-=c.outerHeight()-
d.offset[0],f+=b.outerWidth()+d.offset[1],/iPad/i.test(navigator.userAgent)&&(e-=a(window).scrollTop());var h=c.outerHeight()+b.outerHeight();g=="center"&&(e+=h/2),g=="bottom"&&(e+=h),g=d.position[1];var i=c.outerWidth()+b.outerWidth();g=="center"&&(f-=i/2),g=="left"&&(f-=i);return{top:e,left:f}}function d(d,e){var f=this,g=d.add(f),h,i=0,j=0,k=d.attr("title"),l=d.attr("data-tooltip"),m=b[e.effect],n,o=d.is(":input"),p=o&&d.is(":checkbox, :radio, select, :button, :submit"),q=d.attr("type"),r=e.events[q]||
e.events[o?p?"widget":"input":"def"];if(!m)throw'Nonexistent effect "'+e.effect+'"';r=r.split(/,\s*/);if(r.length!=2)throw"Tooltip: bad events configuration for "+q;d.on(r[0],function(a){clearTimeout(i),e.predelay?j=setTimeout(function(){f.show(a)},e.predelay):f.show(a)}).on(r[1],function(a){clearTimeout(j),e.delay?i=setTimeout(function(){f.hide(a)},e.delay):f.hide(a)}),k&&e.cancelDefault&&(d.removeAttr("title"),d.data("title",k)),a.extend(f,{show:function(b){if(!h){l?h=a(l):e.tip?h=a(e.tip).eq(0):
k?h=a(e.layout).addClass(e.tipClass).appendTo(document.body).hide().append(k):(h=d.next(),h.length||(h=d.parent().next()));if(!h.length)throw"Cannot find tooltip for "+d;}if(f.isShown())return f;h.stop(!0,!0);var o=c(d,h,e);e.tip&&h.html(d.data("title")),b=a.Event(),b.type="onBeforeShow",g.trigger(b,[o]);if(b.isDefaultPrevented())return f;o=c(d,h,e),h.css({position:"absolute",top:o.top,left:o.left}),n=!0,m[0].call(f,function(){b.type="onShow",n="full",g.trigger(b)});var p=e.events.tooltip.split(/,\s*/);
h.data("__set")||(h.off(p[0]).on(p[0],function(){clearTimeout(i),clearTimeout(j)}),p[1]&&!d.is("input:not(:checkbox, :radio), textarea")&&h.off(p[1]).on(p[1],function(a){a.relatedTarget!=d[0]&&d.trigger(r[1].split(" ")[0])}),e.tip||h.data("__set",!0));return f},hide:function(c){if(!h||!f.isShown())return f;c=a.Event(),c.type="onBeforeHide",g.trigger(c);if(!c.isDefaultPrevented()){n=!1,b[e.effect][1].call(f,function(){c.type="onHide",g.trigger(c)});return f}},isShown:function(a){return a?n=="full":
n},getConf:function(){return e},getTip:function(){return h},getTrigger:function(){return d}}),a.each("onHide,onBeforeShow,onShow,onBeforeHide".split(","),function(b,c){a.isFunction(e[c])&&a(f).on(c,e[c]),f[c]=function(b){b&&a(f).on(c,b);return f}})}a.fn.tooltip=function(b){var c=this.data("tooltip");if(c)return c;b=a.extend(!0,{},a.tools.tooltip.conf,b),typeof b.position=="string"&&(b.position=b.position.split(/,?\s/)),this.each(function(){c=new d(a(this),b),a(this).data("tooltip",c)});return b.api?
c:this}})(jQuery);
(function(a){var b=a.tools.tooltip;b.dynamic={conf:{classNames:"top right bottom left"}};function c(b){var c=a(window),d=c.width()+c.scrollLeft(),e=c.height()+c.scrollTop();return[b.offset().top<=c.scrollTop(),d<=b.offset().left+b.width(),e<=b.offset().top+b.height(),c.scrollLeft()>=b.offset().left]}function d(a){var b=a.length;while(b--)if(a[b])return!1;return!0}a.fn.dynamic=function(e){typeof e=="number"&&(e={speed:e}),e=a.extend({},b.dynamic.conf,e);var f=a.extend(!0,{},e),g=e.classNames.split(/\s/),
h;this.each(function(){var b=a(this).tooltip().onBeforeShow(function(b,e){var i=this.getTip(),j=this.getConf();h||(h=[j.position[0],j.position[1],j.offset[0],j.offset[1],a.extend({},j)]),a.extend(j,h[4]),j.position=[h[0],h[1]],j.offset=[h[2],h[3]],i.css({visibility:"hidden",position:"absolute",top:e.top,left:e.left}).show();var k=a.extend(!0,{},f),l=c(i);if(!d(l)){l[2]&&(a.extend(j,k.top),j.position[0]="top",i.addClass(g[0])),l[3]&&(a.extend(j,k.right),j.position[1]="right",i.addClass(g[1])),l[0]&&
(a.extend(j,k.bottom),j.position[0]="bottom",i.addClass(g[2])),l[1]&&(a.extend(j,k.left),j.position[1]="left",i.addClass(g[3]));if(l[0]||l[2])j.offset[0]*=-1;if(l[1]||l[3])j.offset[1]*=-1}i.css({visibility:"visible"}).hide()});b.onBeforeShow(function(){var a=this.getConf(),b=this.getTip();setTimeout(function(){a.position=[h[0],h[1]],a.offset=[h[2],h[3]]},0)}),b.onHide(function(){var a=this.getTip();a.removeClass(e.classNames)}),ret=b});return e.api?ret:this}})(jQuery);
(function(){var SurveyResultModel,SurveyResultsList,ComponentView,SurveyResultView;SurveyResultModel=Backbone.Model.extend({defaults:{"id":"","label":"","embed":"","values":[]}});SurveyResultsList=Backbone.Collection.extend({url:"/display/survey/resultsForQuestion.json",model:SurveyResultModel,parse:function(response){if(response&&response.status=="ok")return response.content;return[]}});SurveyResultView=Backbone.View.extend({defaultOptions:{metricDivId:"",displayEmbed:false,animationDuration:1E3,
countDisplayType:"percent",minMetricWidthPercent:0},initialize:function(op){this.options=$.extend(true,{},this.defaultOptions,op.options)},render:function(){var surveyGraph=this.createGraph(this.model.toJSON(),this.options.displayEmbed);this.setElement(surveyGraph);return this},createGraph:function(metricData,displayEmbed){var metricsExtremes=this.getMetricExtremes(metricData),me=this,roundedPercentages=this.getRoundPercentages(metricData.values,metricsExtremes),surveyGraph;if(this.options.animationDuration&&
this.options.animationDuration>0){var itemGraphTemplate=NGX.App.api.getTemplate("metricItemGraph"),i,len;surveyGraph=$(me.createGraphHtml(metricData,metricsExtremes,0,displayEmbed));var animator=$("<div>");animator.css("opacity","0.0");animator.animate({opacity:1},{step:function(now){var graphs=$(".xFormMetricItemGraphWrapper",$(surveyGraph));len=graphs.length;for(i=0;i<len;i++){var mTempModel=me.computeMetricData(metricData.values[i],metricsExtremes,now*100,now==1?roundedPercentages[i]:0);$(graphs[i]).html(itemGraphTemplate(mTempModel))}},
complete:function(){animator.remove()},duration:me.options.animationDuration})}else surveyGraph=$(me.createGraphHtml(metricData,metricsExtremes,100,displayEmbed,roundedPercentages));return surveyGraph},createGraphHtml:function(metricData,metricsExtremes,animationPercent,displayEmbed,roundedPercentages){var metricsHtml="",i,m,metrics=metricData.values,len=metrics.length,componentTemplate=NGX.App.api.getTemplate("metricComponent"),metricTemplate=NGX.App.api.getTemplate("metricTemplate"),itemGraphTemplate=
NGX.App.api.getTemplate("metricItemGraph");for(i=0;i<len;i++){m=metrics[i];if(displayEmbed&&m.imageAssetRef)m.imageAssetUrl=m.imageAssetRef.split(":")[3];if(!(displayEmbed&&m.embedCode))delete m.embedCode;var mTempModel=this.computeMetricData(m,metricsExtremes,animationPercent,roundedPercentages!=null?roundedPercentages[i]:0);mTempModel.itemGraph=itemGraphTemplate(mTempModel);metricsHtml+=metricTemplate(mTempModel)+"\n"}var mCompModel={label:metricData.label,metricsHtml:metricsHtml,metricDivId:this.options.metricDivId},
mCompContent=componentTemplate(mCompModel);return mCompContent},computeMetricData:function(metricData,metricsExtremes,animationPercent,finalDisplayPercent){var metricWidthPercent,metricValue,displayPercent;metricWidthPercent=Math.floor(metricData.value*100/metricsExtremes.total)||0;displayPercent=Math.round(metricData.value*100/metricsExtremes.total)||0;if(finalDisplayPercent)displayPercent=metricsExtremes.total==0?0:finalDisplayPercent;metricValue=this.options.countDisplayType=="percent"?Math.round(displayPercent*
animationPercent/100)+"%":Math.round(metricData.value*animationPercent/100);return $.extend(true,{},metricData,{displayPercent:displayPercent,metricWidth:Math.max(this.options.minMetricWidthPercent,metricWidthPercent)*animationPercent/100+"%",metricValue:metricValue,extraClass:metricData.value==metricsExtremes.max?"xFormMetricItemMaxScore":""})},getMetricExtremes:function(metricData){var total=0,max=Number.MAX_VALUE*-1,min=Number.MAX_VALUE;var i,m,answers=metricData.values,len=answers.length;for(i=
0;i<len;i++){m=answers[i];total+=m.value;if(m.value>max)max=m.value;if(m.value<min)min=m.value}return{total:total,min:min,max:max}},getRoundPercentages:function(values,metricsExtremes){var p=_.map(values,function(m){return m.value*100/metricsExtremes.total||0});return this.roundPercentages(p,100)},roundPercentages:function(l,target){var off=target-_.reduce(l,function(acc,x){return acc+Math.round(x)},0);return _.chain(l).map(function(x,i){return{v:x,idx:i}}).sortBy(function(x){return Math.round(x.v)-
x.v}).map(function(x,i){return{v:Math.round(x.v)+(off>i)-(i>=l.length+off),idx:x.idx}}).sortBy(function(x){return x.idx}).pluck("v").value()}});ComponentView=Backbone.View.extend({initialize:function(options){var me=this;this.options=options;this.model=options.model;_.bindAll(this,"createCollection","addAll","addItem");this.$surveyResults=$(".xSurveyResults","#"+this.el.id);me.createCollection("items")},createCollection:function(name){var qIds=this.$surveyResults.attr("selectedSurveyQuestionIds"),
list=this[name]=new SurveyResultsList({el:this.$surveyResults}),params={id:qIds,apikey:NGX.context.apikey};this.listenTo(list,"reset",this.addAll);this.listenTo(list,"add",this.addItem);if(this.options.metricData)list.set(this.options.metricData);else list.fetch({data:params})},addAll:function(collection){_.each(collection.models,function(model){this.addItem(model)},this)},addItem:function(model){var obj={model:model,options:$.extend(true,this.options,{metricDivId:this.$surveyResults.attr("moduleId")+
"xForm"+this.$surveyResults.attr("surveyContainerRef").split(":")[1]+"xQuestion"+model.attributes.id+"Metrics",displayEmbed:this.$surveyResults.attr("displayEmbed")})};var surveyView=this.$surveyResults.append((new SurveyResultView(obj)).render().el);this.onPollRendered(surveyView[0])},onPollRendered:function(surveyView){$(surveyView).imagesLoaded(function(){NGX.App.api.resizeParent()})}});NGX.App.api.registerView("metric",ComponentView)})();
(function(){var ItemModel,ItemView,ItemList,ComponentView;ItemModel=Backbone.Model.extend();ItemView=Backbone.View.extend({initialize:function(o){this.template=o.template},render:function(){var _attr=this.model.attributes,obj=_attr.reward;obj.type=obj.itemClass;if(_attr.code)obj.code=_attr.code;if(obj.offer&&obj.offer.action)obj.target={strategy:obj.offer.strategy,object:v4.isAssetRef(obj.offer.action)?NGX.Util.assetFromRef(obj.offer.action).src:obj.offer.action,text:obj.offer.heading||obj.heading};
if(obj.offer&&obj.offer.strategy&&obj.offer.strategy=="image")obj.badgeThumb=v4.isAssetRef(obj.offer.action)?NGX.Util.assetFromRef(obj.offer.action).src:obj.offer.action;else if(obj.assets){if(obj.assets.main)obj.badgeSrc=NGX.Util.assetFromRef(obj.assets.main).src;if(obj.assets.thumbnail)obj.badgeThumb=NGX.Util.assetFromRef(obj.assets.thumbnail).src;if(obj.assets.background)obj.badgeBg=NGX.Util.assetFromRef(obj.assets.background).src}if(obj.userInfo.isEligible)obj.isEligible=true;if(_attr.redemptionStatus.id===
"status.redemption.claimed")obj.isEntitled=true;var html=this.template(obj);this.setElement($(html.trim()));return this}});ItemList=Backbone.Collection.extend({url:"/display/api/entitlement/campaign",model:ItemModel,parse:function(response){return response.content}});ComponentView=Backbone.View.extend({initialize:function(){_.bindAll(this,"createCollection","storeJson","addAll","addItem");this.$list=$(".xContainerInner","#xRewardsList_"+this.el.id);this.itemTemplate=NGX.App.api.getTemplate("itemRewardInline");
var boundFunction=function(){this.createCollection("items")}.bind(this);if("undefined"===typeof FB||NGX.App.state.currentUser.accessToken)boundFunction();else NGX.App.Events.on("fb:ready",boundFunction)},createCollection:function(name){var list=this[name]=new ItemList({el:this.$list}),params={apikey:NGX.context.apikey,guid:NGX.context.guid,campaignId:NGX.App.config.id,fbid:NGX.App.state.currentUser.fbid||"",nocache:Math.random(),cpayload:decodeURIComponent(v4.queryStringObject("cpayload"))||null};
if(NGX.context.isPreview===true)params.preview=true;this.listenTo(list,"reset",this.addAll);this.listenTo(list,"add",this.addItem);list.fetch({success:this.storeJson,data:params})},storeJson:function(collection,response){this.model.set("response",response.content)},addAll:function(collection){_.each(collection.models,function(model){this.addItem(model)},this)},addItem:function(model){var obj={model:model,template:this.itemTemplate};this.$list.append((new ItemView(obj)).render().el)}});NGX.App.api.registerView("myrewards",
ComponentView)})();
(function(root,doc,$){var publishLayoutCompleteEvent=function(msg){var message="undefined"===typeof msg?"windowLayoutComplete":msg,timeout=null,checkIsotopeComplete=function(){if(root.SOCIALHUB&&!root.SOCIALHUB.isotopeComplete()){clearTimeout(timeout);timeout=setTimeout(checkIsotopeComplete,250)}else timeout=setTimeout(layoutComplete,500)},layoutComplete=function(){clearTimeout(timeout);$.event.trigger({type:"windowLayoutComplete",message:message});if(root.SOCIALHUB)root.SOCIALHUB.reset()};checkIsotopeComplete()};
root.SOCIALHUB=root.SOCIALHUB||function(){var isotopeCounterArr=[];return{aMDLComponentCount:function(){return $(".xTemplateMasonry.xGridTarget").length},registerIsotopeCallback:function(moduleId){isotopeCounterArr.push(moduleId)},reset:function(){isotopeCounterArr.length=0},isotopeComplete:function(){return this.aMDLComponentCount()==isotopeCounterArr.length}}}();$.fn.smartresize=function(fn){return fn?this.bind("resize",_.debounce(fn,250)):this.trigger("smartresize")};$(root).smartresize(function(){publishLayoutCompleteEvent()});
$(doc).ready(function(){publishLayoutCompleteEvent("documentReady")})})(window,document,$);
$.extend($.Isotope.prototype,{_responsiveReset:function(){var responsiveOptions=this.options[this.options.layoutMode],i;this.responsive={};for(var propertyName in responsiveOptions)this.responsive[propertyName]=responsiveOptions[propertyName];this._getSegments();i=this.responsive.cols;this.responsive.colYs=[];while(i--)this.responsive.colYs.push(0)},_responsiveLayout:function($elems){var instance=this,props=instance.responsive,_pres=props.presentationFormats,_cols=props.cols,_colW=props.columnWidth,
getRoundVal=function(val){return Math.floor(Math.min(_cols,val)*_colW-2*props.margin)};$elems.each(function(){var $this=$(this),colSpan;for(var propertyName in _pres)if($this.hasClass("xDisplay"+propertyName)){var prop=_pres[propertyName];this.style.width=getRoundVal(prop.wUnits)+"px";this.style.height=getRoundVal(prop.hUnits)+"px";v4.updateClassByPrefix(this,"dynColCount",_cols);break}colSpan=Math.min(Math.ceil($this.outerWidth(true)/_colW),_cols);if(colSpan===1)instance._responsivePlaceBrick($this,
props.colYs);else{var groupCount=props.cols+1-colSpan,groupY=[],groupColY,i=0;for(;i<groupCount;i++){groupColY=props.colYs.slice(i,i+colSpan);groupY.push(Math.max.apply(Math,groupColY))}instance._responsivePlaceBrick($this,groupY)}})},_responsivePlaceBrick:function($brick,setY){var minimumY=Math.min.apply(Math,setY),shortCol=0;for(var i=0,len=setY.length;i<len;i++)if(setY[i]===minimumY){shortCol=i;break}var x=this.responsive.columnWidth*shortCol;this._pushPosition($brick,x,minimumY);var setSpan=this.responsive.cols+
1-len;for(i=0;i<setSpan;i++)this.responsive.colYs[shortCol+i]=minimumY+$brick.outerHeight(true)},_responsiveGetContainerSize:function(){return{height:Math.max.apply(Math,this.responsive.colYs)}},_responsiveResizeChanged:function(){return this._checkIfSegmentsChanged()}});
var Mosaic=function(domId){var avatarWidths=[45,46,47,48,49,50,51,52,53],minHeight=300;var requiredNumberOfNodes=function(){var dimensions=gridUnitDimension();var rows=Math.floor(nodes().length/Math.floor(containerWidth()/dimensions));var numberOfRows=Math.ceil(Math.max(minHeight,dimensions*rows)/dimensions);return unitsPerRow()*numberOfRows},containerWidth=function(){return $(".xGridPlaceholder",this.$module).innerWidth()},gridUnitDimension=function(){var gridUnitDimension,remainder=Math.max.apply(null,
avatarWidths),width=containerWidth(),len=avatarWidths.length,i=0;for(;i<len;i++){var test=width%avatarWidths[i];if(test<remainder){remainder=test;gridUnitDimension=avatarWidths[i]}}return gridUnitDimension},unitsPerRow=function(){return Math.floor(containerWidth()/gridUnitDimension())},rows=function(){return Math.floor(requiredNumberOfNodes()/Math.floor(containerWidth()/gridUnitDimension()))},moduleHeight=function(){return rows()*gridUnitDimension()},nodes=function(){return $(".xItem",$(".xGridPlaceholder",
"#"+domId))},randomiseArray=function(inputArr){var i=inputArr.length,j,tempi,tempj;if(i==0)return false;while(--i){j=Math.floor(Math.random()*(i+1));tempi=inputArr[i];tempj=inputArr[j];inputArr[i]=tempj;inputArr[j]=tempi}return inputArr},processNodesToDisplay=function($el){var reqNodes=requiredNumberOfNodes(),arr=[];while(arr.length<reqNodes){var newArr=nodes().clone().get().slice(0);arr=arr.concat(newArr)}while(arr.length>reqNodes)var domObj=arr.pop();$el.find(".xContainerInner").append($(randomiseArray(arr)))};
this.$module=$("#"+domId);this.$placeholder=$(".xGridPlaceholder",this.$module);this.$avatarGridCell=this.$module.parents(".xCell");this.init=function(){this.$avatarGridCell.css({opacity:0,backgroundColor:"transparent"});this.$placeholder.css({height:0,overflow:"hidden"});var $grid=$(".xGridTarget",this.$module),dimensionPx=gridUnitDimension();processNodesToDisplay($grid);$(".xMediaAvatar",this.$module).css({width:dimensionPx,height:dimensionPx});$grid.css("visibility","visible");this.$avatarGridCell.animate({opacity:1},
1E3);this.tooltips=new MosaicTip(domId);this.tooltips.addTooltips()};this.reset=function(){this.$module.find(".xGridTarget .xContainerInner").html("");this.init()};this.containerWidth=containerWidth;this.gridUnitDimension=gridUnitDimension};
var MosaicTip=function(domId){var _id=domId,_ttip,_timer,autoTriggerFlag="autoTriggerFlag";var mosaic=function(){return $(".xGridTarget .xContainerInner","#"+_id)},wrapper=function(){return mosaic().closest(".xCellInner")},avatars=function(){return mosaic().find("img.xMediaAvatar")},avatarFirst=function(){var list=mosaic()[0].getElementsByTagName("IMG"),len=list.length,i=0;for(;i<len;i++)if($(list[i]).hasClass("xMediaAvatar"))return $(list[i]);return avatars().first()},visibleAvatarLength=function(actualLen){var $wrap=
wrapper(),$first=avatarFirst();return Math.min(Math.floor($wrap.height()/$first.height()/$first.height())*($wrap.width()/$first.width()),actualLen)};var showTooltip=function(e){var updateTooltip=function(el){if("function"===typeof el.getAttribute&&_ttip.qtip("api"))if(el.getAttribute("data-ngxsourcename")){_ttip.trigger("show");_ttip.qtip("api").set({"position.target":el,"style.classes":"qtip-bootstrap "+el.getAttribute("data-ngxnetwork"),"content.title":el.getAttribute("data-ngxsourcename")||"",
"content.text":el.getAttribute("data-ngxtitle")||""})}},getRandomAvatar=function(){var _avID=Math.floor(Math.random()*visibleAvatarLength(avatars().length));return avatars().eq(_avID)};if("undefined"!==typeof e&&e.currentTarget){updateTooltip(e.currentTarget);return true}else if(mosaic().data(autoTriggerFlag)===true){updateTooltip(getRandomAvatar());triggerTimer();return true}return false};var resetTimer=function(){clearTimeout(_timer)},triggerTimer=function(){resetTimer();_timer=setTimeout(showTooltip,
7500)},preventAuto=function(){resetTimer();mosaic().data(autoTriggerFlag,false)},initialiseTimer=function(){mosaic().data(autoTriggerFlag,true);triggerTimer()};var addTooltips=function(){var $initial;if("undefined"===typeof _ttip){$initial=avatarFirst();_ttip=mosaic().qtip({content:{title:"",text:""},position:{target:$initial,effect:false,my:"top center",at:"bottom center",viewport:mosaic()},show:{ready:true,delay:0,event:"show"},hide:{event:"hide"},style:{classes:"qtip-bootstrap "+$initial.attr("data-ngxnetwork")}})}else showTooltip();
wrapper().on("mouseenter",preventAuto).on("mouseleave",initialiseTimer);avatars().on("mouseenter",showTooltip)};this.init=initialiseTimer;this.addTooltips=addTooltips};
Handlebars.registerHelper("compare",function(lvalue,rvalue,options){if(arguments.length<3)throw new Error("Handlebars Helper 'compare' needs 2 parameters");var operator=options.hash.operator||"==",operators={"==":function(l,r){return l==r},"===":function(l,r){return l===r},"!=":function(l,r){return l!=r},"!==":function(l,r){return l!==r},"<":function(l,r){return l<r},">":function(l,r){return l>r},"<=":function(l,r){return l<=r},">=":function(l,r){return l>=r},"typeof":function(l,r){return typeof l==
r},"&&":function(l,r){return l&&r},"||":function(l,r){return l||r},"contains":function(l,r){var l=l!==null&&typeof l!=="undefined"?l:"";return l.indexOf(r)>-1}};if(!operators[operator])throw new Error("Handlebars Helper 'compare' doesn't know the operator "+operator);if(operators[operator](lvalue,rvalue))return options.fn(this);else return options.inverse(this)});
Handlebars.registerHelper("anyAttribute",function(){var args=Array.prototype.slice.call(arguments);var options=args.pop();for(var i=0,n=args.length;i<n;i++)if(args[i])return options.fn(this);return options.inverse(this)});
Handlebars.registerHelper("youtubeEmbedURL",function(assetOrPath,itemOpts,opts){var _assetPath=assetOrPath;if(v4.isAssetRef(assetOrPath))_assetPath=NGX.Util.assetFromRef(assetOrPath)["path"];var _id=NGX.video.getYoutubeVideoId(_assetPath);return"//www.youtube.com/embed/"+_id+"?"+itemOpts.customProperties});Handlebars.registerHelper("debugModel",function(obj){console.log(obj)});
Handlebars.registerHelper("isSecureRequest",function(options){if(document.location.protocol==="https:")return options.fn(this);else return options.inverse(this)});Handlebars.registerHelper("assetPathFromRef",function(assetRef,options){if(arguments.length<2)throw new Error("HandlebarsHelper 'assetPathFromRef' expects an assetRef!");var assetObj=NGX.Util.assetFromRef(assetRef);return assetObj.src});
Handlebars.registerHelper("assetAttributeFromRef",function(assetRef,attribute,options){if(arguments.length<3)throw new Error("HandlebarsHelper 'assetAttributeFromRef' expects an assetRef!");var assetObj=NGX.Util.assetFromRef(assetRef);return assetObj[attribute]});
Handlebars.registerHelper("vineEmbedId",function(assetRef,options){var assetObj=NGX.Util.assetFromRef(assetRef);var startIndex=assetObj.path.lastIndexOf("/v/")+3,embedIDStart=assetObj.path.substring(startIndex);if(embedIDStart.indexOf("/")>-1)embedIDStart=embedIDStart.substring(0,embedIDStart.indexOf("/"));return embedIDStart});Handlebars.registerHelper("isURL",function(theString,options){if(theString.indexOf("http://")===0||theString.indexOf("https://")===0)return options.fn(this);else return options.inverse(this)});
Handlebars.registerHelper("shareAssetRef",function(defaultImage,assets,options){if(assets.main){var assetObj=NGX.Util.assetFromRef(assets.main);if(assetObj.assetType==="video"&&assets.thumbnail)return assets.thumbnail;else return assets.main}else if(assets.thumbnail)return assets.thumbnail;else return v4.tokenize(defaultImage,assets)});
Handlebars.registerHelper("shareLink",function(defaultLink,item,options){if(item.externalServiceRef!=="external.service.ugc")return item.link;else{var applyRoute=["ngx.me","engagesciences.com:8443/link/","engageplatform.com/link/"],method="ext";_.each(applyRoute,function(domain){if(defaultLink.indexOf(domain)>-1){method="route";defaultLink=defaultLink+"/${id}"}});if(method!=="route"){method="qs";defaultLink=v4.updateQueryString({ngxItemID:"${id}"},true,defaultLink)}return v4.tokenize(defaultLink,
item)}});Handlebars.registerHelper("linkType",function(item,options){return item.network=="ugc"?"internal":"external"});Handlebars.registerHelper("isVimeo",function(item,options){if(item.link&&item.link.indexOf("vimeo.com")>-1||item.network==="vimeo")return options.fn(this);else return options.inverse(this)});
Handlebars.registerHelper("capitalize",function(word,options){if(arguments.length<2)throw new Error("HandlebarsHelper 'capitalize' expects a word!");if(!word||typeof word=="object")return false;else return word.charAt(0).toUpperCase()+word.slice(1)});
Handlebars.registerHelper("formatUserName",function(firstName,lastName,transFn,options){if(!firstName&&!lastName)throw new Error("HandlebarsHelper 'formatUserName' expects a user name!");if(!firstName&&!lastName||(typeof firstName=="object"||typeof lastName=="object"))return false;else{if(transFn&&typeof transFn==="string"&&(Handlebars.helpers[transFn]&&typeof Handlebars.helpers[transFn]==="function"))_.each([firstName,lastName],function(u){u=Handlebars.helpers[transFn](u,options)});var repStr=NGX.lang.user.nameFormat.toLowerCase();
repStr=repStr.replace(new RegExp("{{firstname}}","gm"),firstName);repStr=repStr.replace(new RegExp("{{lastname}}","gm"),lastName)}return repStr});Handlebars.registerHelper("stripSpaces",function(words,options){if(arguments.length<2)throw new Error("HandlebarsHelper 'stripSpaces' expects some words!");if(!words||typeof words=="object")return false;else return words.replace(/\s/g,"")});
Handlebars.registerHelper("protocolFree",function(url,options){if(arguments.length<2)throw new Error("HandlebarsHelper 'removeProtocol' expects a URL!");if(!url||typeof url=="object")return false;else return"//"+url.replace(/.*?:\/\//g,"")});Handlebars.registerHelper("viralAction",function(context,options){if(!context)return false;else if(context.action=="share")return"share:"+context.context+":"+context.network;else if(context.action=="invite")return"invite"});
Handlebars.registerHelper("tokenizeMe",function(haystack,needles){if(arguments.length<2)return haystack;return v4.tokenize(haystack,needles).replace(/(<([^>]+)>)/ig,"")});Handlebars.registerHelper("messageBundle",function(messageKey,messageDefault){var _theMessage;if(!messageKey&&!messageDefault){console.error("No message key or default passed");return""}if(NGX.lang&&messageKey)_theMessage=NGX.lang.get(messageKey);return _theMessage||messageDefault});
var popOverlayForDisplayItem=function(itemId,component){NGX.App.api.messageParent({action:"getScrollPosition"});var theItem=null,theType="social",theTemplate,targetState,firstCmp=null,firstTarget;var findFirstComponent=function(compTypes){v4.debug("Searching components for "+compTypes,5);var _components=[];_.each(NGX.App.Components.models,function(cmp){if(_.contains(compTypes,cmp.get("type")))_components.push(cmp)});return _components[0]||false};$.getJSON("/display/api/content/displayItem/"+itemId+
".json").success(function(response){if(response.count==1){v4.debug("The item ID brought back a valid display item",5);theItem=response.content[0];theType=theItem.network=="ugc"?"gallery":"social";theTemplate="overlayMediacard"}else v4.debug("The item ID did not bring back a valid display item, maybe it's unpublished?",5)}).done(function(){if(theType==="gallery"){v4.debug("The item is UGC; if the component wasn't passed, let's find a gallery",5);firstCmp=component||findFirstComponent(["entries"]);
theItem.voteButtonText=NGX.lang.button&&NGX.lang.button.prevote?NGX.lang.button.prevote:"Vote";theItem.entryVotes=theItem.score||"0"}else v4.debug("The item is social, let's find a social component",5);if(!firstCmp)firstCmp=component||findFirstComponent(["socialcontentwall","socialcontentmosaic","socialcontentcarousel"]);if(firstCmp){var tOpts=firstCmp.get("templateOpts");theTemplate=tOpts&&tOpts["details"]=="content"?"overlayContentcard":"overlayMediacard";firstTarget=$(firstCmp.get("targ")).parents(".xSection");
targetState=!component?firstTarget.attr("data-statename"):null;theItem.itemOpts=firstCmp.get("itemOpts")}if(targetState&&_.findWhere(flowJSON.states,{name:targetState})){v4.debug("Attempting to route to state:"+targetState,5);v4.action("route:"+targetState)}if(theItem)NGX.overlay.create({template:NGX.App.api.getTemplate(theTemplate),content:theItem,callback:function(){Insights.track("view:contentitem",{i:itemId})}})})};
var initOverlayHandler=function(e){e.preventDefault();e.stopPropagation();var $item=$(this),$asset=$item.find(".xActionOverlay"),$component=$item.parents(".xComponent"),theComponent=NGX.App.Components.get($component.attr("id")),content=null,contentSource=$item.data("ngxOverlaysource");switch(contentSource){case "json":content=window[$component.attr("id")][$item.data("ngxOverlaycontent")];content["itemOpts"]=theComponent.get("itemOpts");if($asset.data("ngxSourceid")){content["extId"]=$asset.data("ngxSourceid");
content["network"]=$asset.data("ngxService")}NGX.overlay.create({template:NGX.App.api.getTemplate("overlayMediacard"),content:content,event:e.originalEvent});break;case "ajax":popOverlayForDisplayItem($item.data("ngxId"),theComponent);break;case "external":break;default:NGX.overlay.create({content:$item.html(),event:e.originalEvent});break}},initExternalLinkHandler=function(e){e.preventDefault();var externalLink=this.getAttribute("data-ngx-sourcelink"),linkTarget=this.getAttribute("data-ngx-sourcetarget");
Insights.track("click:contentitem",{i:this.getAttribute("data-ngx-id"),link:externalLink});if(linkTarget=="_blank")window.open(externalLink);else document.location=externalLink},initCTALinkHandler=function(e){e.preventDefault();e.stopPropagation();var $parentEl=$(this).parents(".hasCTA"),externalLink=$parentEl.attr("data-ngx-ctalink"),linkTarget=$parentEl.attr("data-ngx-ctatarget");linkAction=$(this).attr("data-ngx-action");NGX.App.api.action(linkAction,{link:externalLink,ctatarget:linkTarget})},
initNetworkActionHandler=function(e){e.preventDefault();e.stopPropagation();$this=$(this);if(theAction=$this.attr("data-ngx-action"))v4.action(theAction)};
$(".xComponent").on("click",".xContainer .xTriggerOverlay",initOverlayHandler).on("click",".xContainer .xTriggerExternal",initExternalLinkHandler).on("click",".xCTACopyContainer .xCTA",initCTALinkHandler).on("click",".xActionNetwork a",initNetworkActionHandler).on("click",".xShareModal",function(e){e.stopPropagation();e.preventDefault();var $item=$(this).parents(".xItem"),cmp=NGX.App.Components.get($(this).parents(".xComponent").attr("id")),itemObj=null;$.getJSON("/display/api/content/displayItem/"+
$item.data("ngxId")+".json").success(function(response){if(response.count==1)itemObj=_.extend({},response.content[0],{itemOpts:cmp.get("itemOpts"),title:"Share"})}).done(function(){if(itemObj)NGX.overlay.create({template:NGX.App.api.getTemplate("shareModal"),content:itemObj,event:e.originalEvent,type:"shareModal"})})});
$(".xComponent.xSocialContentWall").on("click",".xActionShowMore",function(e){var $btn=$(this),$btnInner=$("span",$btn),$cmp=$(e.currentTarget).parents(".xComponent"),cmp=NGX.App.Components.get($cmp.attr("id")),$cInner=$(".xContainerInner",$cmp),btnText=$btnInner.text();$cInner.css({minHeight:$cInner.outerHeight(true)});var moduleOpts=cmp.get("moduleOpts"),templateOpts=cmp.get("templateOpts");var pageSize=cmp.get("pageSize"),offset=cmp.get("offset");$btnInner.text(NGX.lang.get("loading"));var _contentParams=
{apikey:NGX.context.apikey,cID:NGX.App.config.id||0,moduleDomID:cmp.get("moduleDomID"),pageSize:pageSize,offset:offset,moduleOpts:JSON.stringify(moduleOpts),templateOpts:JSON.stringify(templateOpts)};$.ajax({url:"/display/content/contentItems",data:_contentParams}).success(function(response){if(offset+pageSize>=cmp.get("total"))$btn.addClass("xHidden");$cInner.append(response);$cInner.imagesLoaded(function(){$cInner.css({minHeight:""});if(typeof $cInner.data("packery")!=="undefined")$cInner.packery("reloadItems").packery("layout");
setTimeout(function(){NGX.App.api.resizeParent()},1E3);$btnInner.text(btnText)})});cmp.set("offset",offset+pageSize)});
NGX.App.Events.on("page:ready",function(){var theID=v4.queryStringObject("ngxItemID")||null,promoID=v4.queryStringObject("ngxPromoID")||null,appData;if(promoID)v4.action("display:promo:"+promoID);else{NGX.App.api.messageParent({action:"getpageinfo"},function(payload){if(!theID&&payload.hasOwnProperty("url")){theID=v4.queryStringObject("ngxItemID",payload.url);if(!isNaN(theID))popOverlayForDisplayItem(theID)}});if(!theID&&NGX.context.appData){appData=JSON.parse(NGX.context.appData);if(!isNaN(appData.ngxItemID))theID=
appData.ngxItemID}if(theID){v4.debug("There's an item ID in the QS, attempting to load it",5);popOverlayForDisplayItem(theID)}}});_.extend(Handlebars.partials,{sharingButtons:NGX.App.api.getTemplate("sharingButtons"),sharingIcons:NGX.App.api.getTemplate("sharingIcons"),actionsNetwork:NGX.App.api.getTemplate("networkActions"),actionsPlatform:NGX.App.api.getTemplate("platformActions"),actionsProfile:NGX.App.api.getTemplate("profileActions"),objectVideo:NGX.App.api.getTemplate("objectVideo")});
var NGX=NGX||{};
NGX.Embed=function(w,d){var _actions={setfieldvalues:function(target,msg){var flds=msg.payload;_.each(flds,function(val,fld){if(val&&fld){var $fld=$("#"+fld);if($fld.hasClass("selectized"))$fld[0].selectize.setValue(val);else $fld.val(val)}})},navigate:function(target,msg){var _pld=msg.payload||null,stateName;if(_pld&&"undefined"!==typeof _pld.page){stateName=isNaN(_pld.page)?_pld.page:flowJSON.states[parseInt(_pld.page)].name;NGX.App.api.action("route:"+stateName)}},showitem:function(target,msg){var _pld=
msg.payload||null,_type=_pld.type||"item";v4.action("display:"+_type+":"+_pld.itemId)},returnpageinfo:function(target,msg){NGX.App.state.pageInfo=msg.payload||{}},triggerevent:function(target,msg){NGX.App.Events.trigger(msg.payload.event)}},enableListeners=function(){if(w.addEventListener){w.addEventListener("message",receiveMessage,false);w.addEventListener("resize",_.debounce(NGX.App.api.resizeParent,250),false)}else{w.attachEvent("onmessage",receiveMessage);w.attachEvent("onresize",_.debounce(NGX.App.api.resizeParent,
250))}},disableListeners=function(){if(w.removeEventListener){w.addEventListener("message",receiveMessage,false);w.addEventListener("resize",_.debounce(NGX.App.api.resizeParent,250),false)}else{w.detachEvent("onmessage",receiveMessage);w.detachEvent("onresize",_.debounce(NGX.App.api.resizeParent,250))}};function isValidMessage(msg){if(msg.data.indexOf("_NGX_")===0)return true;return false}function receiveMessage(e){try{v4.debug("Message Recieved: "+e.data,3);if(isValidMessage(e)){var msgObj=JSON.parse(e.data.substring(5)),
result=messageAction(msgObj);if(msgObj&&msgObj.hasOwnProperty("callbackId")){var cbID=msgObj.callbackId;v4.debug("Check for callback: "+cbID,6);if(NGX.App.state.callbackQueue.hasOwnProperty(cbID)&&"function"===typeof NGX.App.state.callbackQueue[cbID]){v4.debug("We have a callback, invoke it and remove it",6);NGX.App.state.callbackQueue[cbID].call(this,msgObj.payload);delete NGX.App.state.callbackQueue[cbID]}}else if(result)e.source.postMessage(result,"*")}}catch(e){}}function messageAction(msg){var getIframeFromMessage=
function(msg){var _msgId=msg.id,_compoundId,_compoundIdParts,_guidId,_intId;if(!_msgId)return false;_compoundId=_msgId.substring(8);_compoundIdParts=_compoundId.split(":");_guidId=_compoundIdParts[0];_intId=_compoundIdParts[1];if(guidFrame=d.getElementById("ngxFrame"+_guidId))return guidFrame;else if(intFrame=d.getElementById("ngxFrame"+_intId))return intFrame;return false};var theFrame=getIframeFromMessage(msg),result;if(_actions.hasOwnProperty(msg.action.toLowerCase()))return _actions[msg.action.toLowerCase()].call(this,
theFrame,msg)}function init(){NGX.Embed.listen()}return{init:init,listen:enableListeners,ignore:disableListeners,actions:_actions,sendMessage:NGX.App.api.messageParent}}(window,document);NGX.Embed.init();
NGX.contests=function(w,d,$,_,undefined){var getDataAttr=function(el,attr){var dataAttr="data-"+attr;return el&&el.nodeType===1&&el.hasAttribute(dataAttr)?el.getAttribute(dataAttr):undefined},voteClickHandler=function(e,eID){this.model=this.model||new ContestEntry({id:eID});var _self=this,cntx=NGX.context,conf=NGX.App.config,user=NGX.App.state.currentUser.userSession,$el=(e?$(e.currentTarget):$(".xActionVote .xButton span",'[data-ngx-id="'+eID+'"]')).addClass("processing clicked"),entryId=eID||$el.parents(".xItem").attr("data-ngx-id"),
auth=user?user.authResponse:{},obj={entryId:entryId,campaignId:conf.id,apikey:cntx.apikey,fbid:auth?auth.userID:"",url:conf.displayVoteURLsecure+entryId+".json"},isVoting=this.model.get("parentType")==="voting",isSafari=function(ua){return/safari/.test(ua)&&!/chrome/.test(ua)}(navigator.userAgent.toLowerCase()),voteSuccess=function(response){var voteNum=_self.model.get("entryVotes")||0,$details,$overlay;if(!voteNum)voteNum=response.currentVotes||1;else++voteNum;if(voteNum){$overlay=$(".xDetailContainer");
_self.model.set({"entryVotes":voteNum,"voteButtonText":NGX.lang.button&&NGX.lang.button.postvote?NGX.lang.button.postvote:"Voted"});if($overlay){$details=$(".xVoteCount",'[data-ngx-id="'+entryId+'"]');if($details)$details.html(voteNum);$el.addClass("voted").html(NGX.lang.button&&NGX.lang.button.postvote?NGX.lang.button.postvote:"Voted")}}if(isVoting){$(".xActionVote").addClass("xDisabled");$(".voteButtonWrapper").removeClass("xHidden");$(".xActionAnotherSet>span").text(NGX.lang.button&&NGX.lang.button.voteagain?
NGX.lang.button.voteagain:"Voted. Show More?")}if(_.isObject(obj.afterVote))NGX.overlay.create(obj.afterVote)},voteFail=function(response){var msg=response.message||"Unknown error occurred",txt=NGX.lang.button&&NGX.lang.button.notvoted?NGX.lang.button.notvoted:"Vote not counted";NGX.overlay.create({type:"modal",content:msg});$el.addClass("error").children("span").html(txt)},voteSubmit=function(){var xhr=NGX.Util.createCORSRequest("POST",obj.url+"?"+$.param({entryId:obj.entryId,cID:obj.campaignId,
apikey:obj.apikey,uid:NGX.Util.getRefCookie({c_name:"ngx"}),fbid:auth?auth.userID:"",oauth_token:auth?auth.accessToken:""}));if(xhr){xhr.onload=function(){var json=$.parseJSON(xhr.responseText);if(!!json.voted===true)voteSuccess(json);else voteFail(json);$el.removeClass("processing").off("click")};xhr.onerror=function(){voteFail({message:"A network error occurred",error:true});$el.removeClass("processing")};xhr.send()}},voteStrategy=function(){switch(conf.votingStrategy){case "strategy.voting.cta":obj.afterVote=
{url:"/display/page/votecta/?"+$.param({id:conf.id,pageId:cntx.fb.page.id,appId:cntx.fb.app.id,apikey:cntx.apikey,preview:cntx.isPreview})};break;case "strategy.voting.posttowall":var cs=conf.sharing;NGX.Virality.facebookShare({trackURL:cs.trackURL,name:cs.name,picture:cs.picture,caption:cs.caption,description:cs.description,link:cs.link,actionLink:cs.actionLink,actionText:cs.actionText});break}voteSubmit()};if($el.hasClass("xDisabled"))return false;if(conf.votingStrategy==="strategy.voting.posttowall"||
conf.votingPermsRequired===true)NGX.Util.fbLogin(function(response){if(response.authResponse&&response.status==="connected")user=NGX.App.state.currentUser.userSession,auth=user?user.authResponse:{},voteStrategy();else voteFail({message:NGX.lang.exception.voteperms||"Please authorise the app in order to vote",error:true})},{timing:""});else voteStrategy()},ContestEntry=Backbone.Model.extend(),ContestEntryView=Backbone.View.extend({initialize:function(options){var _self=this;_.bindAll(this,"showDetails");
this.template=NGX.App.api.getTemplate(options.template||this.options.template);this.details=NGX.App.api.getTemplate(options.details||this.options.details);this.vote=NGX.App.api.getTemplate(options.vote||this.options.vote);this.model.set("voteButtonText",options.voteButtonText);this.model.set("parentType",options.parentType);this.model.set("itemOpts",options.itemOpts);this.listenTo(this.model,"change",this.render);if(typeof this.template==="function"){var html=this.template(this.model.attributes);
this.setElement($(html.trim()))}if(this.model.get("parentType")=="entries")this.$el.on("click",".xMediaContainer",this.showDetails);this.$el.on("click",".xActionVote span",function(e){e.preventDefault();e.stopPropagation();voteClickHandler.call(_self,e)})},render:function(){var _self=this;if(typeof this.template==="function"){var html=this.template(this.model.attributes);this.$el.html($(html.trim()).html())}return this},showDetails:function(evt){var _self=this;NGX.overlay.create({content:this.model.attributes,
template:this.details,event:evt.originalEvent,callback:function(){Insights.track("view:contentitem",{i:_self.model.get("id")});this.$inner.on("click",".xActionVote span",function(e){e.preventDefault();e.stopPropagation();voteClickHandler.call(_self,e)})}})}}),ContestEntryList=Backbone.Collection.extend({model:ContestEntry,initialize:function(opts){this.$el=opts.$el},parse:function(response){var entries=response.content;if(entries&&entries.constructor===Array){this.addEntries(entries);var $showMore=
this.$el.find(".xActionShowMoreContainer");if(response.page==response.pagecount)$showMore.addClass("xHidden");else $showMore.removeClass("xHidden")}},addEntries:function(content){v4.debug("collection:before:render",2);NGX.App.Events.trigger("collection:before:render");_.each(content,function(entry){if(entry){v4.debug("collection:model:render",2);NGX.App.Events.trigger("collection:model:render");var assetRefMain=NGX.Util.assetFromRef(entry.assets.main),assetRefThumb=NGX.Util.assetFromRef(entry.assets.thumbnail);
entry.thumbnail=assetRefThumb.src;entry.entryId=entry.id;entry.entryVotes=entry.score?entry.score:0;entry.entryDate=function(date){var y=date.getFullYear(),m=date.getMonth()+1,d=date.getDate();return m+"-"+d+"-"+y}(new Date(entry.dateCreated));entry[assetRefMain.assetType]=assetRefMain.src;if(entry.contentType=="video"&&assetRefMain.type==="youtube"){var regExp=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;var match=entry.video.match(regExp);if(match)entry.extId=match[2].substr(0,
11)}else if(entry.image&&assetRefMain.size){entry.imgHeight=assetRefMain.size.height;entry.imgWidth=assetRefMain.size.width}if(typeof entry.extendedProperties==="string")entry.extendedProperties=$.parseJSON(entry.extendedProperties);this.add(entry)}},this);v4.debug("collection:rendered",2);this.trigger("collection:rendered")}}),ContestSort=Backbone.Model.extend({initialize:function(){this.set("base","/display/api/content/entryDisplayItems.json")},getURL:function(){var opts=this.attributes,url=this.get("base"),
i=0,add=function(val){url+=(i>0?"&":"?")+val;i++};add("cID="+NGX.App.config.id);add("apikey="+NGX.context.apikey);if(NGX.context.isStage)add("stageMode="+NGX.context.isStage);if(typeof opts==="object"){if(opts.cat)add(opts.cat==="random"?"random=true":"sort="+opts.cat);if(opts.order==="asc")add("ascending=true");if(opts.max)add("max="+opts.max);if(opts.offset)add("offset="+opts.offset);if(opts.filter1)add("filter1="+opts.filter1);if(opts.filter2)add("filter2="+opts.filter2);if(opts.filter3)add("filter3="+
opts.filter3)}if(NGX.context.isPreview===true)add("preview=true");add("cache="+(new Date).getTime());return url}}),ContestView=Backbone.View.extend({initialize:function(){var _self=this;var container=this.$(".xContainer")[0],max=parseInt(getDataAttr(container,"ngx-initialmax"),10);_.bindAll(this,"addItem","getEntries","sortClick","moreClick","submitItemViews","filterEntries");this.sort=new ContestSort({"cat":getDataAttr(container,"ngx-initialsort"),"order":getDataAttr(container,"ngx-initialorder"),
"size":max,"max":max});this.entries=new ContestEntryList({$el:_self.$el});this.$wrapper=$(".xContainerInner","#xContestEntriesWrapper_"+this.el.id);this.listenTo(this.entries,"add",this.addItem);this.listenTo(this.sort,"change",this.getEntries);this.listenTo(this.entries,"collection:rendered",this.afterRender);this.$el.on("click",".xActionSort",this.sortClick).on("click",".xActionShowMore",this.moreClick).on("change",".filterEntries",this.filterEntries).on("click",".xActionAnotherSet",function(_self){return function scoped(list,
result){_self.getEntries(true,function(){_self.submitItemViews()})}}(this));this.getEntries(true,function(_self){return function scoped(list,response){if(_self.model.get("type")==="voting")_self.submitItemViews();_self.model.set("response",response,{trigger:false})}}(this))},afterRender:function(){var _self=this,_packeryEl=$(".xContainerInner",_self.$el),$containerInner=$(".xContainerInner",_self.$el);$containerInner.css({minHeight:""});if(typeof _packeryEl.data("packery")!=="undefined")this.$el.imagesLoaded(function(){$containerInner.packery("reloadItems").packery("layout")})},
addItem:function(item){var id=this.el.id,out={model:item,parentType:this.model.get("type"),template:this.model.get("template")||"xContestEntry",details:this.model.get("details")||"xContestEntryDetails",vote:"xContestEntryVote_"+id,voteButtonText:NGX.lang.button&&NGX.lang.button.prevote?NGX.lang.button.prevote:"Vote",itemOpts:this.model.get("itemOpts")};this.$wrapper.append((new ContestEntryView(out)).render().el)},sortClick:function(e){var targ=e.currentTarget,targInner=targ.getElementsByTagName("a")[0],
order,catog,replace,$containerInner=$(".xContainerInner",this.$el);$containerInner.css({minHeight:$containerInner.outerHeight(true)});if(targInner){order=getDataAttr(targInner,"sortorder");catog=getDataAttr(targInner,"sortby");this.sort.set({"cat":catog,"order":order,"rnd":catog==="random"?(new Date).getTime():this.sort.get("rnd")});if(order){replace=order==="asc"?"desc":"asc";this.$(".xActionSort .active").removeClass("active");$(targ).removeClass(order).addClass(replace+" active");targInner.setAttribute("data-sortorder",
replace)}}},moreClick:function(e){var $containerInner=$(".xContainerInner",this.$el);$containerInner.css({minHeight:$containerInner.outerHeight(true)});this.sort.set({"max":this.sort.get("max")+this.sort.get("size")})},filterEntries:function(e){var $filter=$(e.currentTarget),filterData={};filterData[$filter.attr("id")]=$filter.val();this.sort.set(filterData)},submitItemViews:function(){var getContentIds,xhr,xhrDone;getContentIds=function(modelList){var contentIds=[];_.each(modelList,function(model){contentIds.push(model.attributes.id)},
this);return contentIds.join(",")}(this.entries.models);xhr=NGX.Util.createCORSRequest("POST","/display/form/updateContentViews.json?"+$.param({cID:NGX.App.config.id,apikey:NGX.context.apikey,contentIds:getContentIds}));xhr.send();$(".xShowAnotherSet>span ").text(NGX.lang.button&&NGX.lang.button.votenewset?NGX.lang.button.votenewset:"Show more")},getEntries:function(forceReset,successFn){var _self=this;this.entries.url=this.sort.getURL();this.$wrapper.html("");this.entries.fetch({reset:forceReset?
forceReset:false,success:function(coll,response){typeof successFn==="function"?successFn():false}})}});NGX.App.api.registerView("entries",ContestView);NGX.App.api.registerView("voting",ContestView);return{doVote:voteClickHandler}}(window,document,$,_);
NGX.StorageManager=function(w,d){var _localStorage={supported:function(){try{return typeof localStorage!=="undefined"}catch(exc){return false}},getData:function(key){if(this.supported())return localStorage.getItem(key)?localStorage.getItem(key):false},setData:function(key,value){if(this.supported())localStorage.setItem(key,value)},pushData:function(key,value){if(!this.supported())return false;var _existing=JSON.parse(this.getData(key)),_values=_existing?_existing:[];_values.push(""+value);this.setData(key,
JSON.stringify(_values))},popData:function(key,value){if(!this.supported())return false;var _values=[],_existing=this.getData(key);if(_existing){_.each(_existing.split(","),function(el){if(""+el!==""+value)_values.push(""+el)});this.setData(key,_values)}},clearData:function(key){if(this.supported())localStorage.removeItem(key)}},_cookieStorage={setData:function(key,value){var _key=key.replace(/\./g,"_"),_d=new Date,_expires;_d.setTime(_d.getTime()+360*24*60*60*1E3);_expires="expires="+_d.toGMTString();
document.cookie=key+"="+value+"; "+_expires},getData:function(key){var _key=key.replace(/\./g,"_"),_cName=key+"=",_cookies=document.cookie.split(";");for(var i=0;i<_cookies.length;i++){var c=_cookies[i];while(c.charAt(0)===" ")c=c.substring(1);if(c.indexOf(_cName)!==-1)return c.substring(_cName.length,c.length)}return""},clearData:function(key){var _key=key.replace(/\./g,"_"),_expires="expires=Thu, 01 Jan 1970 00:00:01 GMT";document.cookie=_key+"=; "+_expires}},getStorageKey=function(components){return components.join("_")},
_setData=function(key,value,where){var _where=where||"both";var _useLocal=_where=="local"||_where=="both",_useCookie=_where=="cookie"||_where=="both";if(_useLocal)_localStorage.setData(key,value);if(_useCookie)_cookieStorage.setData(key,value)},_pushData=function(key,value,where){var _where=where||"both";var _useLocal=_where=="local"||_where=="both";_useCookie=false;if(_useLocal)_localStorage.pushData(key,value);if(_useCookie)_cookieStorage.pushData(key,value)},_popData=function(key,value,where){var _where=
where||"both";var _useLocal=_where=="local"||_where=="both";_useCookie=false;if(_useLocal)_localStorage.popData(key,value);if(_useCookie)_cookieStorage.popData(key,value)},_getData=function(key){var _theData=_localStorage.getData(key);if(!_theData)_theData=_cookieStorage.getData(key);return _theData},_clearData=function(key){if("undefined"!==typeof key){_localStorage.clearData(key);_cookieStorage.clearData(key);return true}};return{"get":_getData,"set":_setData,"push":_pushData,"pop":_popData,"clear":_clearData,
"getKey":getStorageKey}}(window,document);